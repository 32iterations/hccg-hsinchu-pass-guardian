
> hccg-hsinchu-pass-guardian@2.0.0 test
> jest --coverage --coverage --verbose

[0mGET /api/v1/rbac/roles [33m401[0m 2.485 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.461 ms - 77[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.276 ms - 70[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.666 ms - 74[0m
[0mGET /api/v1/test/user-info [32m200[0m 8.764 ms - 106[0m
[0mGET /api/v1/rbac/roles [32m200[0m 0.767 ms - -[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.698 ms - 125[0m
[0mGET /api/v1/cases/other-user-case [33m404[0m 14.445 ms - 64[0m
[0mGET /api/v1/cases/search [32m200[0m 1.424 ms - -[0m
[0mPOST /api/v1/cases/create [33m400[0m 2.309 ms - 380[0m
[0mPOST /api/v1/cases/create [33m400[0m 1.912 ms - 465[0m
[0mGET /api/v1/cases/search?page=invalid&limit=-1 [33m400[0m 15.501 ms - 198[0m
[0mPOST /api/v1/cases/create [32m201[0m 2.935 ms - 513[0m
[0mGET /api/v1/nonexistent [33m404[0m 30.182 ms - 115[0m
[0mGET /api/v1/test/error [31m500[0m 11.229 ms - 141[0m
[0mGET /api/v1/test/database-error [31m500[0m 10.057 ms - 141[0m
[0mGET /api/v1/test/error [31m500[0m 7.272 ms - 141[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.374 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.415 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.326 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.286 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.306 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.258 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.403 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.309 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.305 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.333 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.354 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.358 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.369 ms - 74[0m
FAIL backend src/backend/tests/integration/middleware.test.js (6.235 s)
  API Middleware
    Authentication Middleware
      âœ“ should reject requests without authorization header (196 ms)
      âœ“ should reject requests with invalid JWT token (19 ms)
      âœ“ should reject requests with expired JWT token (29 ms)
      âœ“ should accept requests with valid JWT token (12 ms)
      âœ“ should extract user information from JWT token (28 ms)
    RBAC Permission Middleware
      âœ“ should allow access with sufficient permissions (49 ms)
      âœ“ should deny access without sufficient permissions (5 ms)
      âœ• should check resource-specific permissions (19 ms)
      âœ“ should handle role hierarchy correctly (28 ms)
    Request Validation Middleware
      âœ“ should validate required fields in POST requests (49 ms)
      âœ“ should validate field types and formats (19 ms)
      âœ“ should validate query parameters (21 ms)
      âœ“ should sanitize input data (9 ms)
    Error Handling Middleware
      âœ“ should handle 404 errors for non-existent endpoints (61 ms)
      âœ“ should handle internal server errors gracefully (20 ms)
      âœ“ should not expose sensitive error details in production (15 ms)
      âœ“ should log errors with appropriate context (33 ms)
    Rate Limiting Middleware
      âœ“ should allow requests within rate limit (31 ms)
      âœ“ should reject requests exceeding rate limit (229 ms)
      âœ“ should include rate limit headers (3 ms)
    CORS Middleware
      âœ“ should include CORS headers for valid origins (50 ms)
      âœ“ should handle preflight OPTIONS requests (4 ms)
      âœ“ should reject requests from unauthorized origins (3 ms)
    Security Headers Middleware
      âœ“ should include security headers in all responses (5 ms)
      âœ“ should set appropriate content security policy (44 ms)

  â— API Middleware â€º RBAC Permission Middleware â€º should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/mydata/authorize?userId=oauth-test-user&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=oauth2-csrf-token-123 [32m200[0m 84.355 ms - 510[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 1.294 ms - 322[0m
[0mPOST /api/v1/cases/create [32m201[0m 69.422 ms - 616[0m
[0mPOST /api/v1/cases/create [33m400[0m 2.974 ms - 380[0m
PASS validation tests/validation/p2-volunteer-ble-validation.test.js
  P2 å¿—å·¥BLE Production Validation
    Android 12+ Permission Management with neverForLocation
      âœ“ should request ONLY BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (2 ms)
      âœ“ should configure BLE scanning without location inference (3 ms)
      âœ“ should handle manifest declaration validation for neverForLocation (1 ms)
      âœ“ should create anonymized volunteer hits without any location data (23 ms)
      âœ“ should validate Android 12+ runtime permission flow (1 ms)
    iOS State Preservation/Restoration Validation
      âœ“ should initialize with proper Core Bluetooth configuration (13 ms)
      âœ“ should save complete state when app backgrounded (8 ms)
      âœ“ should restore state correctly when app relaunched (1 ms)
      âœ“ should handle iOS background app refresh settings (1 ms)
      âœ“ should validate iOS State Preservation across app lifecycle (1 ms)
    VolunteerHit Anonymization with NO PII Exposure
      âœ“ should ensure absolute PII protection in volunteer hits (27 ms)
      âœ“ should implement salted hashing for device identification (1 ms)
      âœ“ should enforce K-anonymity before submitting volunteer hits (1 ms)
      âœ“ should validate complete anonymization pipeline (2 ms)
    BLE Background Scanning Capabilities
      âœ“ should maintain background scanning under battery optimization (1 ms)
      âœ“ should handle BLE state changes gracefully (33 ms)
      âœ“ should implement adaptive scanning based on discovery rate (1 ms)
      âœ“ should validate production BLE integration with backend (1 ms)
    Production Error Handling and Recovery
      âœ“ should handle permission revocation gracefully (1 ms)
      âœ“ should recover from temporary BLE failures (18 ms)

[0mPOST /api/v1/cases/create [33m400[0m 27.981 ms - 228[0m
[0mPOST /api/v1/cases/create [33m401[0m 0.427 ms - 85[0m
[0mGET /api/v1/cases/case123 [33m404[0m 12.202 ms - 64[0m
[0mGET /api/v1/cases/nonexistent [33m404[0m 0.839 ms - 64[0m
[0mGET /api/v1/cases/case123 [33m404[0m 0.741 ms - 64[0m
FAIL validation tests/validation/p3-mydata-validation.test.js (7.427 s)
  P3 MyData Production Validation
    Contract Tests for Callback Schema Validation
      âœ“ should validate MyData Taiwan authorization callback schema (39 ms)
      âœ“ should reject malformed callback schemas (15 ms)
      âœ“ should validate OAuth2 PKCE extension for mobile apps (9 ms)
      âœ“ should handle real-time callback validation with Taiwan MyData API (1 ms)
    TTL (Time To Live) Functionality
      âœ“ should enforce TTL on MyData access tokens (8 ms)
      âœ“ should automatically expire and clean up TTL data (1203 ms)
      âœ“ should handle TTL extension for active consents (1 ms)
      âœ“ should enforce maximum TTL limits per data type (3 ms)
    Data Deletion on Revocation (æ’¤å›å³åˆª)
      âœ“ should immediately delete all user data upon revocation (13 ms)
      âœ“ should handle cross-service data deletion coordination (4 ms)
      âœ“ should maintain deletion audit trail while removing personal data (31 ms)
      âœ“ should handle partial deletion failures gracefully (6 ms)
    OAuth2 Flow Compliance
      âœ• should implement complete OAuth2 authorization code flow (206 ms)
      âœ“ should handle OAuth2 error scenarios correctly (4 ms)
      âœ“ should implement secure token refresh mechanism (1 ms)
      âœ“ should validate Taiwan MyData API integration compliance (1 ms)

  â— P3 MyData Production Validation â€º OAuth2 Flow Compliance â€º should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

[0mPUT /api/v1/cases/case123/status [33m404[0m 1.125 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m400[0m 0.701 ms - 77[0m
[0mPUT /api/v1/cases/case123/status [33m403[0m 0.526 ms - 96[0m
[0mGET /api/v1/cases/search?status=active&priority=high&location=%E6%96%B0%E7%AB%B9%E5%B8%82&radius=5000 [32m200[0m 1.469 ms - 816[0m
[0mGET /api/v1/cases/search?lat=24.8138&lng=120.9675&radius=10000 [32m200[0m 0.967 ms - -[0m
[0mGET /api/v1/cases/search?page=2&limit=20 [32m200[0m 0.859 ms - -[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 1.284 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.914 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.813 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m403[0m 0.452 ms - 90[0m
FAIL frontend src/backend/tests/integration/api.cases.test.js (5.967 s)
  Case Flow API Endpoints
    POST /api/v1/cases/create
      âœ• should create a new case successfully (312 ms)
      âœ“ should validate required fields (74 ms)
      âœ“ should validate location coordinates (46 ms)
      âœ“ should require authentication (16 ms)
    GET /api/v1/cases/:id
      âœ• should return case details for authorized user (58 ms)
      âœ“ should return 404 for non-existent case (21 ms)
      âœ• should enforce access control based on case ownership (21 ms)
    PUT /api/v1/cases/:id/status
      âœ• should update case status successfully (6 ms)
      âœ“ should validate status transitions (40 ms)
      âœ“ should require appropriate permissions for status updates (49 ms)
    GET /api/v1/cases/search
      âœ• should search cases with filters (51 ms)
      âœ“ should support geographic search (26 ms)
      âœ“ should support pagination (20 ms)
    POST /api/v1/cases/:id/assign
      âœ• should assign case to volunteer successfully (6 ms)
      âœ“ should validate assignee exists and is eligible (16 ms)
      âœ• should check volunteer availability (6 ms)
      âœ“ should require case management permissions (21 ms)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/create â€º should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "é™³å°è¯",
            "phone": "0912345678",
            "relationship": "å¥³å…’",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:08.324Z",
    +     "createdBy": "admin123",
          "description": "78æ­²é™³è€å…ˆç”Ÿåœ¨å¤§æ½¤ç™¼èµ°å¤±",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-910",
    +     "location": Object {
            "address": "æ–°ç«¹å¸‚æ±å€å…‰å¾©è·¯äºŒæ®µ101è™Ÿ",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "èº«é«˜ç´„165cmï¼Œç©¿æ·±è‰²è¡£æœ",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "é™³è€å…ˆç”Ÿ",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:08.324Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º PUT /api/v1/cases/:id/status â€º should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/search â€º should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:07.823Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:07.823Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "æ–°ç«¹å¸‚æ±å€â—‹â—‹è·¯123è™Ÿ",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "é˜¿èŒ²æµ·é»˜ç—‡ç¬¬äºŒæœŸ",
    +         "patientName": "ç‹â—‹â—‹",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    +       "workflow": Object {
    +         "currentStage": "å»ºç«‹",
    +         "nextStages": Array [
    +           "æ´¾é£",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "å»ºç«‹",
    +             "timestamp": "2025-09-18T07:25:07.823Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 13.142 ms - 706[0m
[0mGET /api/v1/cases/CASE-2025-002 [32m200[0m 2.174 ms - 542[0m
[0mPOST /api/v1/cases/export [33m403[0m 3.922 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 20.916 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 2.832 ms - 155[0m
[0mPOST /api/v1/cases [32m201[0m 35.296 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-030/assign [32m200[0m 2.673 ms - 1004[0m
[0mPOST /api/v1/cases [32m201[0m 1.924 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-515/close [33m400[0m 39.298 ms - 193[0m
[0mGET /api/v1/rbac/roles [33m401[0m 3.973 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.325 ms - 77[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.334 ms - 70[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 24.798 ms - 814[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.847 ms - 74[0m
[0mGET /api/v1/cases/CASE-2025-001/history [32m200[0m 3.362 ms - 326[0m
[0mGET /api/v1/test/user-info [32m200[0m 21.714 ms - 106[0m
[0mGET /api/v1/rbac/roles [32m200[0m 0.776 ms - -[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.766 ms - 125[0m
[0mGET /api/v1/cases/other-user-case [33m404[0m 0.651 ms - 64[0m
[0mPOST /api/v1/cases/search [33m404[0m 98.391 ms - 116[0m
[0mGET /api/v1/cases/search [32m200[0m 0.766 ms - -[0m
[0mPOST /api/v1/cases/export [32m200[0m 3.013 ms - 313[0m
[0mPOST /api/v1/cases/create [33m400[0m 23.975 ms - 380[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 12.735 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 1.919 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 2.176 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 8.498 ms - 814[0m
[0mPOST /api/v1/cases/create [33m400[0m 9.844 ms - 465[0m
[0mGET /api/v1/kpi/dashboard?period=30_days&department=all&includeBreakdowns=false [33m403[0m 6.948 ms - 94[0m
[0mGET /api/v1/cases/search?page=invalid&limit=-1 [33m400[0m 29.920 ms - 198[0m
[0mGET /api/v1/kpi/detailed?includeIndividualCases=true&showPersonalData=true&drillDown=case_level [32m200[0m 2.079 ms - 250[0m
[0mPOST /api/v1/cases/create [32m201[0m 1.247 ms - 513[0m
[0mGET /api/v1/kpi/role-specific [32m200[0m 2.293 ms - -[0m
[0mGET /api/v1/kpi/temporal?period=90_days&granularity=weekly&anonymized=true [33m403[0m 1.846 ms - 96[0m
[0mGET /api/v1/nonexistent [33m404[0m 37.028 ms - 115[0m
[0mGET /api/v1/test/error [31m500[0m 3.373 ms - 141[0m
[0mGET /api/v1/test/database-error [31m500[0m 1.618 ms - 141[0m
[0mGET /api/v1/test/error [31m500[0m 1.959 ms - 141[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.358 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.346 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.423 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.531 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.527 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.394 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.558 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 14.357 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.396 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.411 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.395 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.367 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.450 ms - 74[0m
FAIL validation tests/validation/p4-console-rbac-validation.test.js
  P4 æ‰¿è¾¦Console Production Validation
    RBAC Restrictions - Non-æ‰¿è¾¦ Access Control
      âœ• should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data (83 ms)
      âœ• should provide filtered data based on user clearance level (45 ms)
      âœ• should enforce field-level access control (38 ms)
      âœ“ should prevent data export by unauthorized users (139 ms)
    Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation
      âœ• should enforce complete case creation workflow (75 ms)
      âœ“ should prevent workflow stage skipping (66 ms)
      âœ• should enforce role-based workflow permissions (76 ms)
      âœ• should validate workflow state transitions (8 ms)
    Audit Trails with Watermarks
      âœ• should create watermarked audit entries for all read operations (227 ms)
      âœ• should create enhanced audit trails for export operations (39 ms)
      âœ• should maintain audit chain integrity (57 ms)
    KPI Aggregation without Drill-down
      âœ• should provide aggregated KPI data without detailed breakdowns (31 ms)
      âœ• should prevent access to individual case data through KPI endpoints (20 ms)
      âœ• should provide role-appropriate KPI views (47 ms)
      âœ• should anonymize and aggregate temporal KPI data (58 ms)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:09.981Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "æ–°ç«¹å¸‚åŒ—å€",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[â—‹Ã—]+$/,
    +     "medicalHistory": "è¼•åº¦èªçŸ¥éšœç¤™",
    +     "patientName": "â—‹â—‹â—‹",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "å¿—å·¥å”åŠ©æ¡ˆä»¶",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "å»ºç«‹",
    +     "nextStages": Array [
    +       "æ´¾é£",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "æ´¾é£",
    + Object {
    +   "currentStage": "å»ºç«‹",
        "nextStages": Array [
    -     "åŸ·è¡Œä¸­",
    -     "çµæ¡ˆ",
    +     "æ´¾é£",
        ],
    -   "previousStage": "å»ºç«‹",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "æ´¾é£",
    -       "timestamp": Any<String>,
    +       "stage": "å»ºç«‹",
    +       "timestamp": "2025-09-18T07:25:10.730Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: 'æ´¾é£',
      451 |         previousStage: 'å»ºç«‹',
      452 |         nextStages: ['åŸ·è¡Œä¸­', 'çµæ¡ˆ'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "æ³•é™¢è¦æ±‚æä¾›è­‰æ“šè³‡æ–™",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:11.205Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_F634C32BDCAB53C236B4CD2D6E6878EA_5BB680A5",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.æ‰¿è¾¦äººå“¡.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL frontend src/backend/tests/integration/middleware.test.js
  API Middleware
    Authentication Middleware
      âœ“ should reject requests without authorization header (70 ms)
      âœ“ should reject requests with invalid JWT token (28 ms)
      âœ“ should reject requests with expired JWT token (24 ms)
      âœ“ should accept requests with valid JWT token (25 ms)
      âœ“ should extract user information from JWT token (73 ms)
    RBAC Permission Middleware
      âœ“ should allow access with sufficient permissions (20 ms)
      âœ“ should deny access without sufficient permissions (14 ms)
      âœ• should check resource-specific permissions (8 ms)
      âœ“ should handle role hierarchy correctly (44 ms)
    Request Validation Middleware
      âœ“ should validate required fields in POST requests (50 ms)
      âœ“ should validate field types and formats (46 ms)
      âœ“ should validate query parameters (34 ms)
      âœ“ should sanitize input data (62 ms)
    Error Handling Middleware
      âœ“ should handle 404 errors for non-existent endpoints (68 ms)
      âœ“ should handle internal server errors gracefully (44 ms)
      âœ“ should not expose sensitive error details in production (6 ms)
      âœ“ should log errors with appropriate context (55 ms)
    Rate Limiting Middleware
      âœ“ should allow requests within rate limit (158 ms)
      âœ“ should reject requests exceeding rate limit (629 ms)
      âœ“ should include rate limit headers (17 ms)
    CORS Middleware
      âœ“ should include CORS headers for valid origins (3 ms)
      âœ“ should handle preflight OPTIONS requests (17 ms)
      âœ“ should reject requests from unauthorized origins (3 ms)
    Security Headers Middleware
      âœ“ should include security headers in all responses (16 ms)
      âœ“ should set appropriate content security policy (3 ms)

  â— API Middleware â€º RBAC Permission Middleware â€º should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/kpi/dashboard [32m200[0m 0.753 ms - 892[0m
[0mGET /api/v1/kpi/dashboard?startDate=2023-01-01&endDate=2023-12-31 [32m200[0m 0.457 ms - 892[0m
[0mGET /api/v1/kpi/dashboard [33m403[0m 0.375 ms - 94[0m
[0mGET /api/v1/kpi/dashboard?useCache=true [32m200[0m 0.425 ms - 892[0m
[0mGET /api/v1/kpi/metrics/cases [32m200[0m 1.079 ms - 624[0m
[0mGET /api/v1/kpi/metrics/volunteers [32m200[0m 1.766 ms - 664[0m
[0mGET /api/v1/kpi/metrics/system [32m200[0m 0.484 ms - 582[0m
[0mGET /api/v1/kpi/metrics/compliance [32m200[0m 1.801 ms - 518[0m
[0mGET /api/v1/kpi/metrics/invalid-type [33m400[0m 0.402 ms - 131[0m
[0mGET /api/v1/kpi/metrics/cases?startDate=2023-01-01&endDate=2023-01-31&granularity=daily [32m200[0m 0.456 ms - 623[0m
[0mGET /api/v1/kpi/metrics/cases?aggregation=weekly&region=%E6%96%B0%E7%AB%B9%E5%B8%82%E6%9D%B1%E5%8D%80 [32m200[0m 0.442 ms - 622[0m
[0mGET /api/v1/kpi/reports/compliance [32m200[0m 3.015 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?format=pdf [32m200[0m 2.760 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?period=monthly&year=2023&month=10 [32m200[0m 2.688 ms - 994[0m
[0mGET /api/v1/kpi/reports/compliance?includeRegulatory=true [32m200[0m 1.440 ms - -[0m
[0mGET /api/v1/kpi/reports/compliance [33m403[0m 2.659 ms - 99[0m
[0mGET /api/v1/kpi/alerts [32m200[0m 3.043 ms - 745[0m
[0mGET /api/v1/kpi/alerts?severity=critical [32m200[0m 14.030 ms - 100[0m
[0mGET /api/v1/kpi/alerts?type=performance [32m200[0m 0.523 ms - 318[0m
[0mPOST /api/v1/kpi/reports/generate [32m202[0m 0.760 ms - 173[0m
[0mGET /api/v1/mydata/authorize?userId=oauth-test-user&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=oauth2-csrf-token-123 [32m200[0m 41.193 ms - 510[0m
[0mPOST /api/v1/kpi/reports/generate [33m400[0m 19.631 ms - 92[0m
[0mPOST /api/v1/kpi/reports/generate [33m403[0m 0.354 ms - 98[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 2.956 ms - 322[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 8.218 ms - 706[0m
[0mGET /api/v1/cases/CASE-2025-002 [32m200[0m 4.259 ms - 542[0m
[0mPOST /api/v1/cases/export [33m403[0m 8.936 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 13.423 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 19.817 ms - 155[0m
[0mPOST /api/v1/cases [32m201[0m 15.271 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-556/assign [32m200[0m 20.493 ms - 1004[0m
[0mPOST /api/v1/cases [32m201[0m 4.114 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-586/close [33m400[0m 14.457 ms - 193[0m
PASS backend src/backend/tests/integration/api.kpi.test.js
  KPI API Endpoints
    GET /api/v1/kpi/dashboard
      âœ“ should return comprehensive dashboard metrics (26 ms)
      âœ“ should support time range filtering (21 ms)
      âœ“ should require admin permissions (4 ms)
      âœ“ should return cached data when available (3 ms)
    GET /api/v1/kpi/metrics/:type
      âœ“ should return case management metrics (46 ms)
      âœ“ should return volunteer performance metrics (7 ms)
      âœ“ should return system performance metrics (13 ms)
      âœ“ should return compliance metrics (37 ms)
      âœ“ should validate metric type parameter (7 ms)
      âœ“ should support custom date ranges (6 ms)
      âœ“ should support different aggregation levels (20 ms)
    GET /api/v1/kpi/reports/compliance
      âœ“ should generate comprehensive compliance report (20 ms)
      âœ“ should support different report formats (13 ms)
      âœ“ should generate monthly compliance reports (15 ms)
      âœ“ should include regulatory compliance details (18 ms)
      âœ“ should require appropriate permissions for compliance reports (11 ms)
    GET /api/v1/kpi/alerts
      âœ“ should return active system alerts (30 ms)
      âœ“ should filter alerts by severity (38 ms)
      âœ“ should filter alerts by type (20 ms)
    POST /api/v1/kpi/reports/generate
      âœ“ should generate custom reports (19 ms)
      âœ“ should validate report parameters (34 ms)
      âœ“ should require admin permissions for report generation (42 ms)

[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 5.302 ms - 814[0m
FAIL frontend tests/validation/p3-mydata-validation.test.js
  P3 MyData Production Validation
    Contract Tests for Callback Schema Validation
      âœ“ should validate MyData Taiwan authorization callback schema (2 ms)
      âœ“ should reject malformed callback schemas (2 ms)
      âœ“ should validate OAuth2 PKCE extension for mobile apps
      âœ“ should handle real-time callback validation with Taiwan MyData API (9 ms)
    TTL (Time To Live) Functionality
      âœ“ should enforce TTL on MyData access tokens (1 ms)
      âœ“ should automatically expire and clean up TTL data (1201 ms)
      âœ“ should handle TTL extension for active consents (1 ms)
      âœ“ should enforce maximum TTL limits per data type (3 ms)
    Data Deletion on Revocation (æ’¤å›å³åˆª)
      âœ“ should immediately delete all user data upon revocation (1 ms)
      âœ“ should handle cross-service data deletion coordination (2 ms)
      âœ“ should maintain deletion audit trail while removing personal data (2 ms)
      âœ“ should handle partial deletion failures gracefully (9 ms)
    OAuth2 Flow Compliance
      âœ• should implement complete OAuth2 authorization code flow (154 ms)
      âœ“ should handle OAuth2 error scenarios correctly (9 ms)
      âœ“ should implement secure token refresh mechanism (5 ms)
      âœ“ should validate Taiwan MyData API integration compliance (2 ms)

  â— P3 MyData Production Validation â€º OAuth2 Flow Compliance â€º should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

[0mGET /api/v1/cases/CASE-2025-001/history [32m200[0m 30.897 ms - 326[0m
[0mPOST /api/v1/cases/search [33m404[0m 104.149 ms - 116[0m
[0mPOST /api/v1/cases/export [32m200[0m 29.625 ms - 313[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 41.755 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 1.943 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 7.351 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 3.621 ms - 814[0m
[0mGET /api/v1/kpi/dashboard?period=30_days&department=all&includeBreakdowns=false [33m403[0m 1.750 ms - 94[0m
[0mGET /api/v1/kpi/detailed?includeIndividualCases=true&showPersonalData=true&drillDown=case_level [32m200[0m 1.945 ms - 250[0m
[0mGET /api/v1/kpi/role-specific [32m200[0m 22.191 ms - -[0m
[0mGET /api/v1/kpi/temporal?period=90_days&granularity=weekly&anonymized=true [33m403[0m 31.042 ms - 96[0m
FAIL frontend src/mobile/tests/services/BLEBackgroundService.test.js
  BLEBackgroundService - GREEN Phase Tests
    Android 12+ Permission Management
      neverForLocation Mode
        âœ“ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (4 ms)
        âœ“ should scan for devices without location inference (3 ms)
        âœ• should create anonymized volunteer hits without location data (11 ms)
      Location-Based Mode for Positioning
        âœ“ should request location permissions when positioning enabled (47 ms)
        âœ• should include fuzzed location in volunteer hits (16 ms)
        âœ“ should fuzz coordinates to 100m grid squares (1 ms)
        âœ“ should round timestamps to 5-minute intervals (1 ms)
    iOS Core Bluetooth Integration
      State Preservation and Restoration
        âœ“ should initialize with bluetooth-central background mode (2 ms)
        âœ“ should save state when app is backgrounded (1 ms)
        âœ• should restore state when app is relaunched (1 ms)
        âœ“ should handle iOS background app refresh settings (1 ms)
    Background Scanning Optimization
      Battery-Aware Scanning
        âœ• should adjust scan intervals based on battery level (2 ms)
        âœ• should use aggressive scanning when charging (1 ms)
        âœ• should implement adaptive scanning based on discovery rate (1 ms)
      RSSI Filtering and Device Processing
        âœ“ should process devices with RSSI stronger than -90 dBm (1 ms)
        âœ“ should ignore devices weaker than -90 dBm
        âœ• should handle MAC address rotation without correlation (1 ms)
    Privacy and Anonymization
      K-Anonymity Enforcement
        âœ• should ensure minimum k=3 anonymity before submitting hits (1 ms)
        âœ• should queue hits when k-anonymity threshold not met (1 ms)
      PII Protection
        âœ“ should never store original MAC addresses (2 ms)
        âœ“ should use salted hashes for device identification (1 ms)
    Backend Integration
      Volunteer Hit Submission
        âœ“ should submit anonymized hits to backend API (5 ms)
        âœ• should handle API failures gracefully with retry logic (1 ms)
        âœ• should queue hits offline and sync when connected (1 ms)
    Error Handling and Recovery
      Permission Revocation
        âœ• should stop scanning when permissions are revoked (1 ms)
        âœ“ should preserve queued data when permissions lost
      Bluetooth State Changes
        âœ• should handle Bluetooth disabled gracefully (10 ms)
        âœ“ should resume scanning when Bluetooth re-enabled (1 ms)
    Integration with Device Binding
      Care Recipient Device Detection
        âœ“ should prioritize scanning for registered care recipient devices (3 ms)
        âœ“ should trigger immediate alerts for priority device detection (21 ms)

  â— BLEBackgroundService - GREEN Phase Tests â€º Android 12+ Permission Management â€º neverForLocation Mode â€º should create anonymized volunteer hits without location data

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      117 |         expect(result.gridSquare).toBeNull();
      118 |         expect(result.anonymousVolunteerId).toMatch(/^[a-f0-9-]{36}$/);
    > 119 |         expect(result.locationDataIncluded).toBe(false);
          |                                             ^
      120 |       });
      121 |     });
      122 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:119:45)

  â— BLEBackgroundService - GREEN Phase Tests â€º Android 12+ Permission Management â€º Location-Based Mode for Positioning â€º should include fuzzed location in volunteer hits

    expect(received).toEqual(expected) // deep equality

    - Expected  - 5
    + Received  + 5

    - ObjectContaining {
    -   "anonymousVolunteerId": Any<String>,
    -   "deviceHash": Any<String>,
    -   "gridSquare": "24.8068,120.9687",
    + Object {
    +   "anonymousVolunteerId": "550e8400-e29b-41d4-a716-01995bb69243",
    +   "deviceHash": "24f697a624f697a624f697a624f697a624f697a624f697a624f697a624f697a6",
    +   "gridSquare": null,
        "rssi": -70,
    -   "timestamp": StringMatching /^\d{4}-\d{2}-\d{2}T\d{2}:(00|05|10|15|20|25|30|35|40|45|50|55):00\.000Z$/,
    +   "timestamp": "2025-09-18T07:25:00.000Z",
      }

      166 |
      167 |         // Assert
    > 168 |         expect(result).toEqual(expect.objectContaining({
          |                        ^
      169 |           deviceHash: expect.any(String),
      170 |           rssi: -70,
      171 |           gridSquare: '24.8068,120.9687', // Fuzzed to 100m grid

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:168:24)

  â— BLEBackgroundService - GREEN Phase Tests â€º iOS Core Bluetooth Integration â€º State Preservation and Restoration â€º should restore state when app is relaunched

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      265 |
      266 |         // Assert
    > 267 |         expect(result.success).toBe(true);
          |                                ^
      268 |         expect(result.restored).toBe(true);
      269 |         expect(bleService.isScanning()).toBe(true);
      270 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:267:32)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should adjust scan intervals based on battery level

    expect(received).toBe(expected) // Object.is equality

    Expected: "conservative"
    Received: "aggressive"

      297 |         // Assert - When battery is low (25%)
      298 |         expect(result.success).toBe(true);
    > 299 |         expect(result.powerMode).toBe('conservative');
          |                                  ^
      300 |         expect(result.batteryLevel).toBe(0.25);
      301 |         expect(result.charging).toBe(false);
      302 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:299:34)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should use aggressive scanning when charging

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.8
    Received: undefined

      313 |         expect(result.success).toBe(true);
      314 |         expect(result.powerMode).toBe('aggressive');
    > 315 |         expect(result.batteryLevel).toBe(0.80);
          |                                     ^
      316 |         expect(result.charging).toBe(true);
      317 |       });
      318 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:315:37)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should implement adaptive scanning based on discovery rate

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      329 |
      330 |         // Assert - For low discovery areas
    > 331 |         expect(result.success).toBe(true);
          |                                ^
      332 |         expect(result.strategy).toBe('minimal');
      333 |         expect(bleService.getScanParameters().scanIntervalMs).toBeGreaterThan(50000); // Very long intervals for minimal
      334 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:331:32)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º RSSI Filtering and Device Processing â€º should handle MAC address rotation without correlation

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      380 |
      381 |         // Assert - Each MAC treated as separate device
    > 382 |         expect(bleService.getProcessedDeviceCount()).toBe(3);
          |                                                      ^
      383 |         // No correlation maps should exist for privacy
      384 |         expect(bleService.getMacCorrelationMap).toBeUndefined();
      385 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:382:54)

  â— BLEBackgroundService - GREEN Phase Tests â€º Privacy and Anonymization â€º K-Anonymity Enforcement â€º should ensure minimum k=3 anonymity before submitting hits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      401 |
      402 |         // Assert
    > 403 |         expect(validationResult.isAnonymous).toBe(true);
          |                                              ^
      404 |         expect(validationResult.k).toBe(3);
      405 |         expect(validationResult.canSubmit).toBe(true);
      406 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:403:46)

  â— BLEBackgroundService - GREEN Phase Tests â€º Privacy and Anonymization â€º K-Anonymity Enforcement â€º should queue hits when k-anonymity threshold not met

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 1

      418 |         // Assert
      419 |         expect(validationResult.isAnonymous).toBe(false);
    > 420 |         expect(validationResult.k).toBe(2);
          |                                    ^
      421 |         expect(validationResult.canSubmit).toBe(false);
      422 |       });
      423 |     });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:420:36)

  â— BLEBackgroundService - GREEN Phase Tests â€º Backend Integration â€º Volunteer Hit Submission â€º should handle API failures gracefully with retry logic

    Network error

      510 |           callCount++;
      511 |           if (callCount <= 2) {
    > 512 |             throw new Error('Network error');
          |                   ^
      513 |           }
      514 |           return { success: true, submittedCount: 1 };
      515 |         });

      at BLEBackgroundService.<anonymous> (src/mobile/tests/services/BLEBackgroundService.test.js:512:19)
      at Object.submitVolunteerHits (src/mobile/tests/services/BLEBackgroundService.test.js:518:33)

  â— BLEBackgroundService - GREEN Phase Tests â€º Backend Integration â€º Volunteer Hit Submission â€º should queue hits offline and sync when connected

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      548 |         // Assert
      549 |         expect(syncResult.success).toBe(true);
    > 550 |         expect(syncResult.synced).toBe(2);
          |                                   ^
      551 |       });
      552 |     });
      553 |   });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:550:35)

  â— BLEBackgroundService - GREEN Phase Tests â€º Error Handling and Recovery â€º Permission Revocation â€º should stop scanning when permissions are revoked

    TypeError: bleService.isScanning is not a function

      567 |         // Assert
      568 |         expect(result.success).toBe(true);
    > 569 |         expect(bleService.isScanning()).toBe(false);
          |                           ^
      570 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
      571 |           error: 'permissions_revoked',
      572 |           userActionRequired: true

      at Object.isScanning (src/mobile/tests/services/BLEBackgroundService.test.js:569:27)

  â— BLEBackgroundService - GREEN Phase Tests â€º Error Handling and Recovery â€º Bluetooth State Changes â€º should handle Bluetooth disabled gracefully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 2

    - ObjectContaining {
    -   "bluetoothState": "PoweredOff",
    -   "canRetry": true,
    + Object {
    +   "error": null,
        "isScanning": false,
    -   "userGuidance": "è«‹é–‹å•Ÿè—ç‰™ä»¥ç¹¼çºŒæƒæ",
      }

      604 |         expect(result.canScan).toBe(false);
      605 |         expect(result.userGuidanceRequired).toBe(true);
    > 606 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
          |                                        ^
      607 |           isScanning: false,
      608 |           bluetoothState: 'PoweredOff',
      609 |           userGuidance: 'è«‹é–‹å•Ÿè—ç‰™ä»¥ç¹¼çºŒæƒæ',

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:606:40)

FAIL frontend tests/validation/p4-console-rbac-validation.test.js
  P4 æ‰¿è¾¦Console Production Validation
    RBAC Restrictions - Non-æ‰¿è¾¦ Access Control
      âœ• should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data (45 ms)
      âœ• should provide filtered data based on user clearance level (21 ms)
      âœ• should enforce field-level access control (12 ms)
      âœ“ should prevent data export by unauthorized users (131 ms)
    Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation
      âœ• should enforce complete case creation workflow (81 ms)
      âœ“ should prevent workflow stage skipping (83 ms)
      âœ• should enforce role-based workflow permissions (54 ms)
      âœ• should validate workflow state transitions (7 ms)
    Audit Trails with Watermarks
      âœ• should create watermarked audit entries for all read operations (289 ms)
      âœ• should create enhanced audit trails for export operations (107 ms)
      âœ• should maintain audit chain integrity (194 ms)
    KPI Aggregation without Drill-down
      âœ• should provide aggregated KPI data without detailed breakdowns (39 ms)
      âœ• should prevent access to individual case data through KPI endpoints (48 ms)
      âœ• should provide role-appropriate KPI views (48 ms)
      âœ• should anonymize and aggregate temporal KPI data (47 ms)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:14.019Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "æ–°ç«¹å¸‚åŒ—å€",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[â—‹Ã—]+$/,
    +     "medicalHistory": "è¼•åº¦èªçŸ¥éšœç¤™",
    +     "patientName": "â—‹â—‹â—‹",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "å¿—å·¥å”åŠ©æ¡ˆä»¶",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "å»ºç«‹",
    +     "nextStages": Array [
    +       "æ´¾é£",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "æ´¾é£",
    + Object {
    +   "currentStage": "å»ºç«‹",
        "nextStages": Array [
    -     "åŸ·è¡Œä¸­",
    -     "çµæ¡ˆ",
    +     "æ´¾é£",
        ],
    -   "previousStage": "å»ºç«‹",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "æ´¾é£",
    -       "timestamp": Any<String>,
    +       "stage": "å»ºç«‹",
    +       "timestamp": "2025-09-18T07:25:14.504Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: 'æ´¾é£',
      451 |         previousStage: 'å»ºç«‹',
      452 |         nextStages: ['åŸ·è¡Œä¸­', 'çµæ¡ˆ'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "æ³•é™¢è¦æ±‚æä¾›è­‰æ“šè³‡æ–™",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:15.095Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_ED39F3987BA4CED639A3BA1A72371603_5BB68FD7",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.æ‰¿è¾¦äººå“¡.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

[0mPOST /api/v1/cases/create [32m201[0m 9.506 ms - 616[0m
[0mPOST /api/v1/cases/create [33m400[0m 7.135 ms - 380[0m
[0mPOST /api/v1/cases/create [33m400[0m 8.239 ms - 228[0m
[0mPOST /api/v1/cases/create [33m401[0m 0.347 ms - 85[0m
[0mGET /api/v1/cases/case123 [33m404[0m 2.041 ms - 64[0m
[0mGET /api/v1/cases/nonexistent [33m404[0m 4.481 ms - 64[0m
[0mGET /api/v1/cases/case123 [33m404[0m 3.835 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m404[0m 4.335 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m400[0m 0.403 ms - 77[0m
[0mPUT /api/v1/cases/case123/status [33m403[0m 0.367 ms - 96[0m
[0mGET /api/v1/cases/search?status=active&priority=high&location=%E6%96%B0%E7%AB%B9%E5%B8%82&radius=5000 [32m200[0m 7.891 ms - 816[0m
[0mGET /api/v1/cases/search?lat=24.8138&lng=120.9675&radius=10000 [32m200[0m 5.156 ms - -[0m
[0mGET /api/v1/cases/search?page=2&limit=20 [32m200[0m 0.649 ms - -[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.618 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.868 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.525 ms - 84[0m
FAIL frontend src/mobile/tests/services/MyDataIntegrationService.test.js
  MyDataIntegrationService - GREEN Phase Tests
    OAuth Authorization Flow
      Single-Use Authorization
        âœ“ should initiate OAuth flow with correct parameters (15 ms)
        âœ“ should generate secure random state parameter (1 ms)
        âœ“ should validate state parameter on callback (2 ms)
        âœ“ should reject callback with invalid state (154 ms)
      Token Exchange
        âœ“ should exchange authorization code for access token (7 ms)
        âœ• should handle token exchange errors (1 ms)
        âœ• should store access token securely and temporarily (1 ms)
    Data Access and Processing
      Profile Data Retrieval
        âœ“ should fetch user profile with minimal data principle (92 ms)
        âœ“ should encrypt sensitive data before local storage (4 ms)
        âœ“ should implement data minimization principles (1 ms)
    Consent Management
      Consent Recording
        âœ“ should generate detailed consent receipt (1 ms)
        âœ• should provide user-readable consent summary (3 ms)
        âœ“ should validate consent before data processing (1 ms)
      Consent Revocation
        âœ“ should support immediate consent revocation (1 ms)
        âœ• should delete all associated data on consent revocation (1 ms)
        âœ“ should provide revocation confirmation to user (1 ms)
    Data Retention and Deletion
      Automatic Data Expiration
        âœ“ should automatically delete data after retention period (20 ms)
        âœ“ should clean up expired tokens regularly (11 ms)
      Receipt Management
        âœ“ should retain consent receipts for 7 days after data deletion (1 ms)
        âœ“ should generate GDPR-compliant deletion certificates (1 ms)
    Security and Privacy
      Token Security
        âœ• should implement secure token storage with biometric protection (1 ms)
        âœ“ should implement token refresh without user interaction (1 ms)
      Data Encryption
        âœ• should encrypt all stored personal data (1 ms)
        âœ“ should use different encryption keys per user (5 ms)
    Error Handling and Edge Cases
      OAuth Flow Errors
        âœ• should handle network failures during OAuth (1 ms)
        âœ“ should handle cancelled OAuth flow (1 ms)
      Data Processing Errors
        âœ• should handle API rate limiting gracefully
        âœ“ should handle partial data responses (1 ms)

  â— MyDataIntegrationService - GREEN Phase Tests â€º OAuth Authorization Flow â€º Token Exchange â€º should handle token exchange errors

    Token exchange failed

      160 |             userMessage: 'æˆæ¬Šé©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æˆæ¬Š'
      161 |           };
    > 162 |           throw new Error('Token exchange failed');
          |                 ^
      163 |         });
      164 |
      165 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:162:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:167:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º OAuth Authorization Flow â€º Token Exchange â€º should store access token securely and temporarily

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      180 |         const expiresIn = 3600; // 1 hour
      181 |
    > 182 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      183 |
      184 |         // Act
      185 |         const result = await myDataService.storeAccessTokenSecurely(accessToken, expiresIn);

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:182:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Consent Management â€º Consent Recording â€º should provide user-readable consent summary

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

    @@ -1,10 +1,9 @@
      Object {
        "contact": "æ–°ç«¹å¸‚æ”¿åºœè³‡è¨Šè™•",
        "dataTypes": Array [
          "åŸºæœ¬è³‡æ–™",
    -     "ç·Šæ€¥è¯çµ¡äºº",
        ],
        "purpose": "æ–°ç«¹å¸‚å®‰å¿ƒå®ˆè­·æœå‹™",
        "retention": "æœ€é•·ä¿å­˜ 30 å¤©",
        "rights": Array [
          "æ‚¨å¯éš¨æ™‚æ’¤å›åŒæ„",

      326 |
      327 |         // Assert
    > 328 |         expect(summary).toEqual({
          |                         ^
      329 |           title: 'è³‡æ–™ä½¿ç”¨åŒæ„æ›¸',
      330 |           purpose: 'æ–°ç«¹å¸‚å®‰å¿ƒå®ˆè­·æœå‹™',
      331 |           dataTypes: ['åŸºæœ¬è³‡æ–™', 'ç·Šæ€¥è¯çµ¡äºº'],

      at Object.toEqual (src/mobile/tests/services/MyDataIntegrationService.test.js:328:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Consent Management â€º Consent Revocation â€º should delete all associated data on consent revocation

    TypeError: Cannot read properties of undefined (reading 'getInternetCredentials')

      400 |         const userId = 'user-123';
      401 |         AsyncStorage.getItem.mockResolvedValue('{"name":"ç‹å°æ˜","phone":"0912345678"}');
    > 402 |         Keychain.getInternetCredentials.mockResolvedValue({
          |                  ^
      403 |           username: 'hsinchu_guardian',
      404 |           password: 'access_token_123'
      405 |         });

      at Object.getInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:402:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Security and Privacy â€º Token Security â€º should implement secure token storage with biometric protection

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      551 |         const sensitiveToken = 'highly_sensitive_access_token_12345';
      552 |
    > 553 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      554 |         Keychain.SECURITY_LEVEL = {
      555 |           SECURE_HARDWARE: 'SECURE_HARDWARE'
      556 |         };

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:553:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Security and Privacy â€º Data Encryption â€º should encrypt all stored personal data

    SyntaxError: Bad escaped character in JSON at position 12 (line 1 column 13)
        at JSON.parse (<anonymous>)

      392 |     const hex = encrypted.match(/.{2}/g).map(h => String.fromCharCode(parseInt(h, 16))).join('');
      393 |     const data = hex.split('_encrypted_with_')[0];
    > 394 |     return JSON.parse(data);
          |                 ^
      395 |   }
      396 |
      397 |   getUserEncryptionKey(userId) {

      at MyDataIntegrationService.parse [as decryptPersonalData] (src/mobile/src/services/MyDataIntegrationService.js:394:17)
      at Object.decryptPersonalData (src/mobile/tests/services/MyDataIntegrationService.test.js:600:47)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Error Handling and Edge Cases â€º OAuth Flow Errors â€º should handle network failures during OAuth

    Network request failed

      639 |             canRetry: true
      640 |           };
    > 641 |           throw new Error('Network request failed');
          |                 ^
      642 |         });
      643 |
      644 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:641:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:646:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Error Handling and Edge Cases â€º Data Processing Errors â€º should handle API rate limiting gracefully

    Rate limit exceeded

      690 |             userMessage: 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
      691 |           };
    > 692 |           throw new Error('Rate limit exceeded');
          |                 ^
      693 |         });
      694 |
      695 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:692:17)
      at Object.fetchUserProfile (src/mobile/tests/services/MyDataIntegrationService.test.js:697:25)

[0mPOST /api/v1/cases/case123/assign [33m403[0m 0.381 ms - 90[0m
FAIL backend src/backend/tests/integration/api.cases.test.js
  Case Flow API Endpoints
    POST /api/v1/cases/create
      âœ• should create a new case successfully (94 ms)
      âœ“ should validate required fields (42 ms)
      âœ“ should validate location coordinates (31 ms)
      âœ“ should require authentication (24 ms)
    GET /api/v1/cases/:id
      âœ• should return case details for authorized user (22 ms)
      âœ“ should return 404 for non-existent case (25 ms)
      âœ• should enforce access control based on case ownership (42 ms)
    PUT /api/v1/cases/:id/status
      âœ• should update case status successfully (33 ms)
      âœ“ should validate status transitions (65 ms)
      âœ“ should require appropriate permissions for status updates (27 ms)
    GET /api/v1/cases/search
      âœ• should search cases with filters (60 ms)
      âœ“ should support geographic search (36 ms)
      âœ“ should support pagination (74 ms)
    POST /api/v1/cases/:id/assign
      âœ• should assign case to volunteer successfully (4 ms)
      âœ“ should validate assignee exists and is eligible (31 ms)
      âœ• should check volunteer availability (3 ms)
      âœ“ should require case management permissions (48 ms)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/create â€º should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "é™³å°è¯",
            "phone": "0912345678",
            "relationship": "å¥³å…’",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:16.906Z",
    +     "createdBy": "admin123",
          "description": "78æ­²é™³è€å…ˆç”Ÿåœ¨å¤§æ½¤ç™¼èµ°å¤±",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-283",
    +     "location": Object {
            "address": "æ–°ç«¹å¸‚æ±å€å…‰å¾©è·¯äºŒæ®µ101è™Ÿ",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "èº«é«˜ç´„165cmï¼Œç©¿æ·±è‰²è¡£æœ",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "é™³è€å…ˆç”Ÿ",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:16.906Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º PUT /api/v1/cases/:id/status â€º should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/search â€º should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:16.589Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:16.589Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "æ–°ç«¹å¸‚æ±å€â—‹â—‹è·¯123è™Ÿ",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "é˜¿èŒ²æµ·é»˜ç—‡ç¬¬äºŒæœŸ",
    +         "patientName": "ç‹â—‹â—‹",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    +       "workflow": Object {
    +         "currentStage": "å»ºç«‹",
    +         "nextStages": Array [
    +           "æ´¾é£",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "å»ºç«‹",
    +             "timestamp": "2025-09-18T07:25:16.589Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

PASS frontend src/backend/tests/unit/case-flow.service.test.js
  æ¡ˆä»¶æµç¨‹æœå‹™ (CaseFlowService)
    1. æ¡ˆä»¶å»ºç«‹ (Case Creation)
      createCase()
        âœ“ æ‡‰è©²æˆåŠŸå»ºç«‹å¤±è¹¤äººå“¡æ¡ˆä»¶ (26 ms)
        âœ“ æ‡‰è©²ç‚ºç·Šæ€¥æ¡ˆä»¶è‡ªå‹•è¨­å®šæœ€é«˜å„ªå…ˆç´š (11 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„æ¡ˆä»¶å»ºç«‹çš„ç¨½æ ¸æ—¥èªŒ (19 ms)
        âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„æ¡ˆä»¶è³‡æ–™ (287 ms)
        âœ“ æ‡‰è©²ç‚ºä¸åŒé¡å‹æ¡ˆä»¶è¨­å®šé©ç•¶çš„é è¨­å€¼ (47 ms)
      æ¡ˆä»¶ç·¨è™Ÿç”Ÿæˆ
        âœ“ æ‡‰è©²ç”Ÿæˆå”¯ä¸€çš„æ¡ˆä»¶ç·¨è™Ÿ (15 ms)
        âœ“ æ‡‰è©²åŒ…å«æ—¥æœŸå’Œåºè™Ÿçš„æ¡ˆä»¶ç·¨è™Ÿ (22 ms)
    2. ç‹€æ…‹è½‰æ› (State Transitions)
      assignCase()
        âœ“ æ‡‰è©²å°‡æ¡ˆä»¶å¾å»ºç«‹ç‹€æ…‹è½‰ç‚ºæ´¾ç™¼ç‹€æ…‹ (36 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„ç‹€æ…‹è½‰æ›æ­·å² (28 ms)
        âœ“ æ‡‰è©²é€šçŸ¥ç›¸é—œäººå“¡æ¡ˆä»¶æ´¾ç™¼ (5 ms)
        âœ“ æ‡‰è©²æ‹’çµ•æ´¾ç™¼å·²çµæ¡ˆçš„æ¡ˆä»¶ (9 ms)
      updateCaseStatus()
        âœ“ æ‡‰è©²å…è¨±æœ‰æ•ˆçš„ç‹€æ…‹è½‰æ› (39 ms)
        âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„ç‹€æ…‹è½‰æ› (8 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„æ¯æ¬¡ç‹€æ…‹æ›´æ–° (27 ms)
      closeCase()
        âœ“ æ‡‰è©²æˆåŠŸçµæ¡ˆä¸¦è¨­å®šçµæ¡ˆåŸå›  (19 ms)
        âœ“ æ‡‰è©²è§¸ç™¼è³‡æ–™æ¸…ç†æµç¨‹ (6 ms)
    3. å¤šæ©Ÿé—œå”èª¿ (Multi-Agency Coordination)
      assignMultipleAgencies()
        âœ“ æ‡‰è©²åŒæ™‚æ´¾ç™¼çµ¦è­¦å¯Ÿã€æ¶ˆé˜²ã€é†«ç™‚å–®ä½ (25 ms)
        âœ“ æ‡‰è©²å»ºç«‹æ©Ÿé—œé–“é€šè¨Šé »é“ (4 ms)
        âœ“ æ‡‰è©²è¨­å®šæ©Ÿé—œå”èª¿æœƒè­°æ™‚é–“ (25 ms)
      updateAgencyStatus()
        âœ“ æ‡‰è©²æ›´æ–°å€‹åˆ¥æ©Ÿé—œçš„è™•ç†ç‹€æ…‹ (17 ms)
        âœ“ æ‡‰è©²è‡ªå‹•è¨ˆç®—æ•´é«”æ¡ˆä»¶é€²åº¦ (3 ms)
    4. å³æ™‚ç‹€æ…‹æ›´æ–°èˆ‡é€šçŸ¥ (Real-time Updates)
      broadcastCaseUpdate()
        âœ“ æ‡‰è©²å‘æ‰€æœ‰ç›¸é—œäººå“¡å»£æ’­æ¡ˆä»¶æ›´æ–° (23 ms)
        âœ“ æ‡‰è©²æ”¯æ´ç·Šæ€¥å»£æ’­æ¨¡å¼ (31 ms)
      subscribeToUpdates()
        âœ“ æ‡‰è©²å…è¨±ç”¨æˆ¶è¨‚é–±æ¡ˆä»¶æ›´æ–° (5 ms)
        âœ“ æ‡‰è©²æ”¯æ´å³æ™‚ WebSocket æ¨é€ (15 ms)
    5. æ¡ˆä»¶å‡ç´šæ©Ÿåˆ¶ (Case Escalation)
      escalateCase()
        âœ“ æ‡‰è©²æ ¹æ“šæ™‚é–“è‡ªå‹•å‡ç´šæ¡ˆä»¶ (13 ms)
        âœ“ æ‡‰è©²æ ¹æ“šåš´é‡ç¨‹åº¦å‡ç´šæ¡ˆä»¶ (28 ms)
        âœ“ æ‡‰è©²è‡ªå‹•åˆ†é…é¡å¤–è³‡æº (11 ms)
      escalationTriggers
        âœ“ æ‡‰è©²åœ¨å¤±è¹¤å…’ç«¥æ¡ˆä»¶è‡ªå‹•å‡ç´š (26 ms)
        âœ“ æ‡‰è©²åœ¨å¤šäººå¤±è¹¤æ¡ˆä»¶è‡ªå‹•å‡ç´š (3 ms)
    6. æœå°‹å€åŸŸç®¡ç† (Search Area Management)
      defineSearchArea()
        âœ“ æ‡‰è©²å»ºç«‹æœå°‹å€åŸŸä¸¦åˆ†é…æœå°‹éšŠ (54 ms)
        âœ“ æ‡‰è©²æ ¹æ“šåœ°å½¢è‡ªå‹•åˆ†é…é©ç•¶çš„æœå°‹éšŠ (12 ms)
        âœ“ æ‡‰è©²è¨ˆç®—æœå°‹æ™‚é–“é ä¼° (23 ms)
      assignZoneToTeam()
        âœ“ æ‡‰è©²åˆ†é…æœå°‹å€åŸŸçµ¦ç‰¹å®šéšŠä¼ (42 ms)
        âœ“ æ‡‰è©²è¿½è¹¤æœå°‹é€²åº¦ (3 ms)
    7. å¿—å·¥æ´¾é£å”èª¿ (Volunteer Dispatch)
      requestVolunteers()
        âœ“ æ‡‰è©²æ ¹æ“šéœ€æ±‚è«‹æ±‚å¿—å·¥æ”¯æ´ (48 ms)
        âœ“ æ‡‰è©²é€šçŸ¥åˆæ ¼çš„å¿—å·¥ (15 ms)
        âœ“ æ‡‰è©²ç®¡ç†å¿—å·¥å ±åˆ°å’Œåˆ†çµ„ (4 ms)
      manageVolunteerSafety()
        âœ“ æ‡‰è©²è¿½è¹¤å¿—å·¥å®‰å…¨ç‹€æ…‹ (27 ms)
        âœ“ æ‡‰è©²åœ¨å¿—å·¥å¤±è¯æ™‚ç™¼å‡ºè­¦å‘Š (3 ms)
    8. æ¡ˆä»¶è§£æ±ºèˆ‡çµæ¡ˆæµç¨‹ (Case Resolution)
      resolveCase()
        âœ“ æ‡‰è©²è¨˜éŒ„æ¡ˆä»¶è§£æ±ºè©³æƒ… (3 ms)
        âœ“ æ‡‰è©²ç”Ÿæˆæ¡ˆä»¶æ‘˜è¦å ±å‘Š (21 ms)
        âœ“ æ‡‰è©²è§¸ç™¼å¾ŒçºŒè™•ç†æµç¨‹ (14 ms)
      æ¡ˆä»¶é—œé–‰å¾Œè™•ç†
        âœ“ æ‡‰è©²å®‰æ’è³‡æ–™ä¿ç•™å’Œæ¸…ç† (29 ms)
        âœ“ æ‡‰è©²æ›´æ–°ç›¸é—œçµ±è¨ˆå’ŒKPI (10 ms)
    9. æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤ (Performance Metrics)
      trackResponseTime()
        âœ“ æ‡‰è©²è¨˜éŒ„å„éšæ®µéŸ¿æ‡‰æ™‚é–“ (32 ms)
        âœ“ æ‡‰è©²è¨ˆç®—å¹³å‡éŸ¿æ‡‰æ™‚é–“ (27 ms)
      trackResourceUtilization()
        âœ“ æ‡‰è©²è¿½è¹¤è³‡æºä½¿ç”¨æ•ˆç‡ (10 ms)
      generatePerformanceReport()
        âœ“ æ‡‰è©²ç”Ÿæˆæ•ˆèƒ½åˆ†æå ±å‘Š (20 ms)
    10. ç­åˆ¥äº¤æ¥ (Shift Handoff)
      prepareShiftHandoff()
        âœ“ æ‡‰è©²æº–å‚™ç­åˆ¥äº¤æ¥è³‡æ–™ (5 ms)
        âœ“ æ‡‰è©²æ¨™è­˜éœ€è¦ç‰¹åˆ¥é—œæ³¨çš„æ¡ˆä»¶ (3 ms)
        âœ“ æ‡‰è©²ç”Ÿæˆäº¤æ¥æª¢æŸ¥æ¸…å–® (15 ms)
      executeShiftHandoff()
        âœ“ æ‡‰è©²åŸ·è¡Œç­åˆ¥äº¤æ¥ä¸¦è¨˜éŒ„ç¢ºèª (32 ms)
        âœ“ æ‡‰è©²æ›´æ–°æ¡ˆä»¶è² è²¬äºº (8 ms)
    11. ç·Šæ€¥å‡ç´šè§¸ç™¼å™¨ (Emergency Escalation Triggers)
      automaticEscalationTriggers
        âœ“ æ‡‰è©²åœ¨å…’ç«¥å¤±è¹¤æ™‚ç«‹å³è§¸ç™¼æœ€é«˜ç´šåˆ¥è­¦å ± (3 ms)
        âœ“ æ‡‰è©²åœ¨å¤§é‡å‚·äº¡äº‹ä»¶æ™‚å•Ÿå‹•ç½å®³æ‡‰è®Šæ©Ÿåˆ¶ (47 ms)
        âœ“ æ‡‰è©²åœ¨ææ€–æ”»æ“Šç–‘æ…®æ™‚å•Ÿå‹•åææ©Ÿåˆ¶ (2 ms)
      escalationChain
        âœ“ æ‡‰è©²ä¾åºé€šçŸ¥å‡ç´šéˆä¸­çš„ç›¸é—œäººå“¡ (3 ms)
        âœ“ æ‡‰è©²åœ¨é€£çºŒå‡ç´šå¾Œå•Ÿå‹•æŒ‡æ®å®˜ç´šåˆ¥éŸ¿æ‡‰ (3 ms)
      publicSafetyTriggers
        âœ“ æ‡‰è©²åœ¨å…¬å…±å®‰å…¨å¨è„…æ™‚ç™¼å¸ƒç·Šæ€¥è­¦å ± (3 ms)
        âœ“ æ‡‰è©²å”èª¿å¤šæ©Ÿé—œç·Šæ€¥æ‡‰è®Š (16 ms)
    éŒ¯èª¤è™•ç†å’Œé‚Šç·£æ¡ˆä¾‹ (Error Handling & Edge Cases)
      âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„æ¡ˆä»¶é¡å‹ (8 ms)
      âœ“ æ‡‰è©²è™•ç†ä¸¦ç™¼æ¡ˆä»¶å»ºç«‹ (79 ms)
      âœ“ æ‡‰è©²è™•ç†ç³»çµ±è³‡æºä¸è¶³çš„æƒ…æ³ (3 ms)
      âœ“ æ‡‰è©²åœ¨æ¬Šé™ä¸è¶³æ™‚æ‹’çµ•æ“ä½œ (3 ms)

PASS frontend src/backend/tests/unit/kpi.service.test.js
  KPI æœå‹™ (KPI Service)
    å³æ™‚ KPI è¨ˆç®—èˆ‡èšåˆ (Real-time KPI Calculation)
      âœ“ æ‡‰è¨ˆç®—æ¡ˆä»¶è™•ç†å³æ™‚çµ±è¨ˆ (43 ms)
      âœ“ æ‡‰èšåˆå¤šå€‹åœ°ç†å€åŸŸçš„ KPI (3 ms)
      âœ“ æ‡‰è¨ˆç®—åˆ†æ™‚æ®µçš„ KPI è¶¨å‹¢ (21 ms)
      âœ“ æ‡‰æ”¯æ´å³æ™‚ KPI æ›´æ–°æ¨é€ (1 ms)
      âœ“ æ‡‰è™•ç†å¤§é‡ä¸¦ç™¼çš„ KPI è¨ˆç®—è«‹æ±‚ (2 ms)
    æ¡ˆä»¶è§£æ±ºæŒ‡æ¨™ (Case Resolution Metrics)
      âœ“ æ‡‰è¨ˆç®—å¹³å‡æ¡ˆä»¶å›æ‡‰æ™‚é–“ (3 ms)
      âœ“ æ‡‰è¨ˆç®—æ¡ˆä»¶æˆåŠŸè§£æ±ºç‡ (2 ms)
      âœ“ æ‡‰è¿½è¹¤æ¡ˆä»¶å‡ç´šå’Œé™ç´šæ¨¡å¼ (9 ms)
      âœ“ æ‡‰è¨ˆç®—ä¸åŒå„ªå…ˆç´šæ¡ˆä»¶çš„ SLA é”æˆç‡ (3 ms)
      âœ“ æ‡‰åˆ†ææ¡ˆä»¶é‡æ–°é–‹å•Ÿç‡ (6 ms)
    å¿—å·¥ç¸¾æ•ˆæŒ‡æ¨™ (Volunteer Performance Metrics)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥æ´»èºåº¦æŒ‡æ¨™ (5 ms)
      âœ“ æ‡‰è¿½è¹¤å¿—å·¥å›æ‡‰æ™‚é–“ (2 ms)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥æ»¿æ„åº¦è©•åˆ† (2 ms)
      âœ“ æ‡‰åˆ†æå¿—å·¥åŸ¹è¨“å®Œæˆç‡ (1 ms)
      âœ“ æ‡‰è¿½è¹¤å¿—å·¥ç•™ä»»ç‡ (1 ms)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥å·¥ä½œè² è·åˆ†ä½ˆ (4 ms)
    ç³»çµ±æ•ˆèƒ½æŒ‡æ¨™ (System Performance Indicators)
      âœ“ æ‡‰ç›£æ§ API å›æ‡‰æ™‚é–“ (1 ms)
      âœ“ æ‡‰è¿½è¹¤è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½ (2 ms)
      âœ“ æ‡‰ç›£æ§ç³»çµ±è¨˜æ†¶é«”ä½¿ç”¨ç‡ (1 ms)
      âœ“ æ‡‰è¿½è¹¤åŒæ™‚é€£ç·šä½¿ç”¨è€…æ•¸é‡ (2 ms)
      âœ“ æ‡‰ç›£æ§å„²å­˜ç©ºé–“ä½¿ç”¨æƒ…æ³ (2 ms)
    è¶¨å‹¢åˆ†æèˆ‡é æ¸¬ (Trend Analysis and Forecasting)
      âœ“ æ‡‰åˆ†ææ¡ˆä»¶æ•¸é‡è¶¨å‹¢ (15 ms)
      âœ“ æ‡‰é æ¸¬å¿—å·¥éœ€æ±‚ (2 ms)
      âœ“ æ‡‰æª¢æ¸¬ KPI ç•°å¸¸æ¨¡å¼ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿå­£ç¯€æ€§è¶¨å‹¢å ±å‘Š (2 ms)
      âœ“ æ‡‰è¨ˆç®— KPI è®ŠåŒ–ç‡å’Œæˆé•·ç‡ (2 ms)
    è­¦å ±é–¾å€¼èˆ‡é€šçŸ¥ (Alert Thresholds and Notifications)
      âœ“ æ‡‰è¨­å®šå’Œç®¡ç† KPI è­¦å ±é–¾å€¼ (24 ms)
      âœ“ æ‡‰æª¢æŸ¥ KPI å€¼æ˜¯å¦è¶…éé–¾å€¼ (4 ms)
      âœ“ æ‡‰ç™¼é€é–¾å€¼çªç ´è­¦å ± (1 ms)
      âœ“ æ‡‰ç®¡ç†è­¦å ±å‡ç´šæ©Ÿåˆ¶ (1 ms)
      âœ“ æ‡‰æ”¯æ´æ™ºæ…§å‹è­¦å ±é »ç‡æ§åˆ¶ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿè­¦å ±çµ±è¨ˆå ±å‘Š (1 ms)
    å„€è¡¨æ¿è³‡æ–™æº–å‚™ (Dashboard Data Preparation)
      âœ“ æ‡‰æº–å‚™å³æ™‚å„€è¡¨æ¿è³‡æ–™ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿæ­·å²è¶¨å‹¢åœ–è¡¨è³‡æ–™ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿåœ°ç†åˆ†ä½ˆç†±é»åœ–è³‡æ–™ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿ KPI æ¯”è¼ƒè¡¨æ ¼è³‡æ–™ (6 ms)
      âœ“ æ‡‰æ”¯æ´å„€è¡¨æ¿è³‡æ–™çš„å¿«å–æ©Ÿåˆ¶ (1 ms)
    è‡ªè¨‚ KPI å®šç¾© (Custom KPI Definitions)
      âœ“ æ‡‰å…è¨±å»ºç«‹è‡ªè¨‚ KPI æŒ‡æ¨™ (2 ms)
      âœ“ æ‡‰é©—è­‰è‡ªè¨‚ KPI å…¬å¼çš„æ­£ç¢ºæ€§ (2 ms)
      âœ“ æ‡‰è¨ˆç®—è‡ªè¨‚ KPI çš„æ•¸å€¼ (2 ms)
      âœ“ æ‡‰æ”¯æ´æ¢ä»¶å¼ KPI è¨ˆç®— (1 ms)
      âœ“ æ‡‰ç®¡ç† KPI è¨ˆç®—æ’ç¨‹ (2 ms)
      âœ“ æ‡‰æä¾› KPI è¨ˆç®—æ­·å²è¨˜éŒ„ (1 ms)
      âœ“ æ‡‰æ”¯æ´ KPI çš„ç‰ˆæœ¬ç®¡ç† (1 ms)
      âœ“ æ‡‰é©—è­‰ KPI æ•¸æ“šå“è³ª (1 ms)
    éŒ¯èª¤è™•ç† (Error Handling)
      âœ“ æ‡‰åœ¨ KPI è¨ˆç®—å¤±æ•—æ™‚æ‹‹å‡ºè¨ˆç®—éŒ¯èª¤ (148 ms)
      âœ“ æ‡‰åœ¨é–¾å€¼è¨­å®šç„¡æ•ˆæ™‚æ‹‹å‡ºé–¾å€¼éŒ¯èª¤ (5 ms)
      âœ“ æ‡‰åœ¨æŸ¥è©¢åƒæ•¸ç„¡æ•ˆæ™‚æ‹‹å‡ºé©—è­‰éŒ¯èª¤ (27 ms)
      âœ“ æ‡‰å„ªé›…è™•ç†è³‡æ–™ä¾†æºé€£ç·šå¤±æ•— (1 ms)

PASS frontend src/backend/tests/unit/rbac.service.test.js
  RBACService - è§’è‰²æ¬Šé™æ§åˆ¶æœå‹™
    1. Role-Based Access Control (åŸºæœ¬è§’è‰²æ§åˆ¶)
      Role Definitions
        âœ“ should define Viewer role with read-only permissions (2 ms)
        âœ“ should define Operator role with case management permissions (1 ms)
        âœ“ should define Admin role with full system permissions (1 ms)
        âœ“ should reject invalid role types (163 ms)
      User Role Assignment
        âœ“ should assign single role to user (7 ms)
        âœ“ should assign multiple roles to user (1 ms)
        âœ“ should prevent role escalation without proper authorization (10 ms)
    2. Permission Validation (æ¬Šé™é©—è­‰)
      Sensitive Operations
        âœ“ should validate permission for case deletion (19 ms)
        âœ“ should deny permission for unauthorized export operations (8 ms)
        âœ“ should validate emergency override permissions (1 ms)
      Resource-Specific Permissions
        âœ“ should validate department-specific case access (1 ms)
        âœ“ should deny cross-department case access (4 ms)
    3. Field-Level Visibility Control (æ¬„ä½ç´šå¯è¦‹æ€§æ§åˆ¶)
      PII Protection
        âœ“ should hide PII fields from Viewer role (22 ms)
        âœ“ should show limited PII to Operator role (1 ms)
        âœ“ should show full PII to Admin role (4 ms)
        âœ“ should apply custom masking rules for healthcare data (12 ms)
    4. Multi-Tenant Support (å¤šç§Ÿæˆ¶æ”¯æ´)
      Tenant Isolation
        âœ“ should isolate data between different county governments (1 ms)
        âœ“ should prevent cross-tenant data access (1 ms)
        âœ“ should support super-admin cross-tenant access (1 ms)
    5. Session Management with Role Context (è§’è‰²ä¸Šä¸‹æ–‡æœƒè©±ç®¡ç†)
      Session Creation
        âœ“ should create session with role context (1 ms)
        âœ“ should set appropriate session timeout based on role (1 ms)
      Session Validation
        âœ“ should validate active session with current permissions
        âœ“ should invalidate expired sessions (38 ms)
      Role Context Updates
        âœ“ should update session when user roles change (1 ms)
    6. Audit Trail for Permission Changes (æ¬Šé™è®Šæ›´ç¨½æ ¸è»Œè·¡)
      Permission Change Logging
        âœ“ should log role assignment with full context (1 ms)
        âœ“ should log role removal with approval chain
        âœ“ should create immutable audit records (1 ms)
      Audit Query and Review
        âœ“ should query audit trail with proper filtering (8 ms)
        âœ“ should detect audit trail tampering (1 ms)
    7. Bulk Role Assignments (æ‰¹é‡è§’è‰²æŒ‡æ´¾)
      Department-wide Assignments
        âœ“ should assign roles to entire department (1 ms)
        âœ“ should handle partial failures in bulk assignment (11 ms)
        âœ“ should validate bulk assignment permissions (1 ms)
      CSV Import Role Assignment
        âœ“ should process CSV role assignment file (1 ms)
        âœ“ should validate CSV format and reject invalid entries (1 ms)
    8. Time-Based Access Controls (æ™‚é–“åŸºç¤å­˜å–æ§åˆ¶)
      Scheduled Access
        âœ“ should grant access during business hours (11 ms)
        âœ“ should deny access outside business hours (1 ms)
        âœ“ should handle emergency override for time restrictions (1 ms)
      Temporary Access Grants
        âœ“ should grant temporary elevated access (1 ms)
        âœ“ should automatically revoke expired temporary access (1 ms)
    9. Resource-Specific Permissions (è³‡æºç‰¹å®šæ¬Šé™)
      Healthcare Data Access
        âœ“ should validate medical record access permissions (1 ms)
        âœ“ should deny medical access without proper license (25 ms)
      Location-Based Access
        âœ“ should validate geographic boundary access (1 ms)
        âœ“ should deny access to out-of-jurisdiction resources (1 ms)
    10. Security Event Logging (å®‰å…¨äº‹ä»¶è¨˜éŒ„)
      Suspicious Activity Detection
        âœ“ should detect and log multiple failed access attempts (1 ms)
        âœ“ should log privilege escalation attempts (5 ms)
      Compliance Reporting
        âœ“ should generate GDPR compliance report (1 ms)
        âœ“ should generate Taiwan Personal Data Protection Act report (1 ms)
      Real-time Security Monitoring
        âœ“ should trigger real-time alerts for critical events (1 ms)
        âœ“ should implement circuit breaker for repeated violations (1 ms)
    Integration with Taiwan Healthcare Regulations
      âœ“ should implement NHI data access controls (1 ms)
      âœ“ should comply with MOHW data retention policies

PASS frontend src/backend/tests/unit/audit.service.test.js
  ç¨½æ ¸æœå‹™ (Audit Service)
    ç¶œåˆç¨½æ ¸è¨˜éŒ„ (Comprehensive Audit Logging)
      âœ“ æ‡‰è¨˜éŒ„ä½¿ç”¨è€…ç™»å…¥äº‹ä»¶ (12 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™å­˜å–äº‹ä»¶ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„ç³»çµ±ç®¡ç†æ“ä½œ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™åŒ¯å‡ºäº‹ä»¶ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„å¤±æ•—çš„æ“ä½œå˜—è©¦ (11 ms)
    ç¨½æ ¸è»Œè·¡å®Œæ•´æ€§ (Audit Trail Integrity)
      âœ“ æ‡‰ç‚ºæ¯ç­†ç¨½æ ¸è¨˜éŒ„å»ºç«‹é›œæ¹Šå€¼ (1 ms)
      âœ“ æ‡‰å»ºç«‹ç¨½æ ¸è¨˜éŒ„éˆå¼é›œæ¹Š (1 ms)
      âœ“ æ‡‰æª¢æ¸¬ç¨½æ ¸è¨˜éŒ„çš„ç¯¡æ”¹ (2 ms)
      âœ“ æ‡‰åœ¨æª¢æ¸¬åˆ°ç¯¡æ”¹æ™‚ç™¼é€å®‰å…¨è­¦å ± (28 ms)
      âœ“ æ‡‰æ”¯æ´ç¨½æ ¸è¨˜éŒ„çš„æ•¸ä½ç°½ç«  (1 ms)
    åˆè¦å ±å‘Š (Compliance Reporting)
      âœ“ æ‡‰ç”¢ç”Ÿ GDPR åˆè¦å ±å‘Š (13 ms)
      âœ“ æ‡‰ç”¢ç”Ÿå°ç£å€‹è³‡æ³•åˆè¦å ±å‘Š (2 ms)
      âœ“ æ‡‰ç”¢ç”Ÿé†«ç™‚æ³•è¦åˆè¦å ±å‘Š (1 ms)
      âœ“ æ‡‰é©—è­‰åˆè¦å ±å‘Šçš„å®Œæ•´æ€§ (1 ms)
      âœ“ æ‡‰è‡ªå‹•æª¢æŸ¥åˆè¦æ€§é•è¦ (1 ms)
    è³‡æ–™å­˜å–è¿½è¹¤ (Data Access Tracking)
      âœ“ æ‡‰è¿½è¹¤å€‹äººè³‡æ–™çš„å­˜å–æ¨¡å¼ (27 ms)
      âœ“ æ‡‰æª¢æ¸¬ç•°å¸¸çš„è³‡æ–™å­˜å–è¡Œç‚º (5 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™ä¸‹è¼‰å’Œåˆ—å°äº‹ä»¶ (1 ms)
      âœ“ æ‡‰æä¾›è³‡æ–™è¡€ç·£è¿½è¹¤ (1 ms)
    å®‰å…¨äº‹ä»¶è¨˜éŒ„ (Security Event Logging)
      âœ“ æ‡‰è¨˜éŒ„ç™»å…¥å¤±æ•—äº‹ä»¶ (30 ms)
      âœ“ æ‡‰è¨˜éŒ„æ¬Šé™æå‡äº‹ä»¶ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„å¯ç–‘çš„æª”æ¡ˆå­˜å– (6 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™åº«ç›´æ¥å­˜å–äº‹ä»¶ (25 ms)
    ç¨½æ ¸æ—¥èªŒä¿ç•™èˆ‡æ­¸æª” (Audit Log Retention)
      âœ“ æ‡‰æ ¹æ“šä¿ç•™æ”¿ç­–æ­¸æª”èˆŠè¨˜éŒ„ (1 ms)
      âœ“ æ‡‰å£“ç¸®æ­¸æª”çš„ç¨½æ ¸è¨˜éŒ„ (24 ms)
      âœ“ æ‡‰é©—è­‰æ­¸æª”è³‡æ–™çš„å®Œæ•´æ€§ (1 ms)
      âœ“ æ‡‰æ”¯æ´æ­¸æª”è³‡æ–™çš„æœå°‹ (3 ms)
    æŸ¥è©¢èˆ‡æœå°‹åŠŸèƒ½ (Query and Search)
      âœ“ æ‡‰æ”¯æ´è¤‡é›œçš„ç¨½æ ¸è¨˜éŒ„æŸ¥è©¢ (14 ms)
      âœ“ æ‡‰æ”¯æ´å…¨æ–‡æœå°‹ç¨½æ ¸è¨˜éŒ„ (1 ms)
      âœ“ æ‡‰æä¾›ç¨½æ ¸çµ±è¨ˆæ‘˜è¦ (1 ms)
    ç›£ç®¡æ©Ÿé—œåŒ¯å‡ºåŠŸèƒ½ (Regulatory Export)
      âœ“ æ‡‰ç”¢ç”Ÿç›£ç®¡æ©Ÿé—œæ ¼å¼çš„ç¨½æ ¸å ±å‘Š (1 ms)
      âœ“ æ‡‰ç‚ºç›£ç®¡åŒ¯å‡ºåŠ ä¸Šæµ®æ°´å° (21 ms)
      âœ“ æ‡‰è¨˜éŒ„ç›£ç®¡æ©Ÿé—œçš„è³‡æ–™è«‹æ±‚ (4 ms)
      âœ“ æ‡‰é©—è­‰ç›£ç®¡åŒ¯å‡ºçš„æˆæ¬Š
    éŒ¯èª¤è™•ç† (Error Handling)
      âœ“ æ‡‰åœ¨ç¨½æ ¸è¨˜éŒ„å¤±æ•—æ™‚æ‹‹å‡ºéŒ¯èª¤ (89 ms)
      âœ“ æ‡‰åœ¨ç„¡æ•ˆæŸ¥è©¢åƒæ•¸æ™‚æ‹‹å‡ºé©—è­‰éŒ¯èª¤ (68 ms)
      âœ“ æ‡‰åœ¨æœªæˆæ¬Šå­˜å–æ™‚æ‹‹å‡ºå®‰å…¨éŒ¯èª¤ (19 ms)
      âœ“ æ‡‰åœ¨åˆè¦æª¢æŸ¥å¤±æ•—æ™‚æ‹‹å‡ºåˆè¦éŒ¯èª¤ (3 ms)

PASS frontend src/backend/tests/unit/ble-scanner.service.test.js
  BLEScannerService
    Android 12+ Permission Handling
      neverForLocation Scanning
        âœ“ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (10 ms)
        âœ“ should discover BLE devices without location inference (7 ms)
        âœ“ should generate device hashes with salt immediately (2 ms)
      Location-Based Scanning for Positioning
        âœ“ should request location permissions when inference enabled (1 ms)
        âœ“ should include RSSI and location data in volunteer hits (4 ms)
        âœ“ should fuzz location to 100m grid squares (1 ms)
        âœ“ should round timestamps to 5-minute intervals (2 ms)
    iOS Background BLE Handling
      State Preservation
        âœ“ should configure CBCentralManager with restore identifier (3 ms)
        âœ“ should save scanning state for preservation (1 ms)
      State Restoration
        âœ“ should restore scanning state on app launch (4 ms)
        âœ“ should resume background scanning automatically (25 ms)
    Device Discovery and Filtering
      RSSI Threshold Filtering
        âœ“ should process devices with RSSI stronger than -90 dBm (1 ms)
        âœ“ should ignore devices with RSSI weaker than -90 dBm
        âœ“ should handle edge case at exactly -90 dBm threshold (3 ms)
      MAC Address Rotation Handling
        âœ“ should handle MAC rotation by treating each MAC as separate device (2 ms)
        âœ“ should not correlate rotated MAC addresses (1 ms)
        âœ“ should maintain k-anonymity across MAC rotations (3 ms)
    Battery-Efficient Scanning
      Power Management
        âœ“ should use conservative scanning when not charging (3 ms)
        âœ“ should use aggressive scanning when charging
        âœ“ should adapt intervals based on detection rate (4 ms)
    VolunteerHit Creation
      Complete Anonymization
        âœ“ should create VolunteerHit with all required anonymized fields (2 ms)
        âœ“ should never store original MAC addresses (12 ms)
        âœ“ should never store device names or personal identifiers (7 ms)
    Error Handling
      BLE Adapter Failures
        âœ“ should handle BLE adapter disabled gracefully (7 ms)
        âœ“ should resume scanning when Bluetooth is re-enabled (1 ms)
      Permission Revocation
        âœ“ should stop scanning immediately when permissions revoked (4 ms)
        âœ“ should preserve queued data when permissions revoked (4 ms)
        âœ“ should resume from preserved state when permissions re-granted (1 ms)

PASS frontend src/backend/tests/unit/geo-alert.service.test.js
  GeoAlertService
    Alert Radius Configuration and Targeting
      500m, 1km, 2km Radius Support
        âœ“ should receive alert when within 500m radius (17 ms)
        âœ“ should NOT receive alert when outside 1km radius
        âœ“ should support 2km radius for wide area alerts (14 ms)
        âœ“ should handle edge case at exact radius boundary
    Alert Cooldown and Spam Prevention
      5-Minute Minimum Cooldown
        âœ“ should prevent duplicate alerts within 5-minute cooldown (1 ms)
        âœ“ should allow alert after 5-minute cooldown expires
        âœ“ should show cooldown timer to user (1 ms)
        âœ“ should reset cooldown when timer expires
    Privacy Protection - No PII in Alerts
      Alert Content Restrictions
        âœ“ should never include names in alert messages (1 ms)
        âœ“ should never include age or gender information
        âœ“ should never include photos or physical descriptions (1 ms)
        âœ“ should use only general area descriptions
    Alert Priority Levels
      Info Level Alerts
        âœ“ should send info level with standard notification settings (1 ms)
        âœ“ should not override Do Not Disturb for info alerts
      Warning Level Alerts
        âœ“ should send warning level with prominent notification (1 ms)
        âœ“ should use Time-Sensitive delivery on iOS for warnings (7 ms)
        âœ“ should use high importance channel on Android for warnings
      Critical Level Alerts
        âœ“ should send critical level with maximum urgency settings
        âœ“ should use Critical Alert on iOS if authorized (4 ms)
        âœ“ should use Full-Screen Intent on Android with user consent
        âœ“ should allow user to dismiss or snooze critical alerts (1 ms)
    Mandatory Safety Instructions
      Required Message Content
        âœ“ should always include "è«‹æ’¥æ‰“110" in all alert levels
        âœ“ should always include "åˆ‡å‹¿è‡ªè¡Œæ¥è¿‘" in all alert levels (1 ms)
        âœ“ should provide emergency contact button in all alerts
        âœ“ should provide "å›å ±å¯ç–‘" button for volunteer coordination (1 ms)
        âœ“ should provide safety guidelines link
    A/B Testing for Safety Message Effectiveness
      Message Variant Testing
        âœ“ should assign users to A/B test groups for message variations (1 ms)
        âœ“ should use variant B wording for test group B
        âœ“ should track engagement metrics for A/B test analysis
        âœ“ should record user response for effectiveness analysis (1 ms)
        âœ“ should ensure core safety instructions remain unchanged across variants (16 ms)
    Error Handling and Edge Cases
      Location Permission Errors
        âœ“ should handle location permission denied gracefully
        âœ“ should fallback to general notifications when location unavailable (1 ms)
      Push Notification Errors
        âœ“ should handle push notification permission disabled (11 ms)
        âœ“ should show in-app alert banner when push notifications fail (1 ms)
        âœ“ should still attempt delivery for critical alerts when notifications disabled

PASS frontend src/backend/tests/unit/anonymization.service.test.js
  AnonymizationService
    Device Hash Generation
      One-Way Hash with Salt
        âœ“ should generate SHA-256 hash with salt for device MAC address (2 ms)
        âœ“ should use consistent salt for same session (1 ms)
        âœ“ should generate new salt for new session (1 ms)
        âœ“ should make hash irreversible - no reverse lookup possible (15 ms)
      Hash Consistency and Collision Handling
        âœ“ should generate same hash for same MAC address in same session (1 ms)
        âœ“ should generate different hashes for different MAC addresses (1 ms)
        âœ“ should handle hash collisions gracefully (1 ms)
    VolunteerHit Creation
      Complete Data Anonymization
        âœ“ should create VolunteerHit with all PII removed (17 ms)
        âœ“ should never store original device names (1 ms)
        âœ“ should never store device IDs, phone numbers, or personal identifiers (1 ms)
      Location Fuzzing
        âœ“ should fuzz location to 100m grid squares (15 ms)
        âœ“ should never store precise location coordinates (5 ms)
        âœ“ should handle edge cases near grid boundaries (2 ms)
      Timestamp Rounding
        âœ“ should round timestamps to 5-minute intervals (33 ms)
        âœ“ should never store precise timestamps (15 ms)
        âœ“ should handle edge cases at interval boundaries (1 ms)
    K-Anonymity Enforcement
      Minimum Cluster Size Validation
        âœ“ should require minimum 3 devices per cluster (1 ms)
        âœ“ should allow upload when k=3 minimum is met
        âœ“ should queue VolunteerHits until k-anonymity is achieved (23 ms)
        âœ“ should upload all queued hits when k-anonymity threshold reached (1 ms)
      Individual Device Identification Prevention
        âœ“ should ensure individual devices cannot be identified from clusters (13 ms)
        âœ“ should validate that server data cannot reverse lookup individual devices (1 ms)
    Privacy Protection Validation
      Data Minimization
        âœ“ should only store essential anonymized data (1 ms)
        âœ“ should purge unnecessary metadata and device fingerprints
      Anonymization Verification
        âœ“ should verify no reverse lookup is possible from anonymized data (21 ms)
        âœ“ should detect and reject data containing PII (7 ms)
    Error Handling and Edge Cases
      Malformed Data Handling
        âœ“ should handle malformed MAC addresses gracefully (143 ms)
        âœ“ should handle invalid location coordinates gracefully (19 ms)
        âœ“ should handle timestamp parsing errors gracefully (2 ms)

PASS frontend tests/validation/p1-family-geofence-validation.test.js
  P1 å®¶å±¬ç«¯ Production Validation
    E2E Geofence Scenarios
      é€²å…¥ (Entry) Scenarios
        âœ“ should detect entry into Hsinchu City Hall geofence (35 ms)
        âœ“ should handle entry with GPS uncertainty edge cases (1 ms)
      é›¢é–‹ (Exit) Scenarios
        âœ“ should implement 30-second exit confirmation delay (2 ms)
        âœ“ should cancel exit if user returns within 30 seconds (1 ms)
      åœç•™ (Dwelling) Scenarios
        âœ“ should track dwelling time and send periodic updates (38 ms)
    iOS Time-Sensitive Notifications Validation
      âœ“ should use Time-Sensitive but NOT Critical level notifications (1 ms)
      âœ“ should respect iOS Focus/DND modes appropriately
      âœ“ should handle iOS notification authorization correctly (62 ms)
    Android High-Priority Channels Validation
      âœ“ should create high-priority channel WITHOUT DND bypass (1 ms)
      âœ“ should respect user DND preferences (1 ms)
      âœ“ should handle Android 13+ notification permissions (13 ms)
    Geofence Accuracy and Timing Validation
      âœ“ should maintain 10m accuracy requirement under various conditions (1 ms)
      âœ“ should handle timing precision for event correlation (2 ms)
      âœ“ should validate geofence coordinate precision for Hsinchu area (35 ms)
    Production Integration Validation
      âœ“ should integrate with real backend API endpoints (1 ms)
      âœ“ should handle production error scenarios gracefully (1 ms)

PASS frontend src/backend/tests/unit/geofence-engine.service.test.js
  GeofenceEngine - RED Phase Tests
    Boundary Detection with 10m Accuracy
      detectEntry
        âœ“ should detect entry within 10m accuracy threshold (41 ms)
        âœ“ should not detect entry when GPS accuracy exceeds 10m (163 ms)
        âœ“ should handle edge case at exact boundary with GPS uncertainty (12 ms)
      detectExit
        âœ“ should detect exit with 30s delay confirmation (8 ms)
        âœ“ should cancel exit confirmation if user returns within 30s (13 ms)
        âœ“ should handle multiple geofences with independent exit delays (6 ms)
    Cooldown Management (5-minute between notifications)
      notificationCooldown
        âœ“ should enforce 5-minute cooldown between notifications (7 ms)
        âœ“ should allow notifications after 5-minute cooldown expires (4 ms)
        âœ“ should handle different cooldown periods for different event types (13 ms)
        âœ“ should allow immediate notifications for different geofences (1 ms)
    Dwell Time Tracking (5+ minutes)
      trackDwellTime
        âœ“ should track dwell time when user stays in geofence for 5+ minutes (2 ms)
        âœ“ should trigger dwell alerts at specific intervals (2 ms)
        âœ“ should reset dwell time when user exits and re-enters (1 ms)
        âœ“ should handle movement within geofence without resetting dwell time (38 ms)
    Geofence Configuration and Management
      createGeofence
        âœ“ should validate geofence parameters before creation (32 ms)
        âœ“ should enforce maximum number of geofences per user (2 ms)
        âœ“ should validate geofence names are unique per user (2 ms)
      updateGeofence
        âœ“ should handle geofence boundary updates and notify affected users (2 ms)
    Performance and Optimization
      batchLocationProcessing
        âœ“ should efficiently process multiple users locations simultaneously (11 ms)
        âœ“ should handle high-frequency location updates without performance degradation (12 ms)
    Error Handling and Recovery
      errorRecovery
        âœ“ should handle location service failures gracefully (7 ms)
        âœ“ should continue processing other geofences when one fails (2 ms)
    Integration with External Services
      emergencyResponse
        âœ“ should trigger emergency alerts for critical geofence violations (3 ms)

PASS frontend src/backend/tests/unit/volunteer-consent.service.test.js
  VolunteerConsentService
    Consent Management
      grantConsent
        âœ“ should enable volunteer mode and start background BLE scanning (28 ms)
        âœ“ should record consent timestamp for GDPR compliance (15 ms)
        âœ“ should handle consent version updates (2 ms)
      withdrawConsent
        âœ“ should immediately disable volunteer mode and stop scanning (21 ms)
        âœ“ should cancel all queued data uploads (1 ms)
        âœ“ should purge local volunteer data immediately (1 ms)
      checkConsentStatus
        âœ“ should return consent status with version information (28 ms)
        âœ“ should detect when consent version requires update (2 ms)
    Permission Management
      Android 12+ Permissions
        âœ“ should request BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (11 ms)
        âœ“ should conditionally request location permission based on inference setting (1 ms)
        âœ“ should set neverForLocation flag when location inference disabled
      iOS Background Permissions
        âœ“ should configure bluetooth-central background mode (1 ms)
    Persistence and Recovery
      App Restart Scenarios
        âœ“ should preserve consent state across app restarts (23 ms)
        âœ“ should resume background scanning automatically after restart (3 ms)
    Error Handling
      Permission Denied Scenarios
        âœ“ should handle graceful degradation when BLE permission denied (125 ms)
        âœ“ should mark consent as pending when permissions incomplete (1 ms)
    Privacy and GDPR Compliance
      âœ“ should anonymize user identifiers in consent records (9 ms)
      âœ“ should not store IP addresses or detailed device fingerprints (1 ms)

PASS frontend src/backend/tests/unit/device-binding.service.test.js
  DeviceBindingService - RED Phase Tests
    NCC Certification Validation
      validateNCCNumber
        âœ“ should accept valid NCC format CCAMYYXX#### (12 characters) (8 ms)
        âœ“ should reject invalid NCC format - wrong prefix (142 ms)
        âœ“ should reject invalid NCC format - wrong length (35 ms)
        âœ“ should reject invalid NCC format - wrong year format (2 ms)
        âœ“ should reject invalid NCC format - invalid character patterns (2 ms)
        âœ“ should validate NCC number exists in official registry (46 ms)
      getChineseRegulatoryWarning
        âœ“ should return Chinese regulatory warning text (12 ms)
        âœ“ should include NCC logo and certification mark requirements (3 ms)
    Device Serial Number Management
      registerDevice
        âœ“ should prevent duplicate serial number registration (6 ms)
        âœ“ should allow registration of new serial number (1 ms)
        âœ“ should validate serial number format for Hsinchu devices (2 ms)
      transferDevice
        âœ“ should prevent transfer of non-existent device (61 ms)
        âœ“ should prevent unauthorized device transfer (1 ms)
    BLE Connection Management
      connectToDevice
        âœ“ should handle BLE connection failures with retry logic (27 ms)
        âœ“ should implement exponential backoff between retries (41 ms)
        âœ“ should handle different BLE error types appropriately (13 ms)
      monitorConnectionHealth
        âœ“ should detect connection drops and attempt reconnection (34 ms)
        âœ“ should track signal strength and battery level (1 ms)
    Regulatory Compliance
      displayRegulatoryInfo
        âœ“ should show complete regulatory information before device binding (2 ms)
        âœ“ should require user consent before proceeding with binding (2 ms)
        âœ“ should reject consent without proper boolean consentGiven (23 ms)
        âœ“ should prevent device binding without proper consent (1 ms)
    Device Status Management
      updateDeviceStatus
        âœ“ should track device lifecycle states (17 ms)
    Notification Integration
      deviceStatusNotifications
        âœ“ should notify users of successful device binding (23 ms)
        âœ“ should notify users of connection issues (13 ms)

PASS frontend src/backend/tests/unit/geofence-engine.test.js
  GeofenceEngine
    Boundary Events
      âœ“ should detect entry within 10m accuracy (24 ms)
      âœ“ should detect exit with 30 second delay (2 ms)
      âœ“ should track dwell time for 5+ minutes (2 ms)
      âœ“ should calculate accurate distance using Haversine formula (1 ms)
    Cooldown Logic
      âœ“ should prevent notification spam with 5 min cooldown (31 ms)
      âœ“ should handle multiple geofence priority correctly (2 ms)
      âœ“ should reset cooldown after period expires (155 ms)
    Performance
      âœ“ should handle 100+ simultaneous geofences (3 ms)
      âœ“ should implement battery-efficient monitoring (1 ms)
      âœ“ should batch process location updates efficiently (1 ms)
      âœ“ should cache geofence calculations for performance (12 ms)
    State Management
      âœ“ should persist geofence state across restarts (9 ms)
      âœ“ should clean up expired geofences (24 ms)

PASS frontend src/backend/tests/unit/retention.service.test.js
  RetentionService
    TTL-based Data Retention
      âœ“ should set appropriate TTL based on data purpose (2 ms)
      âœ“ should apply minimum retention for regulatory compliance (23 ms)
      âœ“ should reduce TTL for sensitive data without explicit consent (2 ms)
    Automated Cleanup Jobs
      âœ“ should schedule daily cleanup cron job (1 ms)
      âœ“ should cleanup expired personal data (2 ms)
      âœ“ should handle cleanup failures gracefully (13 ms)
      âœ“ should cleanup orphaned consent records (1 ms)
    Immediate Revocation
      âœ“ should immediately delete all data on revocation request (2 ms)
      âœ“ should generate deletion certificate (9 ms)
      âœ“ should notify related services of revocation (1 ms)
      âœ“ should validate revocation request authorization (52 ms)
    Retention Policies
      âœ“ should apply data minimization principle (6 ms)
      âœ“ should pseudonymize data after initial retention period (3 ms)
      âœ“ should enforce different retention periods by data category (3 ms)
    Compliance Reporting
      âœ“ should generate GDPR compliance report (3 ms)
      âœ“ should track data subject requests (4 ms)

PASS frontend src/backend/tests/unit/mydata-adapter.test.js
  MyDataAdapter Service
    OAuth Authorization Flow
      âœ“ should generate authorization URL with required parameters (2 ms)
      âœ“ should handle authorization callback and exchange code for token (1 ms)
      âœ“ should reject callback with invalid state (99 ms)
      âœ“ should handle token exchange failures (2 ms)
    Data Retrieval with Consent
      âœ“ should fetch personal data with valid access token (1 ms)
      âœ“ should handle expired token and attempt refresh (1 ms)
      âœ“ should enforce single-use token policy (33 ms)
    Data Retention and Cleanup
      âœ“ should store data with TTL based on purpose (1 ms)
      âœ“ should enforce maximum retention period
      âœ“ should automatically clean expired data (2 ms)
    Consent Revocation
      âœ“ should immediately delete data on consent revocation (1 ms)
      âœ“ should notify MyData platform of revocation (33 ms)
      âœ“ should handle cascade deletion of related data (1 ms)
      âœ“ should generate revocation receipt (2 ms)
    Audit and Compliance
      âœ“ should log all data access attempts (19 ms)
      âœ“ should generate compliance report (1 ms)
      âœ“ should validate data minimization principle (1 ms)

PASS frontend src/backend/tests/unit/revocation.service.test.js
  RevocationService
    Immediate Revocation Processing
      âœ“ should process complete revocation within 100ms (2 ms)
      âœ“ should delete data from all storage layers (1 ms)
      âœ“ should handle partial failures with rollback (146 ms)
    Audit Trail Generation
      âœ“ should create comprehensive audit trail for revocation (1 ms)
      âœ“ should include all affected data types in audit (1 ms)
      âœ“ should generate immutable revocation receipt (27 ms)
    Cascade Deletion
      âœ“ should delete all related data in correct order (2 ms)
      âœ“ should handle foreign key constraints (21 ms)
      âœ“ should notify dependent services before deletion (10 ms)
    Recovery and Rollback
      âœ“ should support revocation cancellation within grace period (1 ms)
      âœ“ should create backup before permanent deletion (1 ms)
      âœ“ should validate revocation request integrity (38 ms)
    Compliance and Verification
      âœ“ should verify complete data deletion (1 ms)
      âœ“ should detect incomplete deletion (1 ms)
      âœ“ should generate GDPR Article 17 compliance report (1 ms)

[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [32m200[0m 97.885 ms - 494[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=invalid_scope&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 8.723 ms - 158[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=invalid-url&state=random-state-string [33m400[0m 12.901 ms - 162[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m401[0m 1.551 ms - 85[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 0.545 ms - 161[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 2.600 ms - 314[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 16.018 ms - 83[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 1.005 ms - 80[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.438 ms - 150[0m
[0mPOST /api/v1/mydata/callback [33m410[0m 0.375 ms - 89[0m
[0mGET /api/v1/mydata/progress/session123 [32m200[0m 0.974 ms - 528[0m
[0mGET /api/v1/mydata/progress/nonexistent [33m404[0m 0.426 ms - 67[0m
[0mGET /api/v1/mydata/progress/session123 [33m403[0m 1.714 ms - 79[0m
[0mGET /api/v1/mydata/progress/session123?realtime=true [32m200[0m 0.514 ms - 528[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 1.608 ms - 265[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m400[0m 0.590 ms - 166[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m403[0m 1.668 ms - 88[0m
[0mDELETE /api/v1/mydata/revoke/revoked-consent [33m409[0m 2.463 ms - 81[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 6.640 ms - 264[0m
[0mGET /api/v1/mydata/consents [32m200[0m 3.411 ms - 326[0m
[0mGET /api/v1/mydata/consents?status=active [32m200[0m 1.589 ms - 326[0m
[0mGET /api/v1/mydata/consents?page=2&limit=10 [32m200[0m 1.802 ms - 130[0m
PASS frontend src/backend/tests/integration/api.mydata.test.js
  MyData API Endpoints
    GET /api/v1/mydata/authorize
      âœ“ should initiate MyData authorization flow (165 ms)
      âœ“ should validate required scopes (21 ms)
      âœ“ should validate redirect URI format (21 ms)
      âœ“ should require user authentication (93 ms)
      âœ“ should validate purpose for data access (8 ms)
    POST /api/v1/mydata/callback
      âœ“ should handle successful authorization callback (43 ms)
      âœ“ should validate authorization code (26 ms)
      âœ“ should verify state parameter for CSRF protection (10 ms)
      âœ“ should handle authorization errors from MyData platform (6 ms)
      âœ“ should validate session exists and is not expired (3 ms)
    GET /api/v1/mydata/progress/:id
      âœ“ should return authorization progress status (14 ms)
      âœ“ should return 404 for non-existent session (4 ms)
      âœ“ should enforce session ownership (9 ms)
      âœ“ should provide real-time status updates (3 ms)
    DELETE /api/v1/mydata/revoke/:id
      âœ“ should revoke data access consent successfully (6 ms)
      âœ“ should require confirmation for revocation (3 ms)
      âœ“ should validate user owns the consent (5 ms)
      âœ“ should handle already revoked consents (12 ms)
      âœ“ should initiate immediate data anonymization (45 ms)
    GET /api/v1/mydata/consents
      âœ“ should list user's active data consents (26 ms)
      âœ“ should filter consents by status (13 ms)
      âœ“ should support pagination for consent history (12 ms)

PASS frontend src/backend/tests/unit/geofence-engine-green.test.js
  GeofenceEngine
    Boundary Event Detection
      âœ“ should detect entry within 10m accuracy (2 ms)
      âœ“ should detect exit with 30 second delay (102 ms)
      âœ“ should not trigger entry if outside radius + accuracy
    Dwell Time Monitoring
      âœ“ should track dwell time after 5+ minutes (1 ms)
      âœ“ should not trigger dwell alert before 5 minutes (1 ms)
      âœ“ should reset dwell time on exit (11 ms)
    Performance & Scalability
      âœ“ should handle 100+ simultaneous geofences efficiently (3 ms)
      âœ“ should maintain stable memory with many geofences (8 ms)
      âœ“ should process batch location updates efficiently (1 ms)

[0mGET /api/v1/rbac/roles [32m200[0m 1.935 ms - -[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.311 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.350 ms - 74[0m
[0mPOST /api/v1/rbac/roles/assign [32m200[0m 2.330 ms - 167[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 1.516 ms - 87[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 1.896 ms - 125[0m
[0mPOST /api/v1/rbac/roles/assign [33m403[0m 0.369 ms - 76[0m
[0mDELETE /api/v1/rbac/roles/remove [32m200[0m 0.866 ms - 151[0m
[0mDELETE /api/v1/rbac/roles/remove [33m404[0m 0.289 ms - 64[0m
[0mGET /api/v1/rbac/permissions/validate?action=create_case&resource=cases&resourceId=case123 [32m200[0m 0.775 ms - 128[0m
[0mGET /api/v1/rbac/permissions/validate [33m400[0m 0.255 ms - 80[0m
[0mGET /api/v1/rbac/audit-trail?startDate=2023-01-01&endDate=2023-12-31&userId=user123 [32m200[0m 0.642 ms - 421[0m
[0mGET /api/v1/rbac/audit-trail?page=2&limit=10 [32m200[0m 0.365 ms - 423[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.265 ms - 125[0m
PASS frontend src/backend/tests/integration/api.rbac.test.js
  RBAC API Endpoints
    GET /api/v1/rbac/roles
      âœ“ should return all available roles with their permissions (33 ms)
      âœ“ should return 401 when no authorization header is provided (10 ms)
      âœ“ should return 403 when user lacks permission to view roles (11 ms)
    POST /api/v1/rbac/roles/assign
      âœ“ should successfully assign roles to a user (16 ms)
      âœ“ should validate required fields (9 ms)
      âœ“ should reject invalid role names (8 ms)
      âœ“ should require admin permissions for role assignment (4 ms)
    DELETE /api/v1/rbac/roles/remove
      âœ“ should successfully remove roles from a user (5 ms)
      âœ“ should validate user exists before removing roles (3 ms)
    GET /api/v1/rbac/permissions/validate
      âœ“ should validate user permissions for specific actions (4 ms)
      âœ“ should require action parameter (3 ms)
    GET /api/v1/rbac/audit-trail
      âœ“ should return audit trail for role assignments (4 ms)
      âœ“ should support pagination (4 ms)
      âœ“ should require admin permissions for audit trail access (3 ms)

PASS frontend src/backend/tests/unit/device-binding-green.test.js (6.56 s)
  DeviceBindingService
    NCC Certification Validation
      âœ“ should reject device without NCC type approval number (67 ms)
      âœ“ should reject invalid NCC certification format (2 ms)
      âœ“ should accept valid NCC certification format (1 ms)
      âœ“ should display Chinese regulatory warning for certified devices
    Serial Number Management
      âœ“ should prevent duplicate serial number registration (2 ms)
      âœ“ should validate serial number format per manufacturer spec
      âœ“ should track binding timestamp and user info (1 ms)
    BLE Connection Resilience
      âœ“ should auto-retry on connection failure (3 attempts) (3003 ms)
      âœ“ should fail gracefully after 3 connection attempts (3004 ms)
      âœ“ should implement exponential backoff for retries (6 ms)
      âœ“ should support background reconnection strategy (1 ms)
    Device State Management
      âœ“ should track device battery level
      âœ“ should alert on low battery (< 20%) (1 ms)
      âœ“ should maintain device connection history (1 ms)

PASS frontend src/backend/tests/unit/device-binding.test.js (12.563 s)
  DeviceBindingService
    NCC Certification Validation
      âœ“ should reject device without NCC type approval number (58 ms)
      âœ“ should reject invalid NCC certification format (11 ms)
      âœ“ should accept valid NCC certification format
      âœ“ should display Chinese regulatory warning for certified devices
    Serial Number Management
      âœ“ should prevent duplicate serial number registration (1 ms)
      âœ“ should validate serial number format per manufacturer spec (1 ms)
      âœ“ should track binding timestamp and user info (8 ms)
    BLE Connection Resilience
      âœ“ should auto-retry on connection failure (3 attempts) (3004 ms)
      âœ“ should fail gracefully after 3 connection attempts (3009 ms)
      âœ“ should implement exponential backoff for retries (3002 ms)
      âœ“ should support background reconnection strategy (3005 ms)
    Device State Management
      âœ“ should track device battery level
      âœ“ should alert on low battery (< 20%)
      âœ“ should maintain device connection history (1 ms)

PASS backend src/backend/tests/unit/device-binding-green.test.js (6.474 s)
  DeviceBindingService
    NCC Certification Validation
      âœ“ should reject device without NCC type approval number (54 ms)
      âœ“ should reject invalid NCC certification format (1 ms)
      âœ“ should accept valid NCC certification format
      âœ“ should display Chinese regulatory warning for certified devices (1 ms)
    Serial Number Management
      âœ“ should prevent duplicate serial number registration (3 ms)
      âœ“ should validate serial number format per manufacturer spec (1 ms)
      âœ“ should track binding timestamp and user info
    BLE Connection Resilience
      âœ“ should auto-retry on connection failure (3 attempts) (3011 ms)
      âœ“ should fail gracefully after 3 connection attempts (3002 ms)
      âœ“ should implement exponential backoff for retries (7 ms)
      âœ“ should support background reconnection strategy (1 ms)
    Device State Management
      âœ“ should track device battery level (1 ms)
      âœ“ should alert on low battery (< 20%) (1 ms)
      âœ“ should maintain device connection history (4 ms)

[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [32m200[0m 1.290 ms - 494[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=invalid_scope&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 2.162 ms - 158[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=invalid-url&state=random-state-string [33m400[0m 0.768 ms - 162[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m401[0m 0.323 ms - 85[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 0.664 ms - 161[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 0.596 ms - 314[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.414 ms - 83[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.450 ms - 80[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 3.327 ms - 150[0m
[0mPOST /api/v1/mydata/callback [33m410[0m 0.441 ms - 89[0m
[0mGET /api/v1/mydata/progress/session123 [32m200[0m 1.155 ms - 528[0m
[0mGET /api/v1/mydata/progress/nonexistent [33m404[0m 0.436 ms - 67[0m
[0mGET /api/v1/mydata/progress/session123 [33m403[0m 2.589 ms - 79[0m
[0mGET /api/v1/mydata/progress/session123?realtime=true [32m200[0m 0.570 ms - 528[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 2.793 ms - 265[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m400[0m 0.836 ms - 166[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m403[0m 1.725 ms - 88[0m
[0mDELETE /api/v1/mydata/revoke/revoked-consent [33m409[0m 0.668 ms - 81[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 0.631 ms - 264[0m
[0mGET /api/v1/mydata/consents [32m200[0m 1.378 ms - 326[0m
[0mGET /api/v1/mydata/consents?status=active [32m200[0m 0.921 ms - 326[0m
[0mGET /api/v1/mydata/consents?page=2&limit=10 [32m200[0m 1.596 ms - 130[0m
PASS backend src/backend/tests/integration/api.mydata.test.js
  MyData API Endpoints
    GET /api/v1/mydata/authorize
      âœ“ should initiate MyData authorization flow (18 ms)
      âœ“ should validate required scopes (8 ms)
      âœ“ should validate redirect URI format (5 ms)
      âœ“ should require user authentication (4 ms)
      âœ“ should validate purpose for data access (9 ms)
    POST /api/v1/mydata/callback
      âœ“ should handle successful authorization callback (11 ms)
      âœ“ should validate authorization code (4 ms)
      âœ“ should verify state parameter for CSRF protection (4 ms)
      âœ“ should handle authorization errors from MyData platform (34 ms)
      âœ“ should validate session exists and is not expired (5 ms)
    GET /api/v1/mydata/progress/:id
      âœ“ should return authorization progress status (5 ms)
      âœ“ should return 404 for non-existent session (4 ms)
      âœ“ should enforce session ownership (5 ms)
      âœ“ should provide real-time status updates (4 ms)
    DELETE /api/v1/mydata/revoke/:id
      âœ“ should revoke data access consent successfully (7 ms)
      âœ“ should require confirmation for revocation (6 ms)
      âœ“ should validate user owns the consent (6 ms)
      âœ“ should handle already revoked consents (4 ms)
      âœ“ should initiate immediate data anonymization (8 ms)
    GET /api/v1/mydata/consents
      âœ“ should list user's active data consents (8 ms)
      âœ“ should filter consents by status (4 ms)
      âœ“ should support pagination for consent history (6 ms)

PASS backend src/backend/tests/unit/case-flow.service.test.js
  æ¡ˆä»¶æµç¨‹æœå‹™ (CaseFlowService)
    1. æ¡ˆä»¶å»ºç«‹ (Case Creation)
      createCase()
        âœ“ æ‡‰è©²æˆåŠŸå»ºç«‹å¤±è¹¤äººå“¡æ¡ˆä»¶ (17 ms)
        âœ“ æ‡‰è©²ç‚ºç·Šæ€¥æ¡ˆä»¶è‡ªå‹•è¨­å®šæœ€é«˜å„ªå…ˆç´š (29 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„æ¡ˆä»¶å»ºç«‹çš„ç¨½æ ¸æ—¥èªŒ (4 ms)
        âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„æ¡ˆä»¶è³‡æ–™ (147 ms)
        âœ“ æ‡‰è©²ç‚ºä¸åŒé¡å‹æ¡ˆä»¶è¨­å®šé©ç•¶çš„é è¨­å€¼ (4 ms)
      æ¡ˆä»¶ç·¨è™Ÿç”Ÿæˆ
        âœ“ æ‡‰è©²ç”Ÿæˆå”¯ä¸€çš„æ¡ˆä»¶ç·¨è™Ÿ (26 ms)
        âœ“ æ‡‰è©²åŒ…å«æ—¥æœŸå’Œåºè™Ÿçš„æ¡ˆä»¶ç·¨è™Ÿ (4 ms)
    2. ç‹€æ…‹è½‰æ› (State Transitions)
      assignCase()
        âœ“ æ‡‰è©²å°‡æ¡ˆä»¶å¾å»ºç«‹ç‹€æ…‹è½‰ç‚ºæ´¾ç™¼ç‹€æ…‹ (23 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„ç‹€æ…‹è½‰æ›æ­·å² (4 ms)
        âœ“ æ‡‰è©²é€šçŸ¥ç›¸é—œäººå“¡æ¡ˆä»¶æ´¾ç™¼ (19 ms)
        âœ“ æ‡‰è©²æ‹’çµ•æ´¾ç™¼å·²çµæ¡ˆçš„æ¡ˆä»¶ (10 ms)
      updateCaseStatus()
        âœ“ æ‡‰è©²å…è¨±æœ‰æ•ˆçš„ç‹€æ…‹è½‰æ› (3 ms)
        âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„ç‹€æ…‹è½‰æ› (4 ms)
        âœ“ æ‡‰è©²è¨˜éŒ„æ¯æ¬¡ç‹€æ…‹æ›´æ–° (4 ms)
      closeCase()
        âœ“ æ‡‰è©²æˆåŠŸçµæ¡ˆä¸¦è¨­å®šçµæ¡ˆåŸå›  (4 ms)
        âœ“ æ‡‰è©²è§¸ç™¼è³‡æ–™æ¸…ç†æµç¨‹ (3 ms)
    3. å¤šæ©Ÿé—œå”èª¿ (Multi-Agency Coordination)
      assignMultipleAgencies()
        âœ“ æ‡‰è©²åŒæ™‚æ´¾ç™¼çµ¦è­¦å¯Ÿã€æ¶ˆé˜²ã€é†«ç™‚å–®ä½ (25 ms)
        âœ“ æ‡‰è©²å»ºç«‹æ©Ÿé—œé–“é€šè¨Šé »é“ (3 ms)
        âœ“ æ‡‰è©²è¨­å®šæ©Ÿé—œå”èª¿æœƒè­°æ™‚é–“ (4 ms)
      updateAgencyStatus()
        âœ“ æ‡‰è©²æ›´æ–°å€‹åˆ¥æ©Ÿé—œçš„è™•ç†ç‹€æ…‹ (3 ms)
        âœ“ æ‡‰è©²è‡ªå‹•è¨ˆç®—æ•´é«”æ¡ˆä»¶é€²åº¦ (64 ms)
    4. å³æ™‚ç‹€æ…‹æ›´æ–°èˆ‡é€šçŸ¥ (Real-time Updates)
      broadcastCaseUpdate()
        âœ“ æ‡‰è©²å‘æ‰€æœ‰ç›¸é—œäººå“¡å»£æ’­æ¡ˆä»¶æ›´æ–° (20 ms)
        âœ“ æ‡‰è©²æ”¯æ´ç·Šæ€¥å»£æ’­æ¨¡å¼ (4 ms)
      subscribeToUpdates()
        âœ“ æ‡‰è©²å…è¨±ç”¨æˆ¶è¨‚é–±æ¡ˆä»¶æ›´æ–° (43 ms)
        âœ“ æ‡‰è©²æ”¯æ´å³æ™‚ WebSocket æ¨é€ (4 ms)
    5. æ¡ˆä»¶å‡ç´šæ©Ÿåˆ¶ (Case Escalation)
      escalateCase()
        âœ“ æ‡‰è©²æ ¹æ“šæ™‚é–“è‡ªå‹•å‡ç´šæ¡ˆä»¶ (27 ms)
        âœ“ æ‡‰è©²æ ¹æ“šåš´é‡ç¨‹åº¦å‡ç´šæ¡ˆä»¶ (26 ms)
        âœ“ æ‡‰è©²è‡ªå‹•åˆ†é…é¡å¤–è³‡æº (4 ms)
      escalationTriggers
        âœ“ æ‡‰è©²åœ¨å¤±è¹¤å…’ç«¥æ¡ˆä»¶è‡ªå‹•å‡ç´š (296 ms)
        âœ“ æ‡‰è©²åœ¨å¤šäººå¤±è¹¤æ¡ˆä»¶è‡ªå‹•å‡ç´š (3 ms)
    6. æœå°‹å€åŸŸç®¡ç† (Search Area Management)
      defineSearchArea()
        âœ“ æ‡‰è©²å»ºç«‹æœå°‹å€åŸŸä¸¦åˆ†é…æœå°‹éšŠ (2 ms)
        âœ“ æ‡‰è©²æ ¹æ“šåœ°å½¢è‡ªå‹•åˆ†é…é©ç•¶çš„æœå°‹éšŠ (19 ms)
        âœ“ æ‡‰è©²è¨ˆç®—æœå°‹æ™‚é–“é ä¼° (2 ms)
      assignZoneToTeam()
        âœ“ æ‡‰è©²åˆ†é…æœå°‹å€åŸŸçµ¦ç‰¹å®šéšŠä¼ (12 ms)
        âœ“ æ‡‰è©²è¿½è¹¤æœå°‹é€²åº¦ (2 ms)
    7. å¿—å·¥æ´¾é£å”èª¿ (Volunteer Dispatch)
      requestVolunteers()
        âœ“ æ‡‰è©²æ ¹æ“šéœ€æ±‚è«‹æ±‚å¿—å·¥æ”¯æ´ (25 ms)
        âœ“ æ‡‰è©²é€šçŸ¥åˆæ ¼çš„å¿—å·¥ (3 ms)
        âœ“ æ‡‰è©²ç®¡ç†å¿—å·¥å ±åˆ°å’Œåˆ†çµ„ (7 ms)
      manageVolunteerSafety()
        âœ“ æ‡‰è©²è¿½è¹¤å¿—å·¥å®‰å…¨ç‹€æ…‹ (17 ms)
        âœ“ æ‡‰è©²åœ¨å¿—å·¥å¤±è¯æ™‚ç™¼å‡ºè­¦å‘Š (3 ms)
    8. æ¡ˆä»¶è§£æ±ºèˆ‡çµæ¡ˆæµç¨‹ (Case Resolution)
      resolveCase()
        âœ“ æ‡‰è©²è¨˜éŒ„æ¡ˆä»¶è§£æ±ºè©³æƒ… (20 ms)
        âœ“ æ‡‰è©²ç”Ÿæˆæ¡ˆä»¶æ‘˜è¦å ±å‘Š (27 ms)
        âœ“ æ‡‰è©²è§¸ç™¼å¾ŒçºŒè™•ç†æµç¨‹ (13 ms)
      æ¡ˆä»¶é—œé–‰å¾Œè™•ç†
        âœ“ æ‡‰è©²å®‰æ’è³‡æ–™ä¿ç•™å’Œæ¸…ç† (3 ms)
        âœ“ æ‡‰è©²æ›´æ–°ç›¸é—œçµ±è¨ˆå’ŒKPI (12 ms)
    9. æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤ (Performance Metrics)
      trackResponseTime()
        âœ“ æ‡‰è©²è¨˜éŒ„å„éšæ®µéŸ¿æ‡‰æ™‚é–“ (21 ms)
        âœ“ æ‡‰è©²è¨ˆç®—å¹³å‡éŸ¿æ‡‰æ™‚é–“ (3 ms)
      trackResourceUtilization()
        âœ“ æ‡‰è©²è¿½è¹¤è³‡æºä½¿ç”¨æ•ˆç‡ (2 ms)
      generatePerformanceReport()
        âœ“ æ‡‰è©²ç”Ÿæˆæ•ˆèƒ½åˆ†æå ±å‘Š (14 ms)
    10. ç­åˆ¥äº¤æ¥ (Shift Handoff)
      prepareShiftHandoff()
        âœ“ æ‡‰è©²æº–å‚™ç­åˆ¥äº¤æ¥è³‡æ–™ (3 ms)
        âœ“ æ‡‰è©²æ¨™è­˜éœ€è¦ç‰¹åˆ¥é—œæ³¨çš„æ¡ˆä»¶ (31 ms)
        âœ“ æ‡‰è©²ç”Ÿæˆäº¤æ¥æª¢æŸ¥æ¸…å–® (2 ms)
      executeShiftHandoff()
        âœ“ æ‡‰è©²åŸ·è¡Œç­åˆ¥äº¤æ¥ä¸¦è¨˜éŒ„ç¢ºèª (3 ms)
        âœ“ æ‡‰è©²æ›´æ–°æ¡ˆä»¶è² è²¬äºº (33 ms)
    11. ç·Šæ€¥å‡ç´šè§¸ç™¼å™¨ (Emergency Escalation Triggers)
      automaticEscalationTriggers
        âœ“ æ‡‰è©²åœ¨å…’ç«¥å¤±è¹¤æ™‚ç«‹å³è§¸ç™¼æœ€é«˜ç´šåˆ¥è­¦å ± (3 ms)
        âœ“ æ‡‰è©²åœ¨å¤§é‡å‚·äº¡äº‹ä»¶æ™‚å•Ÿå‹•ç½å®³æ‡‰è®Šæ©Ÿåˆ¶ (3 ms)
        âœ“ æ‡‰è©²åœ¨ææ€–æ”»æ“Šç–‘æ…®æ™‚å•Ÿå‹•åææ©Ÿåˆ¶ (12 ms)
      escalationChain
        âœ“ æ‡‰è©²ä¾åºé€šçŸ¥å‡ç´šéˆä¸­çš„ç›¸é—œäººå“¡ (3 ms)
        âœ“ æ‡‰è©²åœ¨é€£çºŒå‡ç´šå¾Œå•Ÿå‹•æŒ‡æ®å®˜ç´šåˆ¥éŸ¿æ‡‰ (2 ms)
      publicSafetyTriggers
        âœ“ æ‡‰è©²åœ¨å…¬å…±å®‰å…¨å¨è„…æ™‚ç™¼å¸ƒç·Šæ€¥è­¦å ± (3 ms)
        âœ“ æ‡‰è©²å”èª¿å¤šæ©Ÿé—œç·Šæ€¥æ‡‰è®Š (34 ms)
    éŒ¯èª¤è™•ç†å’Œé‚Šç·£æ¡ˆä¾‹ (Error Handling & Edge Cases)
      âœ“ æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„æ¡ˆä»¶é¡å‹ (15 ms)
      âœ“ æ‡‰è©²è™•ç†ä¸¦ç™¼æ¡ˆä»¶å»ºç«‹ (2 ms)
      âœ“ æ‡‰è©²è™•ç†ç³»çµ±è³‡æºä¸è¶³çš„æƒ…æ³ (2 ms)
      âœ“ æ‡‰è©²åœ¨æ¬Šé™ä¸è¶³æ™‚æ‹’çµ•æ“ä½œ (15 ms)

[0mGET /api/v1/rbac/roles [32m200[0m 1.280 ms - -[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.319 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.468 ms - 74[0m
[0mPOST /api/v1/rbac/roles/assign [32m200[0m 1.177 ms - 167[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 0.455 ms - 87[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 0.561 ms - 125[0m
[0mPOST /api/v1/rbac/roles/assign [33m403[0m 0.332 ms - 76[0m
[0mDELETE /api/v1/rbac/roles/remove [32m200[0m 1.015 ms - 151[0m
[0mDELETE /api/v1/rbac/roles/remove [33m404[0m 0.477 ms - 64[0m
[0mGET /api/v1/rbac/permissions/validate?action=create_case&resource=cases&resourceId=case123 [32m200[0m 0.731 ms - 128[0m
[0mGET /api/v1/rbac/permissions/validate [33m400[0m 0.396 ms - 80[0m
[0mGET /api/v1/rbac/audit-trail?startDate=2023-01-01&endDate=2023-12-31&userId=user123 [32m200[0m 0.800 ms - 421[0m
[0mGET /api/v1/rbac/audit-trail?page=2&limit=10 [32m200[0m 0.522 ms - 423[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.347 ms - 125[0m
PASS backend src/backend/tests/integration/api.rbac.test.js
  RBAC API Endpoints
    GET /api/v1/rbac/roles
      âœ“ should return all available roles with their permissions (59 ms)
      âœ“ should return 401 when no authorization header is provided (5 ms)
      âœ“ should return 403 when user lacks permission to view roles (5 ms)
    POST /api/v1/rbac/roles/assign
      âœ“ should successfully assign roles to a user (8 ms)
      âœ“ should validate required fields (5 ms)
      âœ“ should reject invalid role names (4 ms)
      âœ“ should require admin permissions for role assignment (4 ms)
    DELETE /api/v1/rbac/roles/remove
      âœ“ should successfully remove roles from a user (5 ms)
      âœ“ should validate user exists before removing roles (4 ms)
    GET /api/v1/rbac/permissions/validate
      âœ“ should validate user permissions for specific actions (5 ms)
      âœ“ should require action parameter (3 ms)
    GET /api/v1/rbac/audit-trail
      âœ“ should return audit trail for role assignments (5 ms)
      âœ“ should support pagination (4 ms)
      âœ“ should require admin permissions for audit trail access (4 ms)

PASS backend src/backend/tests/unit/device-binding.test.js (12.143 s)
  DeviceBindingService
    NCC Certification Validation
      âœ“ should reject device without NCC type approval number (25 ms)
      âœ“ should reject invalid NCC certification format (1 ms)
      âœ“ should accept valid NCC certification format (1 ms)
      âœ“ should display Chinese regulatory warning for certified devices (1 ms)
    Serial Number Management
      âœ“ should prevent duplicate serial number registration
      âœ“ should validate serial number format per manufacturer spec (2 ms)
      âœ“ should track binding timestamp and user info (1 ms)
    BLE Connection Resilience
      âœ“ should auto-retry on connection failure (3 attempts) (3004 ms)
      âœ“ should fail gracefully after 3 connection attempts (3004 ms)
      âœ“ should implement exponential backoff for retries (3008 ms)
      âœ“ should support background reconnection strategy (3004 ms)
    Device State Management
      âœ“ should track device battery level
      âœ“ should alert on low battery (< 20%)
      âœ“ should maintain device connection history (1 ms)

PASS frontend tests/guardian.test.js
  å®‰å¿ƒå®ˆè­·é é¢æ¬Šé™æ¸¬è©¦
    æœªç™»å…¥ç”¨æˆ¶
      âœ“ é¡¯ç¤ºè«‹å…ˆç™»å…¥æç¤º (260 ms)
    ä¸€èˆ¬æœƒå“¡
      âœ“ å¯ä»¥çœ‹åˆ°ä¸‰å€‹åˆ†é  (28 ms)
      âœ“ å®¶å±¬åˆ†é é¡¯ç¤ºéœ€è¦å¯¦åé©—è­‰ (35 ms)
      âœ“ å¿—å·¥åˆ†é é¡¯ç¤ºéœ€è¦å¯¦åé©—è­‰ (66 ms)
      âœ“ ç”³è¾¦åˆ†é å¯æŸ¥çœ‹ä½†ä¸èƒ½ç”³è¾¦ (43 ms)
    å¯¦åæœƒå“¡
      âœ“ å®¶å±¬åˆ†é é¡¯ç¤ºå®Œæ•´åŠŸèƒ½ (41 ms)
      âœ“ ç„¡ç¶å®šæ™‚é¡¯ç¤ºç¶å®šæç¤º (15 ms)
      âœ“ å¿—å·¥åˆ†é å¯æ¥å—ä»»å‹™ (10 ms)
      âœ“ ç”³è¾¦åˆ†é å¯æäº¤ç”³è«‹ (26 ms)
    æ‰¿è¾¦äººå“¡
      âœ“ é¡¯ç¤ºç®¡ç†åŠŸèƒ½ (32 ms)
      âœ“ å®¶å±¬åˆ†é é¡¯ç¤ºé¡å¤–ç®¡ç†åŠŸèƒ½ (12 ms)
  å°èˆªåŠŸèƒ½æ¸¬è©¦
    âœ“ URLæ›´æ–°ç‚ºå°æ‡‰åˆ†é è·¯å¾‘ (22 ms)
  é€šçŸ¥å¾½ç« æ¸¬è©¦
    âœ“ å¿—å·¥åˆ†é é¡¯ç¤ºé€šçŸ¥æ•¸å­— (19 ms)

[0mGET /api/v1/kpi/dashboard [32m200[0m 5.527 ms - 892[0m
[0mGET /api/v1/kpi/dashboard?startDate=2023-01-01&endDate=2023-12-31 [32m200[0m 1.826 ms - 892[0m
[0mGET /api/v1/kpi/dashboard [33m403[0m 1.407 ms - 94[0m
[0mGET /api/v1/kpi/dashboard?useCache=true [32m200[0m 1.677 ms - 892[0m
[0mGET /api/v1/kpi/metrics/cases [32m200[0m 2.182 ms - 624[0m
[0mGET /api/v1/kpi/metrics/volunteers [32m200[0m 1.877 ms - 665[0m
[0mGET /api/v1/kpi/metrics/system [32m200[0m 0.494 ms - 582[0m
[0mGET /api/v1/kpi/metrics/compliance [32m200[0m 1.956 ms - 519[0m
[0mGET /api/v1/kpi/metrics/invalid-type [33m400[0m 1.552 ms - 131[0m
[0mGET /api/v1/kpi/metrics/cases?startDate=2023-01-01&endDate=2023-01-31&granularity=daily [32m200[0m 1.628 ms - 624[0m
[0mGET /api/v1/kpi/metrics/cases?aggregation=weekly&region=%E6%96%B0%E7%AB%B9%E5%B8%82%E6%9D%B1%E5%8D%80 [32m200[0m 2.060 ms - 624[0m
[0mGET /api/v1/kpi/reports/compliance [32m200[0m 2.027 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?format=pdf [32m200[0m 0.594 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?period=monthly&year=2023&month=10 [32m200[0m 0.429 ms - 994[0m
[0mGET /api/v1/kpi/reports/compliance?includeRegulatory=true [32m200[0m 0.520 ms - -[0m
[0mGET /api/v1/kpi/reports/compliance [33m403[0m 2.619 ms - 99[0m
[0mGET /api/v1/kpi/alerts [32m200[0m 4.317 ms - 745[0m
[0mGET /api/v1/kpi/alerts?severity=critical [32m200[0m 7.788 ms - 100[0m
PASS backend src/backend/tests/unit/rbac.service.test.js
  RBACService - è§’è‰²æ¬Šé™æ§åˆ¶æœå‹™
    1. Role-Based Access Control (åŸºæœ¬è§’è‰²æ§åˆ¶)
      Role Definitions
        âœ“ should define Viewer role with read-only permissions (2 ms)
        âœ“ should define Operator role with case management permissions (2 ms)
        âœ“ should define Admin role with full system permissions (1 ms)
        âœ“ should reject invalid role types (213 ms)
      User Role Assignment
        âœ“ should assign single role to user (9 ms)
        âœ“ should assign multiple roles to user (1 ms)
        âœ“ should prevent role escalation without proper authorization (1 ms)
    2. Permission Validation (æ¬Šé™é©—è­‰)
      Sensitive Operations
        âœ“ should validate permission for case deletion (1 ms)
        âœ“ should deny permission for unauthorized export operations (14 ms)
        âœ“ should validate emergency override permissions (1 ms)
      Resource-Specific Permissions
        âœ“ should validate department-specific case access (1 ms)
        âœ“ should deny cross-department case access
    3. Field-Level Visibility Control (æ¬„ä½ç´šå¯è¦‹æ€§æ§åˆ¶)
      PII Protection
        âœ“ should hide PII fields from Viewer role (1 ms)
        âœ“ should show limited PII to Operator role (1 ms)
        âœ“ should show full PII to Admin role (1 ms)
        âœ“ should apply custom masking rules for healthcare data (1 ms)
    4. Multi-Tenant Support (å¤šç§Ÿæˆ¶æ”¯æ´)
      Tenant Isolation
        âœ“ should isolate data between different county governments (1 ms)
        âœ“ should prevent cross-tenant data access (1 ms)
        âœ“ should support super-admin cross-tenant access
    5. Session Management with Role Context (è§’è‰²ä¸Šä¸‹æ–‡æœƒè©±ç®¡ç†)
      Session Creation
        âœ“ should create session with role context (1 ms)
        âœ“ should set appropriate session timeout based on role (13 ms)
      Session Validation
        âœ“ should validate active session with current permissions
        âœ“ should invalidate expired sessions (1 ms)
      Role Context Updates
        âœ“ should update session when user roles change (1 ms)
    6. Audit Trail for Permission Changes (æ¬Šé™è®Šæ›´ç¨½æ ¸è»Œè·¡)
      Permission Change Logging
        âœ“ should log role assignment with full context
        âœ“ should log role removal with approval chain (1 ms)
        âœ“ should create immutable audit records (1 ms)
      Audit Query and Review
        âœ“ should query audit trail with proper filtering (1 ms)
        âœ“ should detect audit trail tampering (1 ms)
    7. Bulk Role Assignments (æ‰¹é‡è§’è‰²æŒ‡æ´¾)
      Department-wide Assignments
        âœ“ should assign roles to entire department (1 ms)
        âœ“ should handle partial failures in bulk assignment (1 ms)
        âœ“ should validate bulk assignment permissions (9 ms)
      CSV Import Role Assignment
        âœ“ should process CSV role assignment file (1 ms)
        âœ“ should validate CSV format and reject invalid entries (3 ms)
    8. Time-Based Access Controls (æ™‚é–“åŸºç¤å­˜å–æ§åˆ¶)
      Scheduled Access
        âœ“ should grant access during business hours (27 ms)
        âœ“ should deny access outside business hours (1 ms)
        âœ“ should handle emergency override for time restrictions (3 ms)
      Temporary Access Grants
        âœ“ should grant temporary elevated access (1 ms)
        âœ“ should automatically revoke expired temporary access (6 ms)
    9. Resource-Specific Permissions (è³‡æºç‰¹å®šæ¬Šé™)
      Healthcare Data Access
        âœ“ should validate medical record access permissions (1 ms)
        âœ“ should deny medical access without proper license
      Location-Based Access
        âœ“ should validate geographic boundary access (1 ms)
        âœ“ should deny access to out-of-jurisdiction resources (6 ms)
    10. Security Event Logging (å®‰å…¨äº‹ä»¶è¨˜éŒ„)
      Suspicious Activity Detection
        âœ“ should detect and log multiple failed access attempts (1 ms)
        âœ“ should log privilege escalation attempts (1 ms)
      Compliance Reporting
        âœ“ should generate GDPR compliance report
        âœ“ should generate Taiwan Personal Data Protection Act report (2 ms)
      Real-time Security Monitoring
        âœ“ should trigger real-time alerts for critical events (10 ms)
        âœ“ should implement circuit breaker for repeated violations (1 ms)
    Integration with Taiwan Healthcare Regulations
      âœ“ should implement NHI data access controls (1 ms)
      âœ“ should comply with MOHW data retention policies

[0mGET /api/v1/kpi/alerts?type=performance [32m200[0m 0.525 ms - 318[0m
[0mPOST /api/v1/kpi/reports/generate [32m202[0m 3.080 ms - 173[0m
[0mPOST /api/v1/kpi/reports/generate [33m400[0m 2.739 ms - 92[0m
[0mPOST /api/v1/kpi/reports/generate [33m403[0m 0.468 ms - 98[0m
PASS backend src/backend/tests/unit/kpi.service.test.js
  KPI æœå‹™ (KPI Service)
    å³æ™‚ KPI è¨ˆç®—èˆ‡èšåˆ (Real-time KPI Calculation)
      âœ“ æ‡‰è¨ˆç®—æ¡ˆä»¶è™•ç†å³æ™‚çµ±è¨ˆ (2 ms)
      âœ“ æ‡‰èšåˆå¤šå€‹åœ°ç†å€åŸŸçš„ KPI (1 ms)
      âœ“ æ‡‰è¨ˆç®—åˆ†æ™‚æ®µçš„ KPI è¶¨å‹¢ (1 ms)
      âœ“ æ‡‰æ”¯æ´å³æ™‚ KPI æ›´æ–°æ¨é€ (1 ms)
      âœ“ æ‡‰è™•ç†å¤§é‡ä¸¦ç™¼çš„ KPI è¨ˆç®—è«‹æ±‚ (1 ms)
    æ¡ˆä»¶è§£æ±ºæŒ‡æ¨™ (Case Resolution Metrics)
      âœ“ æ‡‰è¨ˆç®—å¹³å‡æ¡ˆä»¶å›æ‡‰æ™‚é–“ (19 ms)
      âœ“ æ‡‰è¨ˆç®—æ¡ˆä»¶æˆåŠŸè§£æ±ºç‡ (1 ms)
      âœ“ æ‡‰è¿½è¹¤æ¡ˆä»¶å‡ç´šå’Œé™ç´šæ¨¡å¼ (1 ms)
      âœ“ æ‡‰è¨ˆç®—ä¸åŒå„ªå…ˆç´šæ¡ˆä»¶çš„ SLA é”æˆç‡ (18 ms)
      âœ“ æ‡‰åˆ†ææ¡ˆä»¶é‡æ–°é–‹å•Ÿç‡ (1 ms)
    å¿—å·¥ç¸¾æ•ˆæŒ‡æ¨™ (Volunteer Performance Metrics)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥æ´»èºåº¦æŒ‡æ¨™ (1 ms)
      âœ“ æ‡‰è¿½è¹¤å¿—å·¥å›æ‡‰æ™‚é–“ (1 ms)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥æ»¿æ„åº¦è©•åˆ† (1 ms)
      âœ“ æ‡‰åˆ†æå¿—å·¥åŸ¹è¨“å®Œæˆç‡ (1 ms)
      âœ“ æ‡‰è¿½è¹¤å¿—å·¥ç•™ä»»ç‡ (1 ms)
      âœ“ æ‡‰è¨ˆç®—å¿—å·¥å·¥ä½œè² è·åˆ†ä½ˆ (1 ms)
    ç³»çµ±æ•ˆèƒ½æŒ‡æ¨™ (System Performance Indicators)
      âœ“ æ‡‰ç›£æ§ API å›æ‡‰æ™‚é–“ (13 ms)
      âœ“ æ‡‰è¿½è¹¤è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½ (9 ms)
      âœ“ æ‡‰ç›£æ§ç³»çµ±è¨˜æ†¶é«”ä½¿ç”¨ç‡ (1 ms)
      âœ“ æ‡‰è¿½è¹¤åŒæ™‚é€£ç·šä½¿ç”¨è€…æ•¸é‡ (1 ms)
      âœ“ æ‡‰ç›£æ§å„²å­˜ç©ºé–“ä½¿ç”¨æƒ…æ³ (1 ms)
    è¶¨å‹¢åˆ†æèˆ‡é æ¸¬ (Trend Analysis and Forecasting)
      âœ“ æ‡‰åˆ†ææ¡ˆä»¶æ•¸é‡è¶¨å‹¢ (1 ms)
      âœ“ æ‡‰é æ¸¬å¿—å·¥éœ€æ±‚ (1 ms)
      âœ“ æ‡‰æª¢æ¸¬ KPI ç•°å¸¸æ¨¡å¼ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿå­£ç¯€æ€§è¶¨å‹¢å ±å‘Š (1 ms)
      âœ“ æ‡‰è¨ˆç®— KPI è®ŠåŒ–ç‡å’Œæˆé•·ç‡ (1 ms)
    è­¦å ±é–¾å€¼èˆ‡é€šçŸ¥ (Alert Thresholds and Notifications)
      âœ“ æ‡‰è¨­å®šå’Œç®¡ç† KPI è­¦å ±é–¾å€¼ (1 ms)
      âœ“ æ‡‰æª¢æŸ¥ KPI å€¼æ˜¯å¦è¶…éé–¾å€¼ (20 ms)
      âœ“ æ‡‰ç™¼é€é–¾å€¼çªç ´è­¦å ± (1 ms)
      âœ“ æ‡‰ç®¡ç†è­¦å ±å‡ç´šæ©Ÿåˆ¶ (1 ms)
      âœ“ æ‡‰æ”¯æ´æ™ºæ…§å‹è­¦å ±é »ç‡æ§åˆ¶ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿè­¦å ±çµ±è¨ˆå ±å‘Š
    å„€è¡¨æ¿è³‡æ–™æº–å‚™ (Dashboard Data Preparation)
      âœ“ æ‡‰æº–å‚™å³æ™‚å„€è¡¨æ¿è³‡æ–™ (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿæ­·å²è¶¨å‹¢åœ–è¡¨è³‡æ–™ (17 ms)
      âœ“ æ‡‰ç”¢ç”Ÿåœ°ç†åˆ†ä½ˆç†±é»åœ–è³‡æ–™ (9 ms)
      âœ“ æ‡‰ç”¢ç”Ÿ KPI æ¯”è¼ƒè¡¨æ ¼è³‡æ–™ (1 ms)
      âœ“ æ‡‰æ”¯æ´å„€è¡¨æ¿è³‡æ–™çš„å¿«å–æ©Ÿåˆ¶ (1 ms)
    è‡ªè¨‚ KPI å®šç¾© (Custom KPI Definitions)
      âœ“ æ‡‰å…è¨±å»ºç«‹è‡ªè¨‚ KPI æŒ‡æ¨™ (1 ms)
      âœ“ æ‡‰é©—è­‰è‡ªè¨‚ KPI å…¬å¼çš„æ­£ç¢ºæ€§ (1 ms)
      âœ“ æ‡‰è¨ˆç®—è‡ªè¨‚ KPI çš„æ•¸å€¼ (1 ms)
      âœ“ æ‡‰æ”¯æ´æ¢ä»¶å¼ KPI è¨ˆç®— (1 ms)
      âœ“ æ‡‰ç®¡ç† KPI è¨ˆç®—æ’ç¨‹ (1 ms)
      âœ“ æ‡‰æä¾› KPI è¨ˆç®—æ­·å²è¨˜éŒ„ (1 ms)
      âœ“ æ‡‰æ”¯æ´ KPI çš„ç‰ˆæœ¬ç®¡ç† (1 ms)
      âœ“ æ‡‰é©—è­‰ KPI æ•¸æ“šå“è³ª (1 ms)
    éŒ¯èª¤è™•ç† (Error Handling)
      âœ“ æ‡‰åœ¨ KPI è¨ˆç®—å¤±æ•—æ™‚æ‹‹å‡ºè¨ˆç®—éŒ¯èª¤ (162 ms)
      âœ“ æ‡‰åœ¨é–¾å€¼è¨­å®šç„¡æ•ˆæ™‚æ‹‹å‡ºé–¾å€¼éŒ¯èª¤ (1 ms)
      âœ“ æ‡‰åœ¨æŸ¥è©¢åƒæ•¸ç„¡æ•ˆæ™‚æ‹‹å‡ºé©—è­‰éŒ¯èª¤ (1 ms)
      âœ“ æ‡‰å„ªé›…è™•ç†è³‡æ–™ä¾†æºé€£ç·šå¤±æ•— (1 ms)

PASS frontend src/backend/tests/integration/api.kpi.test.js
  KPI API Endpoints
    GET /api/v1/kpi/dashboard
      âœ“ should return comprehensive dashboard metrics (37 ms)
      âœ“ should support time range filtering (21 ms)
      âœ“ should require admin permissions (9 ms)
      âœ“ should return cached data when available (9 ms)
    GET /api/v1/kpi/metrics/:type
      âœ“ should return case management metrics (12 ms)
      âœ“ should return volunteer performance metrics (27 ms)
      âœ“ should return system performance metrics (9 ms)
      âœ“ should return compliance metrics (14 ms)
      âœ“ should validate metric type parameter (8 ms)
      âœ“ should support custom date ranges (10 ms)
      âœ“ should support different aggregation levels (12 ms)
    GET /api/v1/kpi/reports/compliance
      âœ“ should generate comprehensive compliance report (15 ms)
      âœ“ should support different report formats (14 ms)
      âœ“ should generate monthly compliance reports (11 ms)
      âœ“ should include regulatory compliance details (37 ms)
      âœ“ should require appropriate permissions for compliance reports (13 ms)
    GET /api/v1/kpi/alerts
      âœ“ should return active system alerts (41 ms)
      âœ“ should filter alerts by severity (22 ms)
      âœ“ should filter alerts by type (18 ms)
    POST /api/v1/kpi/reports/generate
      âœ“ should generate custom reports (29 ms)
      âœ“ should validate report parameters (13 ms)
      âœ“ should require admin permissions for report generation (15 ms)

PASS backend src/backend/tests/unit/device-binding.service.test.js
  DeviceBindingService - RED Phase Tests
    NCC Certification Validation
      validateNCCNumber
        âœ“ should accept valid NCC format CCAMYYXX#### (12 characters) (28 ms)
        âœ“ should reject invalid NCC format - wrong prefix (72 ms)
        âœ“ should reject invalid NCC format - wrong length (19 ms)
        âœ“ should reject invalid NCC format - wrong year format (2 ms)
        âœ“ should reject invalid NCC format - invalid character patterns (2 ms)
        âœ“ should validate NCC number exists in official registry (20 ms)
      getChineseRegulatoryWarning
        âœ“ should return Chinese regulatory warning text (1 ms)
        âœ“ should include NCC logo and certification mark requirements (9 ms)
    Device Serial Number Management
      registerDevice
        âœ“ should prevent duplicate serial number registration (2 ms)
        âœ“ should allow registration of new serial number (1 ms)
        âœ“ should validate serial number format for Hsinchu devices (18 ms)
      transferDevice
        âœ“ should prevent transfer of non-existent device (1 ms)
        âœ“ should prevent unauthorized device transfer (1 ms)
    BLE Connection Management
      connectToDevice
        âœ“ should handle BLE connection failures with retry logic (3 ms)
        âœ“ should implement exponential backoff between retries (2 ms)
        âœ“ should handle different BLE error types appropriately (4 ms)
      monitorConnectionHealth
        âœ“ should detect connection drops and attempt reconnection (4 ms)
        âœ“ should track signal strength and battery level (1 ms)
    Regulatory Compliance
      displayRegulatoryInfo
        âœ“ should show complete regulatory information before device binding (2 ms)
        âœ“ should require user consent before proceeding with binding (1 ms)
        âœ“ should reject consent without proper boolean consentGiven (1 ms)
        âœ“ should prevent device binding without proper consent (1 ms)
    Device Status Management
      updateDeviceStatus
        âœ“ should track device lifecycle states (2 ms)
    Notification Integration
      deviceStatusNotifications
        âœ“ should notify users of successful device binding (1 ms)
        âœ“ should notify users of connection issues (1 ms)

PASS backend src/backend/tests/unit/geofence-engine-green.test.js
  GeofenceEngine
    Boundary Event Detection
      âœ“ should detect entry within 10m accuracy (5 ms)
      âœ“ should detect exit with 30 second delay (103 ms)
      âœ“ should not trigger entry if outside radius + accuracy
    Dwell Time Monitoring
      âœ“ should track dwell time after 5+ minutes (1 ms)
      âœ“ should not trigger dwell alert before 5 minutes
      âœ“ should reset dwell time on exit (11 ms)
    Performance & Scalability
      âœ“ should handle 100+ simultaneous geofences efficiently (2 ms)
      âœ“ should maintain stable memory with many geofences (5 ms)
      âœ“ should process batch location updates efficiently (1 ms)

PASS backend src/backend/tests/unit/geofence-engine.service.test.js
  GeofenceEngine - RED Phase Tests
    Boundary Detection with 10m Accuracy
      detectEntry
        âœ“ should detect entry within 10m accuracy threshold (38 ms)
        âœ“ should not detect entry when GPS accuracy exceeds 10m (168 ms)
        âœ“ should handle edge case at exact boundary with GPS uncertainty (2 ms)
      detectExit
        âœ“ should detect exit with 30s delay confirmation (2 ms)
        âœ“ should cancel exit confirmation if user returns within 30s (2 ms)
        âœ“ should handle multiple geofences with independent exit delays (2 ms)
    Cooldown Management (5-minute between notifications)
      notificationCooldown
        âœ“ should enforce 5-minute cooldown between notifications (2 ms)
        âœ“ should allow notifications after 5-minute cooldown expires (2 ms)
        âœ“ should handle different cooldown periods for different event types (1 ms)
        âœ“ should allow immediate notifications for different geofences (1 ms)
    Dwell Time Tracking (5+ minutes)
      trackDwellTime
        âœ“ should track dwell time when user stays in geofence for 5+ minutes (24 ms)
        âœ“ should trigger dwell alerts at specific intervals (2 ms)
        âœ“ should reset dwell time when user exits and re-enters (1 ms)
        âœ“ should handle movement within geofence without resetting dwell time (2 ms)
    Geofence Configuration and Management
      createGeofence
        âœ“ should validate geofence parameters before creation (26 ms)
        âœ“ should enforce maximum number of geofences per user (1 ms)
        âœ“ should validate geofence names are unique per user (1 ms)
      updateGeofence
        âœ“ should handle geofence boundary updates and notify affected users (38 ms)
    Performance and Optimization
      batchLocationProcessing
        âœ“ should efficiently process multiple users locations simultaneously (2 ms)
        âœ“ should handle high-frequency location updates without performance degradation (3 ms)
    Error Handling and Recovery
      errorRecovery
        âœ“ should handle location service failures gracefully (22 ms)
        âœ“ should continue processing other geofences when one fails (1 ms)
    Integration with External Services
      emergencyResponse
        âœ“ should trigger emergency alerts for critical geofence violations (1 ms)

PASS backend src/backend/tests/unit/audit.service.test.js
  ç¨½æ ¸æœå‹™ (Audit Service)
    ç¶œåˆç¨½æ ¸è¨˜éŒ„ (Comprehensive Audit Logging)
      âœ“ æ‡‰è¨˜éŒ„ä½¿ç”¨è€…ç™»å…¥äº‹ä»¶ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™å­˜å–äº‹ä»¶
      âœ“ æ‡‰è¨˜éŒ„ç³»çµ±ç®¡ç†æ“ä½œ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™åŒ¯å‡ºäº‹ä»¶
      âœ“ æ‡‰è¨˜éŒ„å¤±æ•—çš„æ“ä½œå˜—è©¦
    ç¨½æ ¸è»Œè·¡å®Œæ•´æ€§ (Audit Trail Integrity)
      âœ“ æ‡‰ç‚ºæ¯ç­†ç¨½æ ¸è¨˜éŒ„å»ºç«‹é›œæ¹Šå€¼ (1 ms)
      âœ“ æ‡‰å»ºç«‹ç¨½æ ¸è¨˜éŒ„éˆå¼é›œæ¹Š (1 ms)
      âœ“ æ‡‰æª¢æ¸¬ç¨½æ ¸è¨˜éŒ„çš„ç¯¡æ”¹ (1 ms)
      âœ“ æ‡‰åœ¨æª¢æ¸¬åˆ°ç¯¡æ”¹æ™‚ç™¼é€å®‰å…¨è­¦å ±
      âœ“ æ‡‰æ”¯æ´ç¨½æ ¸è¨˜éŒ„çš„æ•¸ä½ç°½ç«  (1 ms)
    åˆè¦å ±å‘Š (Compliance Reporting)
      âœ“ æ‡‰ç”¢ç”Ÿ GDPR åˆè¦å ±å‘Š (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿå°ç£å€‹è³‡æ³•åˆè¦å ±å‘Š (1 ms)
      âœ“ æ‡‰ç”¢ç”Ÿé†«ç™‚æ³•è¦åˆè¦å ±å‘Š (1 ms)
      âœ“ æ‡‰é©—è­‰åˆè¦å ±å‘Šçš„å®Œæ•´æ€§ (24 ms)
      âœ“ æ‡‰è‡ªå‹•æª¢æŸ¥åˆè¦æ€§é•è¦ (1 ms)
    è³‡æ–™å­˜å–è¿½è¹¤ (Data Access Tracking)
      âœ“ æ‡‰è¿½è¹¤å€‹äººè³‡æ–™çš„å­˜å–æ¨¡å¼ (1 ms)
      âœ“ æ‡‰æª¢æ¸¬ç•°å¸¸çš„è³‡æ–™å­˜å–è¡Œç‚º (1 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™ä¸‹è¼‰å’Œåˆ—å°äº‹ä»¶
      âœ“ æ‡‰æä¾›è³‡æ–™è¡€ç·£è¿½è¹¤ (1 ms)
    å®‰å…¨äº‹ä»¶è¨˜éŒ„ (Security Event Logging)
      âœ“ æ‡‰è¨˜éŒ„ç™»å…¥å¤±æ•—äº‹ä»¶ (1 ms)
      âœ“ æ‡‰è¨˜éŒ„æ¬Šé™æå‡äº‹ä»¶ (10 ms)
      âœ“ æ‡‰è¨˜éŒ„å¯ç–‘çš„æª”æ¡ˆå­˜å– (1 ms)
      âœ“ æ‡‰è¨˜éŒ„è³‡æ–™åº«ç›´æ¥å­˜å–äº‹ä»¶
    ç¨½æ ¸æ—¥èªŒä¿ç•™èˆ‡æ­¸æª” (Audit Log Retention)
      âœ“ æ‡‰æ ¹æ“šä¿ç•™æ”¿ç­–æ­¸æª”èˆŠè¨˜éŒ„ (1 ms)
      âœ“ æ‡‰å£“ç¸®æ­¸æª”çš„ç¨½æ ¸è¨˜éŒ„ (1 ms)
      âœ“ æ‡‰é©—è­‰æ­¸æª”è³‡æ–™çš„å®Œæ•´æ€§
      âœ“ æ‡‰æ”¯æ´æ­¸æª”è³‡æ–™çš„æœå°‹
    æŸ¥è©¢èˆ‡æœå°‹åŠŸèƒ½ (Query and Search)
      âœ“ æ‡‰æ”¯æ´è¤‡é›œçš„ç¨½æ ¸è¨˜éŒ„æŸ¥è©¢ (1 ms)
      âœ“ æ‡‰æ”¯æ´å…¨æ–‡æœå°‹ç¨½æ ¸è¨˜éŒ„
      âœ“ æ‡‰æä¾›ç¨½æ ¸çµ±è¨ˆæ‘˜è¦ (1 ms)
    ç›£ç®¡æ©Ÿé—œåŒ¯å‡ºåŠŸèƒ½ (Regulatory Export)
      âœ“ æ‡‰ç”¢ç”Ÿç›£ç®¡æ©Ÿé—œæ ¼å¼çš„ç¨½æ ¸å ±å‘Š (13 ms)
      âœ“ æ‡‰ç‚ºç›£ç®¡åŒ¯å‡ºåŠ ä¸Šæµ®æ°´å° (1 ms)
      âœ“ æ‡‰è¨˜éŒ„ç›£ç®¡æ©Ÿé—œçš„è³‡æ–™è«‹æ±‚ (1 ms)
      âœ“ æ‡‰é©—è­‰ç›£ç®¡åŒ¯å‡ºçš„æˆæ¬Š (10 ms)
    éŒ¯èª¤è™•ç† (Error Handling)
      âœ“ æ‡‰åœ¨ç¨½æ ¸è¨˜éŒ„å¤±æ•—æ™‚æ‹‹å‡ºéŒ¯èª¤ (60 ms)
      âœ“ æ‡‰åœ¨ç„¡æ•ˆæŸ¥è©¢åƒæ•¸æ™‚æ‹‹å‡ºé©—è­‰éŒ¯èª¤ (85 ms)
      âœ“ æ‡‰åœ¨æœªæˆæ¬Šå­˜å–æ™‚æ‹‹å‡ºå®‰å…¨éŒ¯èª¤ (1 ms)
      âœ“ æ‡‰åœ¨åˆè¦æª¢æŸ¥å¤±æ•—æ™‚æ‹‹å‡ºåˆè¦éŒ¯èª¤

PASS frontend src/mobile/tests/integration/mobile-services.integration.test.js
  Mobile Services Integration Tests
    BLEBackgroundService - Production Validation
      âœ“ should initialize iOS Core Bluetooth successfully (10 ms)
      âœ“ should start background scanning with neverForLocation compliance (7 ms)
      âœ“ should process discovered devices with anonymization (1 ms)
      âœ“ should optimize scanning based on battery level (1 ms)
      âœ“ should handle state preservation and restoration (1 ms)
    MyDataIntegrationService - Production Validation
      âœ“ should initiate OAuth flow with secure state (1 ms)
      âœ“ should generate unique secure state parameters (1 ms)
      âœ“ should handle OAuth callback with valid state (2 ms)
      âœ“ should exchange authorization code for access token (1 ms)
      âœ“ should fetch and filter user profile data (1 ms)
      âœ“ should validate data minimization principles (1 ms)
    MobileGeofenceEngine - Production Validation
      âœ“ should initialize iOS Core Location successfully (1 ms)
      âœ“ should register geofences within platform limits
      âœ“ should process location updates and detect geofence events (22 ms)
      âœ“ should handle exit confirmation delays (42 ms)
      âœ“ should configure iOS notifications properly (1 ms)
      âœ“ should initialize Android notifications with proper channels (1 ms)
    Cross-Service Integration
      âœ“ should work together for complete guardian functionality (1 ms)

PASS frontend src/mobile/tests/services/MobileGeofenceEngine.test.js
  MobileGeofenceEngine - GREEN Phase Tests
    iOS Core Location Integration
      Location Permission Management
        âœ“ should request Always location permission for background geofencing (1 ms)
        âœ“ should handle permission upgrade from WhenInUse to Always (1 ms)
        âœ“ should provide user guidance when permissions denied (1 ms)
      Core Location Geofence Setup
        âœ“ should register geofences with CLLocationManager (1 ms)
        âœ“ should handle iOS geofence limit (20 maximum) (164 ms)
        âœ“ should configure significant location monitoring as fallback (1 ms)
    Android GeofencingClient Integration
      Android Geofencing Setup
        âœ“ should create GeofencingRequest with proper configuration (1 ms)
        âœ“ should handle Android background location limitations (13 ms)
        âœ“ should implement PendingIntent for geofence transitions (1 ms)
    Accuracy and GPS Uncertainty Handling
      10m Accuracy Requirement
        âœ“ should reject location updates with accuracy > 10m (1 ms)
        âœ“ should handle GPS uncertainty in boundary detection (1 ms)
        âœ“ should implement accuracy-based confidence levels (1 ms)
    Background Processing and Notifications
      Exit Confirmation with 30s Delay
        âœ“ should implement 30-second confirmation delay for exits
        âœ“ should cancel exit confirmation if user returns within 30s (27 ms)
        âœ“ should confirm exit after 30-second delay expires (1 ms)
      Notification Integration
        âœ“ should send entry notifications immediately (1 ms)
        âœ“ should respect 5-minute notification cooldown
        âœ“ should handle critical alerts for emergency geofences (4 ms)
    Backend Integration
      Geofence Synchronization
        âœ“ should sync geofences from backend on app launch (1 ms)
        âœ“ should report geofence events to backend (1 ms)
        âœ“ should queue events for offline sync
    Error Handling and Edge Cases
      Location Service Failures
        âœ“ should handle GPS unavailable gracefully (1 ms)
        âœ“ should implement fallback strategies for location failures (1 ms)
      Platform-Specific Edge Cases
        âœ“ should handle iOS app backgrounding and foregrounding (30 ms)
        âœ“ should handle Android doze mode and battery optimization (1 ms)
    Notification Configuration Tests
      âœ“ should configure iOS notifications properly
      âœ“ should request iOS notification permissions (1 ms)
      âœ“ should get notification configuration (12 ms)
      âœ“ should initialize Android notifications with proper channels (2 ms)
      âœ“ should get notification channel config
      âœ“ should check DND status (1 ms)
      âœ“ should request Android notification permissions
    Backend Integration Tests
      âœ“ should initialize backend integration
      âœ“ should sync geofences with backend (1 ms)
      âœ“ should send geofence notifications
    Error Handling Tests
      âœ“ should handle network failure (1 ms)
      âœ“ should handle GPS failure
      âœ“ should handle low battery (1 ms)
    Integration Tests
      âœ“ should process location updates and detect geofence events
      âœ“ should handle exit confirmation delays (1 ms)

PASS validation tests/validation/p1-family-geofence-validation.test.js
  P1 å®¶å±¬ç«¯ Production Validation
    E2E Geofence Scenarios
      é€²å…¥ (Entry) Scenarios
        âœ“ should detect entry into Hsinchu City Hall geofence (3 ms)
        âœ“ should handle entry with GPS uncertainty edge cases (56 ms)
      é›¢é–‹ (Exit) Scenarios
        âœ“ should implement 30-second exit confirmation delay (2 ms)
        âœ“ should cancel exit if user returns within 30 seconds (13 ms)
      åœç•™ (Dwelling) Scenarios
        âœ“ should track dwelling time and send periodic updates (13 ms)
    iOS Time-Sensitive Notifications Validation
      âœ“ should use Time-Sensitive but NOT Critical level notifications (1 ms)
      âœ“ should respect iOS Focus/DND modes appropriately
      âœ“ should handle iOS notification authorization correctly (1 ms)
    Android High-Priority Channels Validation
      âœ“ should create high-priority channel WITHOUT DND bypass (1 ms)
      âœ“ should respect user DND preferences (9 ms)
      âœ“ should handle Android 13+ notification permissions (1 ms)
    Geofence Accuracy and Timing Validation
      âœ“ should maintain 10m accuracy requirement under various conditions (2 ms)
      âœ“ should handle timing precision for event correlation (1 ms)
      âœ“ should validate geofence coordinate precision for Hsinchu area (3 ms)
    Production Integration Validation
      âœ“ should integrate with real backend API endpoints (1 ms)
      âœ“ should handle production error scenarios gracefully (38 ms)

PASS backend src/backend/tests/unit/anonymization.service.test.js
  AnonymizationService
    Device Hash Generation
      One-Way Hash with Salt
        âœ“ should generate SHA-256 hash with salt for device MAC address (3 ms)
        âœ“ should use consistent salt for same session (14 ms)
        âœ“ should generate new salt for new session (1 ms)
        âœ“ should make hash irreversible - no reverse lookup possible (1 ms)
      Hash Consistency and Collision Handling
        âœ“ should generate same hash for same MAC address in same session (1 ms)
        âœ“ should generate different hashes for different MAC addresses (10 ms)
        âœ“ should handle hash collisions gracefully (1 ms)
    VolunteerHit Creation
      Complete Data Anonymization
        âœ“ should create VolunteerHit with all PII removed (6 ms)
        âœ“ should never store original device names (1 ms)
        âœ“ should never store device IDs, phone numbers, or personal identifiers (1 ms)
      Location Fuzzing
        âœ“ should fuzz location to 100m grid squares (1 ms)
        âœ“ should never store precise location coordinates (1 ms)
        âœ“ should handle edge cases near grid boundaries (6 ms)
      Timestamp Rounding
        âœ“ should round timestamps to 5-minute intervals (1 ms)
        âœ“ should never store precise timestamps (1 ms)
        âœ“ should handle edge cases at interval boundaries (1 ms)
    K-Anonymity Enforcement
      Minimum Cluster Size Validation
        âœ“ should require minimum 3 devices per cluster (1 ms)
        âœ“ should allow upload when k=3 minimum is met
        âœ“ should queue VolunteerHits until k-anonymity is achieved
        âœ“ should upload all queued hits when k-anonymity threshold reached (2 ms)
      Individual Device Identification Prevention
        âœ“ should ensure individual devices cannot be identified from clusters (1 ms)
        âœ“ should validate that server data cannot reverse lookup individual devices (1 ms)
    Privacy Protection Validation
      Data Minimization
        âœ“ should only store essential anonymized data (1 ms)
        âœ“ should purge unnecessary metadata and device fingerprints
      Anonymization Verification
        âœ“ should verify no reverse lookup is possible from anonymized data
        âœ“ should detect and reject data containing PII
    Error Handling and Edge Cases
      Malformed Data Handling
        âœ“ should handle malformed MAC addresses gracefully (59 ms)
        âœ“ should handle invalid location coordinates gracefully (3 ms)
        âœ“ should handle timestamp parsing errors gracefully (28 ms)

PASS backend src/backend/tests/unit/mydata-adapter.test.js
  MyDataAdapter Service
    OAuth Authorization Flow
      âœ“ should generate authorization URL with required parameters (2 ms)
      âœ“ should handle authorization callback and exchange code for token (20 ms)
      âœ“ should reject callback with invalid state (72 ms)
      âœ“ should handle token exchange failures (2 ms)
    Data Retrieval with Consent
      âœ“ should fetch personal data with valid access token (1 ms)
      âœ“ should handle expired token and attempt refresh (23 ms)
      âœ“ should enforce single-use token policy (1 ms)
    Data Retention and Cleanup
      âœ“ should store data with TTL based on purpose
      âœ“ should enforce maximum retention period (1 ms)
      âœ“ should automatically clean expired data
    Consent Revocation
      âœ“ should immediately delete data on consent revocation
      âœ“ should notify MyData platform of revocation (1 ms)
      âœ“ should handle cascade deletion of related data (17 ms)
      âœ“ should generate revocation receipt (4 ms)
    Audit and Compliance
      âœ“ should log all data access attempts (1 ms)
      âœ“ should generate compliance report
      âœ“ should validate data minimization principle (1 ms)

PASS backend src/backend/tests/unit/geofence-engine.test.js
  GeofenceEngine
    Boundary Events
      âœ“ should detect entry within 10m accuracy (8 ms)
      âœ“ should detect exit with 30 second delay (2 ms)
      âœ“ should track dwell time for 5+ minutes (1 ms)
      âœ“ should calculate accurate distance using Haversine formula (1 ms)
    Cooldown Logic
      âœ“ should prevent notification spam with 5 min cooldown (2 ms)
      âœ“ should handle multiple geofence priority correctly (4 ms)
      âœ“ should reset cooldown after period expires (55 ms)
    Performance
      âœ“ should handle 100+ simultaneous geofences (5 ms)
      âœ“ should implement battery-efficient monitoring (2 ms)
      âœ“ should batch process location updates efficiently (2 ms)
      âœ“ should cache geofence calculations for performance (1 ms)
    State Management
      âœ“ should persist geofence state across restarts (2 ms)
      âœ“ should clean up expired geofences (8 ms)

PASS frontend tests/validation/p2-volunteer-ble-validation.test.js
  P2 å¿—å·¥BLE Production Validation
    Android 12+ Permission Management with neverForLocation
      âœ“ should request ONLY BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (7 ms)
      âœ“ should configure BLE scanning without location inference (18 ms)
      âœ“ should handle manifest declaration validation for neverForLocation
      âœ“ should create anonymized volunteer hits without any location data (15 ms)
      âœ“ should validate Android 12+ runtime permission flow (1 ms)
    iOS State Preservation/Restoration Validation
      âœ“ should initialize with proper Core Bluetooth configuration (1 ms)
      âœ“ should save complete state when app backgrounded (1 ms)
      âœ“ should restore state correctly when app relaunched (2 ms)
      âœ“ should handle iOS background app refresh settings (29 ms)
      âœ“ should validate iOS State Preservation across app lifecycle (2 ms)
    VolunteerHit Anonymization with NO PII Exposure
      âœ“ should ensure absolute PII protection in volunteer hits (24 ms)
      âœ“ should implement salted hashing for device identification (47 ms)
      âœ“ should enforce K-anonymity before submitting volunteer hits (2 ms)
      âœ“ should validate complete anonymization pipeline (4 ms)
    BLE Background Scanning Capabilities
      âœ“ should maintain background scanning under battery optimization (8 ms)
      âœ“ should handle BLE state changes gracefully (2 ms)
      âœ“ should implement adaptive scanning based on discovery rate (1 ms)
      âœ“ should validate production BLE integration with backend (1 ms)
    Production Error Handling and Recovery
      âœ“ should handle permission revocation gracefully (28 ms)
      âœ“ should recover from temporary BLE failures (2 ms)

PASS backend src/backend/tests/unit/volunteer-consent.service.test.js
  VolunteerConsentService
    Consent Management
      grantConsent
        âœ“ should enable volunteer mode and start background BLE scanning (30 ms)
        âœ“ should record consent timestamp for GDPR compliance (2 ms)
        âœ“ should handle consent version updates (1 ms)
      withdrawConsent
        âœ“ should immediately disable volunteer mode and stop scanning
        âœ“ should cancel all queued data uploads (1 ms)
        âœ“ should purge local volunteer data immediately (1 ms)
      checkConsentStatus
        âœ“ should return consent status with version information (13 ms)
        âœ“ should detect when consent version requires update (1 ms)
    Permission Management
      Android 12+ Permissions
        âœ“ should request BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions
        âœ“ should conditionally request location permission based on inference setting (1 ms)
        âœ“ should set neverForLocation flag when location inference disabled (1 ms)
      iOS Background Permissions
        âœ“ should configure bluetooth-central background mode
    Persistence and Recovery
      App Restart Scenarios
        âœ“ should preserve consent state across app restarts (1 ms)
        âœ“ should resume background scanning automatically after restart
    Error Handling
      Permission Denied Scenarios
        âœ“ should handle graceful degradation when BLE permission denied (60 ms)
        âœ“ should mark consent as pending when permissions incomplete (1 ms)
    Privacy and GDPR Compliance
      âœ“ should anonymize user identifiers in consent records (1 ms)
      âœ“ should not store IP addresses or detailed device fingerprints (1 ms)

PASS backend src/backend/tests/unit/geo-alert.service.test.js
  GeoAlertService
    Alert Radius Configuration and Targeting
      500m, 1km, 2km Radius Support
        âœ“ should receive alert when within 500m radius (5 ms)
        âœ“ should NOT receive alert when outside 1km radius (1 ms)
        âœ“ should support 2km radius for wide area alerts (1 ms)
        âœ“ should handle edge case at exact radius boundary
    Alert Cooldown and Spam Prevention
      5-Minute Minimum Cooldown
        âœ“ should prevent duplicate alerts within 5-minute cooldown (2 ms)
        âœ“ should allow alert after 5-minute cooldown expires (2 ms)
        âœ“ should show cooldown timer to user (2 ms)
        âœ“ should reset cooldown when timer expires (1 ms)
    Privacy Protection - No PII in Alerts
      Alert Content Restrictions
        âœ“ should never include names in alert messages (1 ms)
        âœ“ should never include age or gender information (10 ms)
        âœ“ should never include photos or physical descriptions (2 ms)
        âœ“ should use only general area descriptions (3 ms)
    Alert Priority Levels
      Info Level Alerts
        âœ“ should send info level with standard notification settings (1 ms)
        âœ“ should not override Do Not Disturb for info alerts (1 ms)
      Warning Level Alerts
        âœ“ should send warning level with prominent notification (1 ms)
        âœ“ should use Time-Sensitive delivery on iOS for warnings (7 ms)
        âœ“ should use high importance channel on Android for warnings (1 ms)
      Critical Level Alerts
        âœ“ should send critical level with maximum urgency settings (1 ms)
        âœ“ should use Critical Alert on iOS if authorized (2 ms)
        âœ“ should use Full-Screen Intent on Android with user consent
        âœ“ should allow user to dismiss or snooze critical alerts
    Mandatory Safety Instructions
      Required Message Content
        âœ“ should always include "è«‹æ’¥æ‰“110" in all alert levels (1 ms)
        âœ“ should always include "åˆ‡å‹¿è‡ªè¡Œæ¥è¿‘" in all alert levels (1 ms)
        âœ“ should provide emergency contact button in all alerts
        âœ“ should provide "å›å ±å¯ç–‘" button for volunteer coordination (1 ms)
        âœ“ should provide safety guidelines link (1 ms)
    A/B Testing for Safety Message Effectiveness
      Message Variant Testing
        âœ“ should assign users to A/B test groups for message variations (1 ms)
        âœ“ should use variant B wording for test group B (1 ms)
        âœ“ should track engagement metrics for A/B test analysis (1 ms)
        âœ“ should record user response for effectiveness analysis
        âœ“ should ensure core safety instructions remain unchanged across variants
    Error Handling and Edge Cases
      Location Permission Errors
        âœ“ should handle location permission denied gracefully (1 ms)
        âœ“ should fallback to general notifications when location unavailable
      Push Notification Errors
        âœ“ should handle push notification permission disabled (7 ms)
        âœ“ should show in-app alert banner when push notifications fail (1 ms)
        âœ“ should still attempt delivery for critical alerts when notifications disabled (1 ms)

PASS backend src/backend/tests/unit/revocation.service.test.js
  RevocationService
    Immediate Revocation Processing
      âœ“ should process complete revocation within 100ms (2 ms)
      âœ“ should delete data from all storage layers (12 ms)
      âœ“ should handle partial failures with rollback (95 ms)
    Audit Trail Generation
      âœ“ should create comprehensive audit trail for revocation (1 ms)
      âœ“ should include all affected data types in audit (1 ms)
      âœ“ should generate immutable revocation receipt (1 ms)
    Cascade Deletion
      âœ“ should delete all related data in correct order (1 ms)
      âœ“ should handle foreign key constraints
      âœ“ should notify dependent services before deletion (24 ms)
    Recovery and Rollback
      âœ“ should support revocation cancellation within grace period (1 ms)
      âœ“ should create backup before permanent deletion (1 ms)
      âœ“ should validate revocation request integrity (14 ms)
    Compliance and Verification
      âœ“ should verify complete data deletion (1 ms)
      âœ“ should detect incomplete deletion (1 ms)
      âœ“ should generate GDPR Article 17 compliance report

PASS backend src/backend/tests/unit/retention.service.test.js
  RetentionService
    TTL-based Data Retention
      âœ“ should set appropriate TTL based on data purpose (16 ms)
      âœ“ should apply minimum retention for regulatory compliance (2 ms)
      âœ“ should reduce TTL for sensitive data without explicit consent (16 ms)
    Automated Cleanup Jobs
      âœ“ should schedule daily cleanup cron job (3 ms)
      âœ“ should cleanup expired personal data (4 ms)
      âœ“ should handle cleanup failures gracefully
      âœ“ should cleanup orphaned consent records (1 ms)
    Immediate Revocation
      âœ“ should immediately delete all data on revocation request (1 ms)
      âœ“ should generate deletion certificate (5 ms)
      âœ“ should notify related services of revocation (4 ms)
      âœ“ should validate revocation request authorization (48 ms)
    Retention Policies
      âœ“ should apply data minimization principle (3 ms)
      âœ“ should pseudonymize data after initial retention period (9 ms)
      âœ“ should enforce different retention periods by data category (2 ms)
    Compliance Reporting
      âœ“ should generate GDPR compliance report (2 ms)
      âœ“ should track data subject requests (3 ms)

PASS backend src/backend/tests/unit/ble-scanner.service.test.js
  BLEScannerService
    Android 12+ Permission Handling
      neverForLocation Scanning
        âœ“ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (3 ms)
        âœ“ should discover BLE devices without location inference (1 ms)
        âœ“ should generate device hashes with salt immediately (1 ms)
      Location-Based Scanning for Positioning
        âœ“ should request location permissions when inference enabled (1 ms)
        âœ“ should include RSSI and location data in volunteer hits (1 ms)
        âœ“ should fuzz location to 100m grid squares
        âœ“ should round timestamps to 5-minute intervals (1 ms)
    iOS Background BLE Handling
      State Preservation
        âœ“ should configure CBCentralManager with restore identifier (1 ms)
        âœ“ should save scanning state for preservation
      State Restoration
        âœ“ should restore scanning state on app launch
        âœ“ should resume background scanning automatically (1 ms)
    Device Discovery and Filtering
      RSSI Threshold Filtering
        âœ“ should process devices with RSSI stronger than -90 dBm (1 ms)
        âœ“ should ignore devices with RSSI weaker than -90 dBm
        âœ“ should handle edge case at exactly -90 dBm threshold (1 ms)
      MAC Address Rotation Handling
        âœ“ should handle MAC rotation by treating each MAC as separate device
        âœ“ should not correlate rotated MAC addresses (1 ms)
        âœ“ should maintain k-anonymity across MAC rotations (1 ms)
    Battery-Efficient Scanning
      Power Management
        âœ“ should use conservative scanning when not charging
        âœ“ should use aggressive scanning when charging (1 ms)
        âœ“ should adapt intervals based on detection rate
    VolunteerHit Creation
      Complete Anonymization
        âœ“ should create VolunteerHit with all required anonymized fields (1 ms)
        âœ“ should never store original MAC addresses (11 ms)
        âœ“ should never store device names or personal identifiers (1 ms)
    Error Handling
      BLE Adapter Failures
        âœ“ should handle BLE adapter disabled gracefully (1 ms)
        âœ“ should resume scanning when Bluetooth is re-enabled (1 ms)
      Permission Revocation
        âœ“ should stop scanning immediately when permissions revoked
        âœ“ should preserve queued data when permissions revoked (1 ms)
        âœ“ should resume from preserved state when permissions re-granted (1 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                    
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                             |   26.52 |    31.53 |   24.96 |   29.31 |                                                                                                                                                                                                                                                                                                      
 backend/coverage                     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 backend/coverage/lcov-report         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 backend/examples                     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  service-usage-example.js            |       0 |        0 |       0 |       0 | 6-233                                                                                                                                                                                                                                                                                                
 backend/services                     |   26.46 |    25.87 |    21.6 |   26.81 |                                                                                                                                                                                                                                                                                                      
  AnonymizationService.js             |       0 |        0 |       0 |       0 | 14-297                                                                                                                                                                                                                                                                                               
  AuditService-enhanced.js            |    38.2 |    37.83 |      36 |   39.53 | 11,107-249,268,281-283,307-308                                                                                                                                                                                                                                                                       
  AuditService.js                     |   24.84 |    22.58 |   15.21 |   25.85 | 41-536,555-569,584-587,616,621-627,689,694,713,736-786                                                                                                                                                                                                                                               
  BLEScannerService.js                |    1.19 |        0 |       0 |    1.19 | 12-258                                                                                                                                                                                                                                                                                               
  CaseFlowService-enhanced.js         |   67.85 |    37.93 |   76.92 |   67.27 | 142,175-214,220,243-267                                                                                                                                                                                                                                                                              
  CaseFlowService-workflow.js         |    8.47 |        0 |    12.5 |    8.62 | 48-223                                                                                                                                                                                                                                                                                               
  CaseFlowService.js                  |    4.58 |     1.78 |    2.43 |    4.65 | 13,21-24,61-729                                                                                                                                                                                                                                                                                      
  GeoAlertService.js                  |    0.66 |        0 |       0 |    0.66 | 13-403                                                                                                                                                                                                                                                                                               
  KPIService-enhanced.js              |    15.9 |     5.26 |      10 |    15.9 | 9,21-302                                                                                                                                                                                                                                                                                             
  KPIService.js                       |     4.9 |     1.09 |    2.94 |    5.26 | 36-629,691-914                                                                                                                                                                                                                                                                                       
  MyDataAdapter.js                    |   52.05 |    53.58 |   44.44 |   53.24 | 60-206,215-261,280-292,328-377,394,410,423-426,429-430,446,452,461-470,512,537-550,566,573-574,642,657,664-679,784,789,794,811,832-858,904,927,959-1011                                                                                                                                              
  MyDataAdapterAPI.js                 |       0 |        0 |       0 |       0 | 10-348                                                                                                                                                                                                                                                                                               
  RBACService.js                      |   39.93 |    41.66 |   40.42 |   39.66 | 13,19-20,25-26,187,195,231,250,272-299,336-369,381-382,398,400,404,406,434,439,446-451,458-474,495-777,805,815,856,875,889,900-911,922-927,951,961,994,1031,1048                                                                                                                                     
  RetentionService.js                 |   45.67 |    41.57 |   47.36 |   45.41 | 23-347,376,433,462-463,516                                                                                                                                                                                                                                                                           
  RevocationService.js                |   56.87 |    36.84 |    37.5 |   57.23 | 49-50,97-112,139-144,164-166,172-173,194,207-220,229-231,252-381,389,418,440,486,497,534-550                                                                                                                                                                                                         
  VolunteerConsentService.js          |       0 |        0 |       0 |       0 | 12-203                                                                                                                                                                                                                                                                                               
 backend/services/safety              |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  index.js                            |       0 |        0 |       0 |       0 | 6-334                                                                                                                                                                                                                                                                                                
 backend/services/safety/case         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  CaseManagementService.js            |       0 |        0 |       0 |       0 | 6-1027                                                                                                                                                                                                                                                                                               
 backend/services/safety/device       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  DeviceBindingService.js             |       0 |        0 |       0 |       0 | 24-322                                                                                                                                                                                                                                                                                               
 backend/services/safety/events       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  EventStreamService.js               |       0 |        0 |       0 |       0 | 6-511                                                                                                                                                                                                                                                                                                
 backend/services/safety/geofence     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  GeofenceService.js                  |       0 |        0 |       0 |       0 | 6-550                                                                                                                                                                                                                                                                                                
 backend/services/safety/matching     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  MatchingService.js                  |       0 |        0 |       0 |       0 | 6-799                                                                                                                                                                                                                                                                                                
 backend/services/safety/mydata       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  MyDataService.js                    |       0 |        0 |       0 |       0 | 6-828                                                                                                                                                                                                                                                                                                
 backend/src                          |   66.66 |    11.11 |   45.45 |   66.66 |                                                                                                                                                                                                                                                                                                      
  app.js                              |      72 |    14.28 |   45.45 |      72 | 81-103                                                                                                                                                                                                                                                                                               
  index.js                            |       0 |        0 |     100 |       0 | 8-15                                                                                                                                                                                                                                                                                                 
 backend/src/constants                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  safety-service.constants.js         |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
 backend/src/hardware                 |    9.74 |     1.56 |    2.85 |    9.93 |                                                                                                                                                                                                                                                                                                      
  ble-manager.js                      |    9.74 |     1.56 |    2.85 |    9.93 | 41-396                                                                                                                                                                                                                                                                                               
 backend/src/middleware               |    62.4 |    44.76 |   64.28 |   61.83 |                                                                                                                                                                                                                                                                                                      
  auth.js                             |   42.42 |     22.4 |   30.76 |   42.42 | 9,220,228,245,259,276-471                                                                                                                                                                                                                                                                            
  error.js                            |   51.51 |    58.69 |   57.14 |   51.51 | 82,87,92-93,98,125-166                                                                                                                                                                                                                                                                               
  index.js                            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  security.js                         |   77.08 |    70.21 |      75 |   76.59 | 41,136-139,170,187,200-211,225                                                                                                                                                                                                                                                                       
  shared.js                           |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  validation.js                       |     100 |    90.47 |     100 |     100 | 67-71                                                                                                                                                                                                                                                                                                
 backend/src/repositories             |    12.5 |        0 |       0 |    12.5 |                                                                                                                                                                                                                                                                                                      
  device.repository.js                |     100 |      100 |       0 |     100 |                                                                                                                                                                                                                                                                                                      
  geofence.repository.js              |    6.66 |        0 |       0 |    6.66 | 12-107                                                                                                                                                                                                                                                                                               
 backend/src/routes                   |    70.3 |    56.28 |   57.14 |   70.27 |                                                                                                                                                                                                                                                                                                      
  ble-scanner.js                      |    37.5 |        0 |       0 |    37.5 | 12-39,51-58,75-82,95-102,115-122                                                                                                                                                                                                                                                                     
  cases-additional.js                 |   57.14 |    30.55 |      75 |   57.14 | 15-71,95,105,140-198,291-292,317,349-350                                                                                                                                                                                                                                                             
  cases.js                            |   81.39 |    62.13 |     100 |   81.39 | 33,74-79,87-97,130-143,177,202-203,223,262,281,324,338-345,380,406,424-432                                                                                                                                                                                                                           
  device-binding.js                   |   36.36 |      100 |       0 |   36.36 | 12-43,67-79,92-99,112-119,132-139                                                                                                                                                                                                                                                                    
  index.js                            |    92.5 |    16.66 |      60 |    92.5 | 33,43,68                                                                                                                                                                                                                                                                                             
  kpi-enhanced.js                     |      25 |        0 |       0 |   25.45 | 24-51,59-130,138-150,158-175                                                                                                                                                                                                                                                                         
  kpi.js                              |    81.1 |    69.69 |    87.5 |   80.64 | 96,119,140-147,169-180,188-259,343,440,507,555,563-573                                                                                                                                                                                                                                               
  mydata.js                           |   84.72 |    76.08 |   83.33 |   84.72 | 13,26,54,68,106,130,176,193,203,250,285                                                                                                                                                                                                                                                              
  rbac.js                             |   88.33 |    87.87 |     100 |   88.33 | 35-36,81,95,120,156,198                                                                                                                                                                                                                                                                              
 backend/src/services                 |   71.28 |    57.19 |    71.5 |   71.26 |                                                                                                                                                                                                                                                                                                      
  ServiceContainer.js                 |   71.42 |       48 |   67.85 |   71.42 | 37,78,114,124-125,153-154,177,184,216-222,260-278,300-303,313-329,351-354                                                                                                                                                                                                                            
  anonymization.service.js            |   78.62 |    73.52 |      84 |   78.87 | 32,37,106,155,160,181,208-212,229-260,284,290,310,361,389-399,408                                                                                                                                                                                                                                    
  audit-log.service.js                |      20 |        0 |       0 |      20 | 8-18                                                                                                                                                                                                                                                                                                 
  audit.service.js                    |   89.67 |    60.82 |   87.23 |    89.4 | 31-39,45-48,188,461,463,718-722                                                                                                                                                                                                                                                                      
  ble-scanner.service.js              |   62.94 |    48.36 |   75.67 |   63.05 | 69,74,117-123,134,145-146,182,237,254,259,282,297,331,348,369,384-409,422-432,459,471,483,513,535,543-662,678,690,701-779                                                                                                                                                                            
  case-flow.service.js                |   92.27 |    76.56 |   94.04 |    92.7 | 110,114,118,122,126,260,269,328,376,400-401,416,427,465,485,539,579,597,613,660,684,689,715,747,777,797,830,869,903,923,1038,1071,1103,1112                                                                                                                                                          
  event-emitter.service.js            |   11.11 |        0 |       0 |   11.11 | 7-34                                                                                                                                                                                                                                                                                                 
  geo-alert.service.js                |    14.1 |     3.38 |   14.81 |   14.19 | 28,41,47-359,368-490                                                                                                                                                                                                                                                                                 
  index.js                            |      50 |        0 |      25 |      50 | 31-59                                                                                                                                                                                                                                                                                                
  kpi.service.js                      |   83.89 |    55.55 |   98.88 |   83.05 | 65,85,102,120,153,174,205,230,251,279,303,317,326,345,364,384,410,429,450,469,489,514,538,552,572,598,644,650,666,686,706-712,733-739,761,774,793,808,829,850,859,886,900,905,926,942,961,984,1002,1024,1040,1069,1092,1102,1110,1117,1136,1146,1174,1178,1182                                       
  location.service.js                 |    5.26 |        0 |       0 |    5.88 | 16-71                                                                                                                                                                                                                                                                                                
  mydata-adapter.service.js           |      63 |    42.25 |   63.63 |   62.79 | 150-170,404-689                                                                                                                                                                                                                                                                                      
  notification.service.js             |   15.38 |      100 |       0 |   15.38 | 8-39                                                                                                                                                                                                                                                                                                 
  rbac.service.js                     |   56.72 |    49.56 |   45.79 |   57.33 | 106-188,275-276,303,327,375-377,386-396,525,569,598-606,650-677,714-732,765-768,820-823,840-850,861,874,915-951,956,979,1001-1033,1057,1066-1067,1103-1123,1133-1154,1164-1166,1234,1248-1264,1279,1305-1306,1309,1325-1341,1364,1372-1435,1455,1475-1654,1675-1699,1769-1797,1822                   
  retention.service.js                |   92.38 |    68.33 |      95 |   92.15 | 59-62,115,206-207,258-259                                                                                                                                                                                                                                                                            
  revocation.service.js               |   91.17 |     67.5 |   94.44 |   91.83 | 78,184,232,236,292-304                                                                                                                                                                                                                                                                               
  volunteer-consent.service.js        |   87.23 |    73.52 |   86.66 |   87.23 | 91,125,137,158,189,207,237-255,286,296                                                                                                                                                                                                                                                               
 backend/src/services/safety          |   75.75 |    67.56 |   74.69 |   76.15 |                                                                                                                                                                                                                                                                                                      
  device-binding-simple.service.js    |   93.05 |    89.36 |   77.77 |   92.64 | 131,145,168,176-177                                                                                                                                                                                                                                                                                  
  device-binding.service.js           |   78.89 |    72.41 |   86.66 |   79.43 | 36,62,93,130,184,198,216,262,284,299-308,331,337,346-349,428,434,460-463                                                                                                                                                                                                                             
  errors.js                           |   84.21 |    83.33 |   83.33 |   84.21 | 32-34                                                                                                                                                                                                                                                                                                
  geofence-engine-simple.service.js   |   51.28 |    38.33 |   45.45 |   52.21 | 23,27,87,109,174-300                                                                                                                                                                                                                                                                                 
  geofence-engine.service.js          |   79.71 |    68.57 |   87.09 |   80.07 | 46,99,151,327,455,512-563,587,608,627-637,676,692,726,760,937,947-950,1002-1053                                                                                                                                                                                                                      
 backend/src/services/safety/device   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  DeviceBindingService.js             |       0 |        0 |       0 |       0 | 24-308                                                                                                                                                                                                                                                                                               
 backend/src/utils                    |    9.87 |     3.59 |   14.28 |   10.12 |                                                                                                                                                                                                                                                                                                      
  battery-optimization.js             |       0 |        0 |       0 |       0 | 10-55                                                                                                                                                                                                                                                                                                
  errors.js                           |   72.72 |    71.42 |   71.42 |   72.72 | 32-42                                                                                                                                                                                                                                                                                                
  permissions.js                      |       0 |        0 |       0 |       0 | 9-93                                                                                                                                                                                                                                                                                                 
  validation.utils.js                 |       0 |        0 |       0 |       0 | 17-513                                                                                                                                                                                                                                                                                               
 backend/tests                        |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  setup.js                            |       0 |        0 |       0 |       0 | 2-135                                                                                                                                                                                                                                                                                                
 backend/tests/helpers                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  jwt-helper.js                       |       0 |        0 |       0 |       0 | 1-83                                                                                                                                                                                                                                                                                                 
 backend/tests/integration            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  api.cases.test.js                   |       0 |      100 |       0 |       0 | 1-289                                                                                                                                                                                                                                                                                                
  api.kpi.test.js                     |       0 |      100 |       0 |       0 | 1-355                                                                                                                                                                                                                                                                                                
  api.mydata.test.js                  |       0 |      100 |       0 |       0 | 1-321                                                                                                                                                                                                                                                                                                
  api.rbac.test.js                    |       0 |        0 |       0 |       0 | 1-218                                                                                                                                                                                                                                                                                                
  middleware.test.js                  |       0 |      100 |       0 |       0 | 1-377                                                                                                                                                                                                                                                                                                
 backend/tests/setup                  |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  test-auth.js                        |       0 |        0 |       0 |       0 | 6-142                                                                                                                                                                                                                                                                                                
  test-config.js                      |       0 |        0 |       0 |       0 | 8-239                                                                                                                                                                                                                                                                                                
  test-setup.config.js                |       0 |        0 |       0 |       0 | 15-318                                                                                                                                                                                                                                                                                               
 backend/tests/unit                   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  anonymization.service.test.js       |       0 |        0 |       0 |       0 | 2-698                                                                                                                                                                                                                                                                                                
  audit.service.test.js               |       0 |      100 |       0 |       0 | 18-971                                                                                                                                                                                                                                                                                               
  ble-scanner.service.test.js         |       0 |        0 |       0 |       0 | 4-806                                                                                                                                                                                                                                                                                                
  case-flow.service.test.js           |       0 |        0 |       0 |       0 | 22-1227                                                                                                                                                                                                                                                                                              
  device-binding-green.test.js        |       0 |        0 |       0 |       0 | 6-253                                                                                                                                                                                                                                                                                                
  device-binding.service.test.js      |       0 |        0 |       0 |       0 | 1-544                                                                                                                                                                                                                                                                                                
  device-binding.test.js              |       0 |      100 |       0 |       0 | 6-239                                                                                                                                                                                                                                                                                                
  geo-alert.service.test.js           |       0 |      100 |       0 |       0 | 4-751                                                                                                                                                                                                                                                                                                
  geofence-engine-green.test.js       |       0 |        0 |       0 |       0 | 6-219                                                                                                                                                                                                                                                                                                
  geofence-engine.service.test.js     |       0 |        0 |       0 |       0 | 1-976                                                                                                                                                                                                                                                                                                
  geofence-engine.test.js             |       0 |        0 |       0 |       0 | 6-412                                                                                                                                                                                                                                                                                                
  kpi.service.test.js                 |       0 |      100 |       0 |       0 | 18-1351                                                                                                                                                                                                                                                                                              
  mydata-adapter.test.js              |       0 |        0 |       0 |       0 | 1-426                                                                                                                                                                                                                                                                                                
  rbac.service.test.js                |       0 |      100 |       0 |       0 | 20-1104                                                                                                                                                                                                                                                                                              
  retention.service.test.js           |       0 |      100 |       0 |       0 | 1-379                                                                                                                                                                                                                                                                                                
  revocation.service.test.js          |       0 |      100 |       0 |       0 | 1-393                                                                                                                                                                                                                                                                                                
  volunteer-consent.service.test.js   |       0 |      100 |       0 |       0 | 4-432                                                                                                                                                                                                                                                                                                
 mobile                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  babel.config.js                     |       0 |      100 |     100 |       0 | 1                                                                                                                                                                                                                                                                                                    
  jest.setup.js                       |       0 |        0 |       0 |       0 | 2-166                                                                                                                                                                                                                                                                                                
  metro.config.js                     |       0 |      100 |     100 |       0 | 1-11                                                                                                                                                                                                                                                                                                 
 mobile/coverage/lcov-report          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 mobile/src/services                  |   63.86 |     53.9 |   75.61 |   63.97 |                                                                                                                                                                                                                                                                                                      
  BLEBackgroundService.js             |   47.96 |    45.93 |   60.68 |   48.08 | 82-83,113,145,162,208-209,233,259,269-353,388,397-537,556-647,671-805,818-827,851,856-857,876-932,953-954,963-966,980,1006-1101,1119-1120,1137-1236,1361-1362,1391,1400-1401,1439,1452-1460,1579,1631,1665,1680-1684,1704,1722,1730,1744-1755,1772,1775-1778,1786-1788,1793-1794,1796-1797,1799-1800 
  MobileGeofenceEngine.js             |   91.41 |    78.09 |      92 |   92.07 | 66,86-87,216,296,362,373,413,421,516-517,605-606,615-617,673,730                                                                                                                                                                                                                                     
  MyDataIntegrationService.js         |   89.31 |    73.07 |      86 |   88.97 | 126-131,140-151,180,279-280,373-374,406-410                                                                                                                                                                                                                                                          
 mobile/tests/integration             |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  mobile-services.integration.test.js |       0 |      100 |       0 |       0 | 6-295                                                                                                                                                                                                                                                                                                
 mobile/tests/services                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  BLEBackgroundService.test.js        |       0 |        0 |       0 |       0 | 13-678                                                                                                                                                                                                                                                                                               
  MobileGeofenceEngine.test.js        |       0 |        0 |       0 |       0 | 13-853                                                                                                                                                                                                                                                                                               
  MyDataIntegrationService.test.js    |       0 |      100 |       0 |       0 | 13-736                                                                                                                                                                                                                                                                                               
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (50%) not met: 26.52%
Jest: "global" coverage threshold for branches (50%) not met: 31.53%
Jest: "global" coverage threshold for lines (50%) not met: 29.31%
Jest: "global" coverage threshold for functions (50%) not met: 24.96%
Summary of all failing tests
FAIL src/backend/tests/integration/middleware.test.js (6.235 s)
  â— API Middleware â€º RBAC Permission Middleware â€º should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p3-mydata-validation.test.js (7.427 s)
  â— P3 MyData Production Validation â€º OAuth2 Flow Compliance â€º should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

FAIL src/backend/tests/integration/api.cases.test.js (5.967 s)
  â— Case Flow API Endpoints â€º POST /api/v1/cases/create â€º should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "é™³å°è¯",
            "phone": "0912345678",
            "relationship": "å¥³å…’",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:08.324Z",
    +     "createdBy": "admin123",
          "description": "78æ­²é™³è€å…ˆç”Ÿåœ¨å¤§æ½¤ç™¼èµ°å¤±",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-910",
    +     "location": Object {
            "address": "æ–°ç«¹å¸‚æ±å€å…‰å¾©è·¯äºŒæ®µ101è™Ÿ",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "èº«é«˜ç´„165cmï¼Œç©¿æ·±è‰²è¡£æœ",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "é™³è€å…ˆç”Ÿ",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:08.324Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º PUT /api/v1/cases/:id/status â€º should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/search â€º should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:07.823Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:07.823Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "æ–°ç«¹å¸‚æ±å€â—‹â—‹è·¯123è™Ÿ",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "é˜¿èŒ²æµ·é»˜ç—‡ç¬¬äºŒæœŸ",
    +         "patientName": "ç‹â—‹â—‹",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    +       "workflow": Object {
    +         "currentStage": "å»ºç«‹",
    +         "nextStages": Array [
    +           "æ´¾é£",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "å»ºç«‹",
    +             "timestamp": "2025-09-18T07:25:07.823Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p4-console-rbac-validation.test.js
  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:09.981Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "æ–°ç«¹å¸‚åŒ—å€",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[â—‹Ã—]+$/,
    +     "medicalHistory": "è¼•åº¦èªçŸ¥éšœç¤™",
    +     "patientName": "â—‹â—‹â—‹",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "å¿—å·¥å”åŠ©æ¡ˆä»¶",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "å»ºç«‹",
    +     "nextStages": Array [
    +       "æ´¾é£",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "æ´¾é£",
    + Object {
    +   "currentStage": "å»ºç«‹",
        "nextStages": Array [
    -     "åŸ·è¡Œä¸­",
    -     "çµæ¡ˆ",
    +     "æ´¾é£",
        ],
    -   "previousStage": "å»ºç«‹",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "æ´¾é£",
    -       "timestamp": Any<String>,
    +       "stage": "å»ºç«‹",
    +       "timestamp": "2025-09-18T07:25:10.730Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: 'æ´¾é£',
      451 |         previousStage: 'å»ºç«‹',
      452 |         nextStages: ['åŸ·è¡Œä¸­', 'çµæ¡ˆ'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "æ³•é™¢è¦æ±‚æä¾›è­‰æ“šè³‡æ–™",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:11.205Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_F634C32BDCAB53C236B4CD2D6E6878EA_5BB680A5",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.æ‰¿è¾¦äººå“¡.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/backend/tests/integration/middleware.test.js
  â— API Middleware â€º RBAC Permission Middleware â€º should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p3-mydata-validation.test.js
  â— P3 MyData Production Validation â€º OAuth2 Flow Compliance â€º should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

FAIL src/mobile/tests/services/BLEBackgroundService.test.js
  â— BLEBackgroundService - GREEN Phase Tests â€º Android 12+ Permission Management â€º neverForLocation Mode â€º should create anonymized volunteer hits without location data

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      117 |         expect(result.gridSquare).toBeNull();
      118 |         expect(result.anonymousVolunteerId).toMatch(/^[a-f0-9-]{36}$/);
    > 119 |         expect(result.locationDataIncluded).toBe(false);
          |                                             ^
      120 |       });
      121 |     });
      122 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:119:45)

  â— BLEBackgroundService - GREEN Phase Tests â€º Android 12+ Permission Management â€º Location-Based Mode for Positioning â€º should include fuzzed location in volunteer hits

    expect(received).toEqual(expected) // deep equality

    - Expected  - 5
    + Received  + 5

    - ObjectContaining {
    -   "anonymousVolunteerId": Any<String>,
    -   "deviceHash": Any<String>,
    -   "gridSquare": "24.8068,120.9687",
    + Object {
    +   "anonymousVolunteerId": "550e8400-e29b-41d4-a716-01995bb69243",
    +   "deviceHash": "24f697a624f697a624f697a624f697a624f697a624f697a624f697a624f697a6",
    +   "gridSquare": null,
        "rssi": -70,
    -   "timestamp": StringMatching /^\d{4}-\d{2}-\d{2}T\d{2}:(00|05|10|15|20|25|30|35|40|45|50|55):00\.000Z$/,
    +   "timestamp": "2025-09-18T07:25:00.000Z",
      }

      166 |
      167 |         // Assert
    > 168 |         expect(result).toEqual(expect.objectContaining({
          |                        ^
      169 |           deviceHash: expect.any(String),
      170 |           rssi: -70,
      171 |           gridSquare: '24.8068,120.9687', // Fuzzed to 100m grid

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:168:24)

  â— BLEBackgroundService - GREEN Phase Tests â€º iOS Core Bluetooth Integration â€º State Preservation and Restoration â€º should restore state when app is relaunched

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      265 |
      266 |         // Assert
    > 267 |         expect(result.success).toBe(true);
          |                                ^
      268 |         expect(result.restored).toBe(true);
      269 |         expect(bleService.isScanning()).toBe(true);
      270 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:267:32)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should adjust scan intervals based on battery level

    expect(received).toBe(expected) // Object.is equality

    Expected: "conservative"
    Received: "aggressive"

      297 |         // Assert - When battery is low (25%)
      298 |         expect(result.success).toBe(true);
    > 299 |         expect(result.powerMode).toBe('conservative');
          |                                  ^
      300 |         expect(result.batteryLevel).toBe(0.25);
      301 |         expect(result.charging).toBe(false);
      302 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:299:34)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should use aggressive scanning when charging

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.8
    Received: undefined

      313 |         expect(result.success).toBe(true);
      314 |         expect(result.powerMode).toBe('aggressive');
    > 315 |         expect(result.batteryLevel).toBe(0.80);
          |                                     ^
      316 |         expect(result.charging).toBe(true);
      317 |       });
      318 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:315:37)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º Battery-Aware Scanning â€º should implement adaptive scanning based on discovery rate

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      329 |
      330 |         // Assert - For low discovery areas
    > 331 |         expect(result.success).toBe(true);
          |                                ^
      332 |         expect(result.strategy).toBe('minimal');
      333 |         expect(bleService.getScanParameters().scanIntervalMs).toBeGreaterThan(50000); // Very long intervals for minimal
      334 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:331:32)

  â— BLEBackgroundService - GREEN Phase Tests â€º Background Scanning Optimization â€º RSSI Filtering and Device Processing â€º should handle MAC address rotation without correlation

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      380 |
      381 |         // Assert - Each MAC treated as separate device
    > 382 |         expect(bleService.getProcessedDeviceCount()).toBe(3);
          |                                                      ^
      383 |         // No correlation maps should exist for privacy
      384 |         expect(bleService.getMacCorrelationMap).toBeUndefined();
      385 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:382:54)

  â— BLEBackgroundService - GREEN Phase Tests â€º Privacy and Anonymization â€º K-Anonymity Enforcement â€º should ensure minimum k=3 anonymity before submitting hits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      401 |
      402 |         // Assert
    > 403 |         expect(validationResult.isAnonymous).toBe(true);
          |                                              ^
      404 |         expect(validationResult.k).toBe(3);
      405 |         expect(validationResult.canSubmit).toBe(true);
      406 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:403:46)

  â— BLEBackgroundService - GREEN Phase Tests â€º Privacy and Anonymization â€º K-Anonymity Enforcement â€º should queue hits when k-anonymity threshold not met

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 1

      418 |         // Assert
      419 |         expect(validationResult.isAnonymous).toBe(false);
    > 420 |         expect(validationResult.k).toBe(2);
          |                                    ^
      421 |         expect(validationResult.canSubmit).toBe(false);
      422 |       });
      423 |     });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:420:36)

  â— BLEBackgroundService - GREEN Phase Tests â€º Backend Integration â€º Volunteer Hit Submission â€º should handle API failures gracefully with retry logic

    Network error

      510 |           callCount++;
      511 |           if (callCount <= 2) {
    > 512 |             throw new Error('Network error');
          |                   ^
      513 |           }
      514 |           return { success: true, submittedCount: 1 };
      515 |         });

      at BLEBackgroundService.<anonymous> (src/mobile/tests/services/BLEBackgroundService.test.js:512:19)
      at Object.submitVolunteerHits (src/mobile/tests/services/BLEBackgroundService.test.js:518:33)

  â— BLEBackgroundService - GREEN Phase Tests â€º Backend Integration â€º Volunteer Hit Submission â€º should queue hits offline and sync when connected

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      548 |         // Assert
      549 |         expect(syncResult.success).toBe(true);
    > 550 |         expect(syncResult.synced).toBe(2);
          |                                   ^
      551 |       });
      552 |     });
      553 |   });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:550:35)

  â— BLEBackgroundService - GREEN Phase Tests â€º Error Handling and Recovery â€º Permission Revocation â€º should stop scanning when permissions are revoked

    TypeError: bleService.isScanning is not a function

      567 |         // Assert
      568 |         expect(result.success).toBe(true);
    > 569 |         expect(bleService.isScanning()).toBe(false);
          |                           ^
      570 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
      571 |           error: 'permissions_revoked',
      572 |           userActionRequired: true

      at Object.isScanning (src/mobile/tests/services/BLEBackgroundService.test.js:569:27)

  â— BLEBackgroundService - GREEN Phase Tests â€º Error Handling and Recovery â€º Bluetooth State Changes â€º should handle Bluetooth disabled gracefully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 2

    - ObjectContaining {
    -   "bluetoothState": "PoweredOff",
    -   "canRetry": true,
    + Object {
    +   "error": null,
        "isScanning": false,
    -   "userGuidance": "è«‹é–‹å•Ÿè—ç‰™ä»¥ç¹¼çºŒæƒæ",
      }

      604 |         expect(result.canScan).toBe(false);
      605 |         expect(result.userGuidanceRequired).toBe(true);
    > 606 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
          |                                        ^
      607 |           isScanning: false,
      608 |           bluetoothState: 'PoweredOff',
      609 |           userGuidance: 'è«‹é–‹å•Ÿè—ç‰™ä»¥ç¹¼çºŒæƒæ',

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:606:40)

FAIL tests/validation/p4-console-rbac-validation.test.js
  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should prevent non-æ‰¿è¾¦ users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:14.019Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "æ–°ç«¹å¸‚åŒ—å€",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[â—‹Ã—]+$/,
    +     "medicalHistory": "è¼•åº¦èªçŸ¥éšœç¤™",
    +     "patientName": "â—‹â—‹â—‹",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "å¿—å·¥å”åŠ©æ¡ˆä»¶",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "å»ºç«‹",
    +     "nextStages": Array [
    +       "æ´¾é£",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  â— P4 æ‰¿è¾¦Console Production Validation â€º RBAC Restrictions - Non-æ‰¿è¾¦ Access Control â€º should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "æ´¾é£",
    + Object {
    +   "currentStage": "å»ºç«‹",
        "nextStages": Array [
    -     "åŸ·è¡Œä¸­",
    -     "çµæ¡ˆ",
    +     "æ´¾é£",
        ],
    -   "previousStage": "å»ºç«‹",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "æ´¾é£",
    -       "timestamp": Any<String>,
    +       "stage": "å»ºç«‹",
    +       "timestamp": "2025-09-18T07:25:14.504Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: 'æ´¾é£',
      451 |         previousStage: 'å»ºç«‹',
      452 |         nextStages: ['åŸ·è¡Œä¸­', 'çµæ¡ˆ'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Case Flow: å»ºç«‹â†’æ´¾é£â†’çµæ¡ˆ Workflow Validation â€º should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "æ³•é™¢è¦æ±‚æä¾›è­‰æ“šè³‡æ–™",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:15.095Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_ED39F3987BA4CED639A3BA1A72371603_5BB68FD7",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.æ‰¿è¾¦äººå“¡.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  â— P4 æ‰¿è¾¦Console Production Validation â€º Audit Trails with Watermarks â€º should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  â— P4 æ‰¿è¾¦Console Production Validation â€º KPI Aggregation without Drill-down â€º should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/mobile/tests/services/MyDataIntegrationService.test.js
  â— MyDataIntegrationService - GREEN Phase Tests â€º OAuth Authorization Flow â€º Token Exchange â€º should handle token exchange errors

    Token exchange failed

      160 |             userMessage: 'æˆæ¬Šé©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æˆæ¬Š'
      161 |           };
    > 162 |           throw new Error('Token exchange failed');
          |                 ^
      163 |         });
      164 |
      165 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:162:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:167:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º OAuth Authorization Flow â€º Token Exchange â€º should store access token securely and temporarily

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      180 |         const expiresIn = 3600; // 1 hour
      181 |
    > 182 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      183 |
      184 |         // Act
      185 |         const result = await myDataService.storeAccessTokenSecurely(accessToken, expiresIn);

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:182:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Consent Management â€º Consent Recording â€º should provide user-readable consent summary

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

    @@ -1,10 +1,9 @@
      Object {
        "contact": "æ–°ç«¹å¸‚æ”¿åºœè³‡è¨Šè™•",
        "dataTypes": Array [
          "åŸºæœ¬è³‡æ–™",
    -     "ç·Šæ€¥è¯çµ¡äºº",
        ],
        "purpose": "æ–°ç«¹å¸‚å®‰å¿ƒå®ˆè­·æœå‹™",
        "retention": "æœ€é•·ä¿å­˜ 30 å¤©",
        "rights": Array [
          "æ‚¨å¯éš¨æ™‚æ’¤å›åŒæ„",

      326 |
      327 |         // Assert
    > 328 |         expect(summary).toEqual({
          |                         ^
      329 |           title: 'è³‡æ–™ä½¿ç”¨åŒæ„æ›¸',
      330 |           purpose: 'æ–°ç«¹å¸‚å®‰å¿ƒå®ˆè­·æœå‹™',
      331 |           dataTypes: ['åŸºæœ¬è³‡æ–™', 'ç·Šæ€¥è¯çµ¡äºº'],

      at Object.toEqual (src/mobile/tests/services/MyDataIntegrationService.test.js:328:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Consent Management â€º Consent Revocation â€º should delete all associated data on consent revocation

    TypeError: Cannot read properties of undefined (reading 'getInternetCredentials')

      400 |         const userId = 'user-123';
      401 |         AsyncStorage.getItem.mockResolvedValue('{"name":"ç‹å°æ˜","phone":"0912345678"}');
    > 402 |         Keychain.getInternetCredentials.mockResolvedValue({
          |                  ^
      403 |           username: 'hsinchu_guardian',
      404 |           password: 'access_token_123'
      405 |         });

      at Object.getInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:402:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Security and Privacy â€º Token Security â€º should implement secure token storage with biometric protection

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      551 |         const sensitiveToken = 'highly_sensitive_access_token_12345';
      552 |
    > 553 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      554 |         Keychain.SECURITY_LEVEL = {
      555 |           SECURE_HARDWARE: 'SECURE_HARDWARE'
      556 |         };

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:553:18)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Security and Privacy â€º Data Encryption â€º should encrypt all stored personal data

    SyntaxError: Bad escaped character in JSON at position 12 (line 1 column 13)
        at JSON.parse (<anonymous>)

      392 |     const hex = encrypted.match(/.{2}/g).map(h => String.fromCharCode(parseInt(h, 16))).join('');
      393 |     const data = hex.split('_encrypted_with_')[0];
    > 394 |     return JSON.parse(data);
          |                 ^
      395 |   }
      396 |
      397 |   getUserEncryptionKey(userId) {

      at MyDataIntegrationService.parse [as decryptPersonalData] (src/mobile/src/services/MyDataIntegrationService.js:394:17)
      at Object.decryptPersonalData (src/mobile/tests/services/MyDataIntegrationService.test.js:600:47)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Error Handling and Edge Cases â€º OAuth Flow Errors â€º should handle network failures during OAuth

    Network request failed

      639 |             canRetry: true
      640 |           };
    > 641 |           throw new Error('Network request failed');
          |                 ^
      642 |         });
      643 |
      644 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:641:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:646:25)

  â— MyDataIntegrationService - GREEN Phase Tests â€º Error Handling and Edge Cases â€º Data Processing Errors â€º should handle API rate limiting gracefully

    Rate limit exceeded

      690 |             userMessage: 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
      691 |           };
    > 692 |           throw new Error('Rate limit exceeded');
          |                 ^
      693 |         });
      694 |
      695 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:692:17)
      at Object.fetchUserProfile (src/mobile/tests/services/MyDataIntegrationService.test.js:697:25)

FAIL src/backend/tests/integration/api.cases.test.js
  â— Case Flow API Endpoints â€º POST /api/v1/cases/create â€º should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "é™³å°è¯",
            "phone": "0912345678",
            "relationship": "å¥³å…’",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:16.906Z",
    +     "createdBy": "admin123",
          "description": "78æ­²é™³è€å…ˆç”Ÿåœ¨å¤§æ½¤ç™¼èµ°å¤±",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-283",
    +     "location": Object {
            "address": "æ–°ç«¹å¸‚æ±å€å…‰å¾©è·¯äºŒæ®µ101è™Ÿ",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "èº«é«˜ç´„165cmï¼Œç©¿æ·±è‰²è¡£æœ",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "é™³è€å…ˆç”Ÿ",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:16.906Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/:id â€º should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º PUT /api/v1/cases/:id/status â€º should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º GET /api/v1/cases/search â€º should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:16.589Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:16.589Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "æ–°ç«¹å¸‚æ±å€â—‹â—‹è·¯123è™Ÿ",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "é˜¿èŒ²æµ·é»˜ç—‡ç¬¬äºŒæœŸ",
    +         "patientName": "ç‹â—‹â—‹",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "å¤±æ™ºé•·è€…èµ°å¤±æ¡ˆä»¶",
    +       "workflow": Object {
    +         "currentStage": "å»ºç«‹",
    +         "nextStages": Array [
    +           "æ´¾é£",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "å»ºç«‹",
    +             "timestamp": "2025-09-18T07:25:16.589Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  â— Case Flow API Endpoints â€º POST /api/v1/cases/:id/assign â€º should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)


Test Suites: 10 failed, 47 passed, 57 total
Tests:       65 failed, 1318 passed, 1383 total
Snapshots:   0 total
Time:        55.822 s, estimated 66 s
Ran all test suites in 3 projects.
