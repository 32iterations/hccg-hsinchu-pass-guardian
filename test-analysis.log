
> hccg-hsinchu-pass-guardian@2.0.0 test
> jest --coverage --coverage --verbose

[0mGET /api/v1/rbac/roles [33m401[0m 2.485 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.461 ms - 77[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.276 ms - 70[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.666 ms - 74[0m
[0mGET /api/v1/test/user-info [32m200[0m 8.764 ms - 106[0m
[0mGET /api/v1/rbac/roles [32m200[0m 0.767 ms - -[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.698 ms - 125[0m
[0mGET /api/v1/cases/other-user-case [33m404[0m 14.445 ms - 64[0m
[0mGET /api/v1/cases/search [32m200[0m 1.424 ms - -[0m
[0mPOST /api/v1/cases/create [33m400[0m 2.309 ms - 380[0m
[0mPOST /api/v1/cases/create [33m400[0m 1.912 ms - 465[0m
[0mGET /api/v1/cases/search?page=invalid&limit=-1 [33m400[0m 15.501 ms - 198[0m
[0mPOST /api/v1/cases/create [32m201[0m 2.935 ms - 513[0m
[0mGET /api/v1/nonexistent [33m404[0m 30.182 ms - 115[0m
[0mGET /api/v1/test/error [31m500[0m 11.229 ms - 141[0m
[0mGET /api/v1/test/database-error [31m500[0m 10.057 ms - 141[0m
[0mGET /api/v1/test/error [31m500[0m 7.272 ms - 141[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.374 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.415 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.326 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.286 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.306 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.258 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.403 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.309 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.305 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.333 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.354 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.358 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.369 ms - 74[0m
FAIL backend src/backend/tests/integration/middleware.test.js (6.235 s)
  API Middleware
    Authentication Middleware
      ✓ should reject requests without authorization header (196 ms)
      ✓ should reject requests with invalid JWT token (19 ms)
      ✓ should reject requests with expired JWT token (29 ms)
      ✓ should accept requests with valid JWT token (12 ms)
      ✓ should extract user information from JWT token (28 ms)
    RBAC Permission Middleware
      ✓ should allow access with sufficient permissions (49 ms)
      ✓ should deny access without sufficient permissions (5 ms)
      ✕ should check resource-specific permissions (19 ms)
      ✓ should handle role hierarchy correctly (28 ms)
    Request Validation Middleware
      ✓ should validate required fields in POST requests (49 ms)
      ✓ should validate field types and formats (19 ms)
      ✓ should validate query parameters (21 ms)
      ✓ should sanitize input data (9 ms)
    Error Handling Middleware
      ✓ should handle 404 errors for non-existent endpoints (61 ms)
      ✓ should handle internal server errors gracefully (20 ms)
      ✓ should not expose sensitive error details in production (15 ms)
      ✓ should log errors with appropriate context (33 ms)
    Rate Limiting Middleware
      ✓ should allow requests within rate limit (31 ms)
      ✓ should reject requests exceeding rate limit (229 ms)
      ✓ should include rate limit headers (3 ms)
    CORS Middleware
      ✓ should include CORS headers for valid origins (50 ms)
      ✓ should handle preflight OPTIONS requests (4 ms)
      ✓ should reject requests from unauthorized origins (3 ms)
    Security Headers Middleware
      ✓ should include security headers in all responses (5 ms)
      ✓ should set appropriate content security policy (44 ms)

  ● API Middleware › RBAC Permission Middleware › should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/mydata/authorize?userId=oauth-test-user&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=oauth2-csrf-token-123 [32m200[0m 84.355 ms - 510[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 1.294 ms - 322[0m
[0mPOST /api/v1/cases/create [32m201[0m 69.422 ms - 616[0m
[0mPOST /api/v1/cases/create [33m400[0m 2.974 ms - 380[0m
PASS validation tests/validation/p2-volunteer-ble-validation.test.js
  P2 志工BLE Production Validation
    Android 12+ Permission Management with neverForLocation
      ✓ should request ONLY BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (2 ms)
      ✓ should configure BLE scanning without location inference (3 ms)
      ✓ should handle manifest declaration validation for neverForLocation (1 ms)
      ✓ should create anonymized volunteer hits without any location data (23 ms)
      ✓ should validate Android 12+ runtime permission flow (1 ms)
    iOS State Preservation/Restoration Validation
      ✓ should initialize with proper Core Bluetooth configuration (13 ms)
      ✓ should save complete state when app backgrounded (8 ms)
      ✓ should restore state correctly when app relaunched (1 ms)
      ✓ should handle iOS background app refresh settings (1 ms)
      ✓ should validate iOS State Preservation across app lifecycle (1 ms)
    VolunteerHit Anonymization with NO PII Exposure
      ✓ should ensure absolute PII protection in volunteer hits (27 ms)
      ✓ should implement salted hashing for device identification (1 ms)
      ✓ should enforce K-anonymity before submitting volunteer hits (1 ms)
      ✓ should validate complete anonymization pipeline (2 ms)
    BLE Background Scanning Capabilities
      ✓ should maintain background scanning under battery optimization (1 ms)
      ✓ should handle BLE state changes gracefully (33 ms)
      ✓ should implement adaptive scanning based on discovery rate (1 ms)
      ✓ should validate production BLE integration with backend (1 ms)
    Production Error Handling and Recovery
      ✓ should handle permission revocation gracefully (1 ms)
      ✓ should recover from temporary BLE failures (18 ms)

[0mPOST /api/v1/cases/create [33m400[0m 27.981 ms - 228[0m
[0mPOST /api/v1/cases/create [33m401[0m 0.427 ms - 85[0m
[0mGET /api/v1/cases/case123 [33m404[0m 12.202 ms - 64[0m
[0mGET /api/v1/cases/nonexistent [33m404[0m 0.839 ms - 64[0m
[0mGET /api/v1/cases/case123 [33m404[0m 0.741 ms - 64[0m
FAIL validation tests/validation/p3-mydata-validation.test.js (7.427 s)
  P3 MyData Production Validation
    Contract Tests for Callback Schema Validation
      ✓ should validate MyData Taiwan authorization callback schema (39 ms)
      ✓ should reject malformed callback schemas (15 ms)
      ✓ should validate OAuth2 PKCE extension for mobile apps (9 ms)
      ✓ should handle real-time callback validation with Taiwan MyData API (1 ms)
    TTL (Time To Live) Functionality
      ✓ should enforce TTL on MyData access tokens (8 ms)
      ✓ should automatically expire and clean up TTL data (1203 ms)
      ✓ should handle TTL extension for active consents (1 ms)
      ✓ should enforce maximum TTL limits per data type (3 ms)
    Data Deletion on Revocation (撤回即刪)
      ✓ should immediately delete all user data upon revocation (13 ms)
      ✓ should handle cross-service data deletion coordination (4 ms)
      ✓ should maintain deletion audit trail while removing personal data (31 ms)
      ✓ should handle partial deletion failures gracefully (6 ms)
    OAuth2 Flow Compliance
      ✕ should implement complete OAuth2 authorization code flow (206 ms)
      ✓ should handle OAuth2 error scenarios correctly (4 ms)
      ✓ should implement secure token refresh mechanism (1 ms)
      ✓ should validate Taiwan MyData API integration compliance (1 ms)

  ● P3 MyData Production Validation › OAuth2 Flow Compliance › should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

[0mPUT /api/v1/cases/case123/status [33m404[0m 1.125 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m400[0m 0.701 ms - 77[0m
[0mPUT /api/v1/cases/case123/status [33m403[0m 0.526 ms - 96[0m
[0mGET /api/v1/cases/search?status=active&priority=high&location=%E6%96%B0%E7%AB%B9%E5%B8%82&radius=5000 [32m200[0m 1.469 ms - 816[0m
[0mGET /api/v1/cases/search?lat=24.8138&lng=120.9675&radius=10000 [32m200[0m 0.967 ms - -[0m
[0mGET /api/v1/cases/search?page=2&limit=20 [32m200[0m 0.859 ms - -[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 1.284 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.914 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.813 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m403[0m 0.452 ms - 90[0m
FAIL frontend src/backend/tests/integration/api.cases.test.js (5.967 s)
  Case Flow API Endpoints
    POST /api/v1/cases/create
      ✕ should create a new case successfully (312 ms)
      ✓ should validate required fields (74 ms)
      ✓ should validate location coordinates (46 ms)
      ✓ should require authentication (16 ms)
    GET /api/v1/cases/:id
      ✕ should return case details for authorized user (58 ms)
      ✓ should return 404 for non-existent case (21 ms)
      ✕ should enforce access control based on case ownership (21 ms)
    PUT /api/v1/cases/:id/status
      ✕ should update case status successfully (6 ms)
      ✓ should validate status transitions (40 ms)
      ✓ should require appropriate permissions for status updates (49 ms)
    GET /api/v1/cases/search
      ✕ should search cases with filters (51 ms)
      ✓ should support geographic search (26 ms)
      ✓ should support pagination (20 ms)
    POST /api/v1/cases/:id/assign
      ✕ should assign case to volunteer successfully (6 ms)
      ✓ should validate assignee exists and is eligible (16 ms)
      ✕ should check volunteer availability (6 ms)
      ✓ should require case management permissions (21 ms)

  ● Case Flow API Endpoints › POST /api/v1/cases/create › should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "陳小華",
            "phone": "0912345678",
            "relationship": "女兒",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:08.324Z",
    +     "createdBy": "admin123",
          "description": "78歲陳老先生在大潤發走失",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-910",
    +     "location": Object {
            "address": "新竹市東區光復路二段101號",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "身高約165cm，穿深色衣服",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "陳老先生",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "失智長者走失案件",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:08.324Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › PUT /api/v1/cases/:id/status › should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/search › should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:07.823Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:07.823Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "新竹市東區○○路123號",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "阿茲海默症第二期",
    +         "patientName": "王○○",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "失智長者走失案件",
    +       "workflow": Object {
    +         "currentStage": "建立",
    +         "nextStages": Array [
    +           "派遣",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "建立",
    +             "timestamp": "2025-09-18T07:25:07.823Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 13.142 ms - 706[0m
[0mGET /api/v1/cases/CASE-2025-002 [32m200[0m 2.174 ms - 542[0m
[0mPOST /api/v1/cases/export [33m403[0m 3.922 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 20.916 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 2.832 ms - 155[0m
[0mPOST /api/v1/cases [32m201[0m 35.296 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-030/assign [32m200[0m 2.673 ms - 1004[0m
[0mPOST /api/v1/cases [32m201[0m 1.924 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-515/close [33m400[0m 39.298 ms - 193[0m
[0mGET /api/v1/rbac/roles [33m401[0m 3.973 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.325 ms - 77[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.334 ms - 70[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 24.798 ms - 814[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.847 ms - 74[0m
[0mGET /api/v1/cases/CASE-2025-001/history [32m200[0m 3.362 ms - 326[0m
[0mGET /api/v1/test/user-info [32m200[0m 21.714 ms - 106[0m
[0mGET /api/v1/rbac/roles [32m200[0m 0.776 ms - -[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.766 ms - 125[0m
[0mGET /api/v1/cases/other-user-case [33m404[0m 0.651 ms - 64[0m
[0mPOST /api/v1/cases/search [33m404[0m 98.391 ms - 116[0m
[0mGET /api/v1/cases/search [32m200[0m 0.766 ms - -[0m
[0mPOST /api/v1/cases/export [32m200[0m 3.013 ms - 313[0m
[0mPOST /api/v1/cases/create [33m400[0m 23.975 ms - 380[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 12.735 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 1.919 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 2.176 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 8.498 ms - 814[0m
[0mPOST /api/v1/cases/create [33m400[0m 9.844 ms - 465[0m
[0mGET /api/v1/kpi/dashboard?period=30_days&department=all&includeBreakdowns=false [33m403[0m 6.948 ms - 94[0m
[0mGET /api/v1/cases/search?page=invalid&limit=-1 [33m400[0m 29.920 ms - 198[0m
[0mGET /api/v1/kpi/detailed?includeIndividualCases=true&showPersonalData=true&drillDown=case_level [32m200[0m 2.079 ms - 250[0m
[0mPOST /api/v1/cases/create [32m201[0m 1.247 ms - 513[0m
[0mGET /api/v1/kpi/role-specific [32m200[0m 2.293 ms - -[0m
[0mGET /api/v1/kpi/temporal?period=90_days&granularity=weekly&anonymized=true [33m403[0m 1.846 ms - 96[0m
[0mGET /api/v1/nonexistent [33m404[0m 37.028 ms - 115[0m
[0mGET /api/v1/test/error [31m500[0m 3.373 ms - 141[0m
[0mGET /api/v1/test/database-error [31m500[0m 1.618 ms - 141[0m
[0mGET /api/v1/test/error [31m500[0m 1.959 ms - 141[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.358 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.346 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.423 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.531 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.527 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.394 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.558 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 14.357 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.396 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.411 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.395 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.367 ms - 74[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.450 ms - 74[0m
FAIL validation tests/validation/p4-console-rbac-validation.test.js
  P4 承辦Console Production Validation
    RBAC Restrictions - Non-承辦 Access Control
      ✕ should prevent non-承辦 users from accessing sensitive personal data (83 ms)
      ✕ should provide filtered data based on user clearance level (45 ms)
      ✕ should enforce field-level access control (38 ms)
      ✓ should prevent data export by unauthorized users (139 ms)
    Case Flow: 建立→派遣→結案 Workflow Validation
      ✕ should enforce complete case creation workflow (75 ms)
      ✓ should prevent workflow stage skipping (66 ms)
      ✕ should enforce role-based workflow permissions (76 ms)
      ✕ should validate workflow state transitions (8 ms)
    Audit Trails with Watermarks
      ✕ should create watermarked audit entries for all read operations (227 ms)
      ✕ should create enhanced audit trails for export operations (39 ms)
      ✕ should maintain audit chain integrity (57 ms)
    KPI Aggregation without Drill-down
      ✕ should provide aggregated KPI data without detailed breakdowns (31 ms)
      ✕ should prevent access to individual case data through KPI endpoints (20 ms)
      ✕ should provide role-appropriate KPI views (47 ms)
      ✕ should anonymize and aggregate temporal KPI data (58 ms)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should prevent non-承辦 users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:09.981Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "新竹市北區",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[○×]+$/,
    +     "medicalHistory": "輕度認知障礙",
    +     "patientName": "○○○",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "志工協助案件",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "建立",
    +     "nextStages": Array [
    +       "派遣",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "派遣",
    + Object {
    +   "currentStage": "建立",
        "nextStages": Array [
    -     "執行中",
    -     "結案",
    +     "派遣",
        ],
    -   "previousStage": "建立",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "派遣",
    -       "timestamp": Any<String>,
    +       "stage": "建立",
    +       "timestamp": "2025-09-18T07:25:10.730Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: '派遣',
      451 |         previousStage: '建立',
      452 |         nextStages: ['執行中', '結案'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "法院要求提供證據資料",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:11.205Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_F634C32BDCAB53C236B4CD2D6E6878EA_5BB680A5",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.承辦人員.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL frontend src/backend/tests/integration/middleware.test.js
  API Middleware
    Authentication Middleware
      ✓ should reject requests without authorization header (70 ms)
      ✓ should reject requests with invalid JWT token (28 ms)
      ✓ should reject requests with expired JWT token (24 ms)
      ✓ should accept requests with valid JWT token (25 ms)
      ✓ should extract user information from JWT token (73 ms)
    RBAC Permission Middleware
      ✓ should allow access with sufficient permissions (20 ms)
      ✓ should deny access without sufficient permissions (14 ms)
      ✕ should check resource-specific permissions (8 ms)
      ✓ should handle role hierarchy correctly (44 ms)
    Request Validation Middleware
      ✓ should validate required fields in POST requests (50 ms)
      ✓ should validate field types and formats (46 ms)
      ✓ should validate query parameters (34 ms)
      ✓ should sanitize input data (62 ms)
    Error Handling Middleware
      ✓ should handle 404 errors for non-existent endpoints (68 ms)
      ✓ should handle internal server errors gracefully (44 ms)
      ✓ should not expose sensitive error details in production (6 ms)
      ✓ should log errors with appropriate context (55 ms)
    Rate Limiting Middleware
      ✓ should allow requests within rate limit (158 ms)
      ✓ should reject requests exceeding rate limit (629 ms)
      ✓ should include rate limit headers (17 ms)
    CORS Middleware
      ✓ should include CORS headers for valid origins (3 ms)
      ✓ should handle preflight OPTIONS requests (17 ms)
      ✓ should reject requests from unauthorized origins (3 ms)
    Security Headers Middleware
      ✓ should include security headers in all responses (16 ms)
      ✓ should set appropriate content security policy (3 ms)

  ● API Middleware › RBAC Permission Middleware › should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

[0mGET /api/v1/kpi/dashboard [32m200[0m 0.753 ms - 892[0m
[0mGET /api/v1/kpi/dashboard?startDate=2023-01-01&endDate=2023-12-31 [32m200[0m 0.457 ms - 892[0m
[0mGET /api/v1/kpi/dashboard [33m403[0m 0.375 ms - 94[0m
[0mGET /api/v1/kpi/dashboard?useCache=true [32m200[0m 0.425 ms - 892[0m
[0mGET /api/v1/kpi/metrics/cases [32m200[0m 1.079 ms - 624[0m
[0mGET /api/v1/kpi/metrics/volunteers [32m200[0m 1.766 ms - 664[0m
[0mGET /api/v1/kpi/metrics/system [32m200[0m 0.484 ms - 582[0m
[0mGET /api/v1/kpi/metrics/compliance [32m200[0m 1.801 ms - 518[0m
[0mGET /api/v1/kpi/metrics/invalid-type [33m400[0m 0.402 ms - 131[0m
[0mGET /api/v1/kpi/metrics/cases?startDate=2023-01-01&endDate=2023-01-31&granularity=daily [32m200[0m 0.456 ms - 623[0m
[0mGET /api/v1/kpi/metrics/cases?aggregation=weekly&region=%E6%96%B0%E7%AB%B9%E5%B8%82%E6%9D%B1%E5%8D%80 [32m200[0m 0.442 ms - 622[0m
[0mGET /api/v1/kpi/reports/compliance [32m200[0m 3.015 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?format=pdf [32m200[0m 2.760 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?period=monthly&year=2023&month=10 [32m200[0m 2.688 ms - 994[0m
[0mGET /api/v1/kpi/reports/compliance?includeRegulatory=true [32m200[0m 1.440 ms - -[0m
[0mGET /api/v1/kpi/reports/compliance [33m403[0m 2.659 ms - 99[0m
[0mGET /api/v1/kpi/alerts [32m200[0m 3.043 ms - 745[0m
[0mGET /api/v1/kpi/alerts?severity=critical [32m200[0m 14.030 ms - 100[0m
[0mGET /api/v1/kpi/alerts?type=performance [32m200[0m 0.523 ms - 318[0m
[0mPOST /api/v1/kpi/reports/generate [32m202[0m 0.760 ms - 173[0m
[0mGET /api/v1/mydata/authorize?userId=oauth-test-user&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=oauth2-csrf-token-123 [32m200[0m 41.193 ms - 510[0m
[0mPOST /api/v1/kpi/reports/generate [33m400[0m 19.631 ms - 92[0m
[0mPOST /api/v1/kpi/reports/generate [33m403[0m 0.354 ms - 98[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 2.956 ms - 322[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 8.218 ms - 706[0m
[0mGET /api/v1/cases/CASE-2025-002 [32m200[0m 4.259 ms - 542[0m
[0mPOST /api/v1/cases/export [33m403[0m 8.936 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 13.423 ms - 155[0m
[0mPOST /api/v1/cases/export [33m403[0m 19.817 ms - 155[0m
[0mPOST /api/v1/cases [32m201[0m 15.271 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-556/assign [32m200[0m 20.493 ms - 1004[0m
[0mPOST /api/v1/cases [32m201[0m 4.114 ms - 357[0m
[0mPOST /api/v1/cases/CASE-2025-586/close [33m400[0m 14.457 ms - 193[0m
PASS backend src/backend/tests/integration/api.kpi.test.js
  KPI API Endpoints
    GET /api/v1/kpi/dashboard
      ✓ should return comprehensive dashboard metrics (26 ms)
      ✓ should support time range filtering (21 ms)
      ✓ should require admin permissions (4 ms)
      ✓ should return cached data when available (3 ms)
    GET /api/v1/kpi/metrics/:type
      ✓ should return case management metrics (46 ms)
      ✓ should return volunteer performance metrics (7 ms)
      ✓ should return system performance metrics (13 ms)
      ✓ should return compliance metrics (37 ms)
      ✓ should validate metric type parameter (7 ms)
      ✓ should support custom date ranges (6 ms)
      ✓ should support different aggregation levels (20 ms)
    GET /api/v1/kpi/reports/compliance
      ✓ should generate comprehensive compliance report (20 ms)
      ✓ should support different report formats (13 ms)
      ✓ should generate monthly compliance reports (15 ms)
      ✓ should include regulatory compliance details (18 ms)
      ✓ should require appropriate permissions for compliance reports (11 ms)
    GET /api/v1/kpi/alerts
      ✓ should return active system alerts (30 ms)
      ✓ should filter alerts by severity (38 ms)
      ✓ should filter alerts by type (20 ms)
    POST /api/v1/kpi/reports/generate
      ✓ should generate custom reports (19 ms)
      ✓ should validate report parameters (34 ms)
      ✓ should require admin permissions for report generation (42 ms)

[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 5.302 ms - 814[0m
FAIL frontend tests/validation/p3-mydata-validation.test.js
  P3 MyData Production Validation
    Contract Tests for Callback Schema Validation
      ✓ should validate MyData Taiwan authorization callback schema (2 ms)
      ✓ should reject malformed callback schemas (2 ms)
      ✓ should validate OAuth2 PKCE extension for mobile apps
      ✓ should handle real-time callback validation with Taiwan MyData API (9 ms)
    TTL (Time To Live) Functionality
      ✓ should enforce TTL on MyData access tokens (1 ms)
      ✓ should automatically expire and clean up TTL data (1201 ms)
      ✓ should handle TTL extension for active consents (1 ms)
      ✓ should enforce maximum TTL limits per data type (3 ms)
    Data Deletion on Revocation (撤回即刪)
      ✓ should immediately delete all user data upon revocation (1 ms)
      ✓ should handle cross-service data deletion coordination (2 ms)
      ✓ should maintain deletion audit trail while removing personal data (2 ms)
      ✓ should handle partial deletion failures gracefully (9 ms)
    OAuth2 Flow Compliance
      ✕ should implement complete OAuth2 authorization code flow (154 ms)
      ✓ should handle OAuth2 error scenarios correctly (9 ms)
      ✓ should implement secure token refresh mechanism (5 ms)
      ✓ should validate Taiwan MyData API integration compliance (2 ms)

  ● P3 MyData Production Validation › OAuth2 Flow Compliance › should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

[0mGET /api/v1/cases/CASE-2025-001/history [32m200[0m 30.897 ms - 326[0m
[0mPOST /api/v1/cases/search [33m404[0m 104.149 ms - 116[0m
[0mPOST /api/v1/cases/export [32m200[0m 29.625 ms - 313[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 41.755 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 1.943 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 7.351 ms - 814[0m
[0mGET /api/v1/cases/CASE-2025-001 [32m200[0m 3.621 ms - 814[0m
[0mGET /api/v1/kpi/dashboard?period=30_days&department=all&includeBreakdowns=false [33m403[0m 1.750 ms - 94[0m
[0mGET /api/v1/kpi/detailed?includeIndividualCases=true&showPersonalData=true&drillDown=case_level [32m200[0m 1.945 ms - 250[0m
[0mGET /api/v1/kpi/role-specific [32m200[0m 22.191 ms - -[0m
[0mGET /api/v1/kpi/temporal?period=90_days&granularity=weekly&anonymized=true [33m403[0m 31.042 ms - 96[0m
FAIL frontend src/mobile/tests/services/BLEBackgroundService.test.js
  BLEBackgroundService - GREEN Phase Tests
    Android 12+ Permission Management
      neverForLocation Mode
        ✓ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (4 ms)
        ✓ should scan for devices without location inference (3 ms)
        ✕ should create anonymized volunteer hits without location data (11 ms)
      Location-Based Mode for Positioning
        ✓ should request location permissions when positioning enabled (47 ms)
        ✕ should include fuzzed location in volunteer hits (16 ms)
        ✓ should fuzz coordinates to 100m grid squares (1 ms)
        ✓ should round timestamps to 5-minute intervals (1 ms)
    iOS Core Bluetooth Integration
      State Preservation and Restoration
        ✓ should initialize with bluetooth-central background mode (2 ms)
        ✓ should save state when app is backgrounded (1 ms)
        ✕ should restore state when app is relaunched (1 ms)
        ✓ should handle iOS background app refresh settings (1 ms)
    Background Scanning Optimization
      Battery-Aware Scanning
        ✕ should adjust scan intervals based on battery level (2 ms)
        ✕ should use aggressive scanning when charging (1 ms)
        ✕ should implement adaptive scanning based on discovery rate (1 ms)
      RSSI Filtering and Device Processing
        ✓ should process devices with RSSI stronger than -90 dBm (1 ms)
        ✓ should ignore devices weaker than -90 dBm
        ✕ should handle MAC address rotation without correlation (1 ms)
    Privacy and Anonymization
      K-Anonymity Enforcement
        ✕ should ensure minimum k=3 anonymity before submitting hits (1 ms)
        ✕ should queue hits when k-anonymity threshold not met (1 ms)
      PII Protection
        ✓ should never store original MAC addresses (2 ms)
        ✓ should use salted hashes for device identification (1 ms)
    Backend Integration
      Volunteer Hit Submission
        ✓ should submit anonymized hits to backend API (5 ms)
        ✕ should handle API failures gracefully with retry logic (1 ms)
        ✕ should queue hits offline and sync when connected (1 ms)
    Error Handling and Recovery
      Permission Revocation
        ✕ should stop scanning when permissions are revoked (1 ms)
        ✓ should preserve queued data when permissions lost
      Bluetooth State Changes
        ✕ should handle Bluetooth disabled gracefully (10 ms)
        ✓ should resume scanning when Bluetooth re-enabled (1 ms)
    Integration with Device Binding
      Care Recipient Device Detection
        ✓ should prioritize scanning for registered care recipient devices (3 ms)
        ✓ should trigger immediate alerts for priority device detection (21 ms)

  ● BLEBackgroundService - GREEN Phase Tests › Android 12+ Permission Management › neverForLocation Mode › should create anonymized volunteer hits without location data

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      117 |         expect(result.gridSquare).toBeNull();
      118 |         expect(result.anonymousVolunteerId).toMatch(/^[a-f0-9-]{36}$/);
    > 119 |         expect(result.locationDataIncluded).toBe(false);
          |                                             ^
      120 |       });
      121 |     });
      122 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:119:45)

  ● BLEBackgroundService - GREEN Phase Tests › Android 12+ Permission Management › Location-Based Mode for Positioning › should include fuzzed location in volunteer hits

    expect(received).toEqual(expected) // deep equality

    - Expected  - 5
    + Received  + 5

    - ObjectContaining {
    -   "anonymousVolunteerId": Any<String>,
    -   "deviceHash": Any<String>,
    -   "gridSquare": "24.8068,120.9687",
    + Object {
    +   "anonymousVolunteerId": "550e8400-e29b-41d4-a716-01995bb69243",
    +   "deviceHash": "24f697a624f697a624f697a624f697a624f697a624f697a624f697a624f697a6",
    +   "gridSquare": null,
        "rssi": -70,
    -   "timestamp": StringMatching /^\d{4}-\d{2}-\d{2}T\d{2}:(00|05|10|15|20|25|30|35|40|45|50|55):00\.000Z$/,
    +   "timestamp": "2025-09-18T07:25:00.000Z",
      }

      166 |
      167 |         // Assert
    > 168 |         expect(result).toEqual(expect.objectContaining({
          |                        ^
      169 |           deviceHash: expect.any(String),
      170 |           rssi: -70,
      171 |           gridSquare: '24.8068,120.9687', // Fuzzed to 100m grid

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:168:24)

  ● BLEBackgroundService - GREEN Phase Tests › iOS Core Bluetooth Integration › State Preservation and Restoration › should restore state when app is relaunched

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      265 |
      266 |         // Assert
    > 267 |         expect(result.success).toBe(true);
          |                                ^
      268 |         expect(result.restored).toBe(true);
      269 |         expect(bleService.isScanning()).toBe(true);
      270 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:267:32)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should adjust scan intervals based on battery level

    expect(received).toBe(expected) // Object.is equality

    Expected: "conservative"
    Received: "aggressive"

      297 |         // Assert - When battery is low (25%)
      298 |         expect(result.success).toBe(true);
    > 299 |         expect(result.powerMode).toBe('conservative');
          |                                  ^
      300 |         expect(result.batteryLevel).toBe(0.25);
      301 |         expect(result.charging).toBe(false);
      302 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:299:34)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should use aggressive scanning when charging

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.8
    Received: undefined

      313 |         expect(result.success).toBe(true);
      314 |         expect(result.powerMode).toBe('aggressive');
    > 315 |         expect(result.batteryLevel).toBe(0.80);
          |                                     ^
      316 |         expect(result.charging).toBe(true);
      317 |       });
      318 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:315:37)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should implement adaptive scanning based on discovery rate

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      329 |
      330 |         // Assert - For low discovery areas
    > 331 |         expect(result.success).toBe(true);
          |                                ^
      332 |         expect(result.strategy).toBe('minimal');
      333 |         expect(bleService.getScanParameters().scanIntervalMs).toBeGreaterThan(50000); // Very long intervals for minimal
      334 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:331:32)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › RSSI Filtering and Device Processing › should handle MAC address rotation without correlation

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      380 |
      381 |         // Assert - Each MAC treated as separate device
    > 382 |         expect(bleService.getProcessedDeviceCount()).toBe(3);
          |                                                      ^
      383 |         // No correlation maps should exist for privacy
      384 |         expect(bleService.getMacCorrelationMap).toBeUndefined();
      385 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:382:54)

  ● BLEBackgroundService - GREEN Phase Tests › Privacy and Anonymization › K-Anonymity Enforcement › should ensure minimum k=3 anonymity before submitting hits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      401 |
      402 |         // Assert
    > 403 |         expect(validationResult.isAnonymous).toBe(true);
          |                                              ^
      404 |         expect(validationResult.k).toBe(3);
      405 |         expect(validationResult.canSubmit).toBe(true);
      406 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:403:46)

  ● BLEBackgroundService - GREEN Phase Tests › Privacy and Anonymization › K-Anonymity Enforcement › should queue hits when k-anonymity threshold not met

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 1

      418 |         // Assert
      419 |         expect(validationResult.isAnonymous).toBe(false);
    > 420 |         expect(validationResult.k).toBe(2);
          |                                    ^
      421 |         expect(validationResult.canSubmit).toBe(false);
      422 |       });
      423 |     });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:420:36)

  ● BLEBackgroundService - GREEN Phase Tests › Backend Integration › Volunteer Hit Submission › should handle API failures gracefully with retry logic

    Network error

      510 |           callCount++;
      511 |           if (callCount <= 2) {
    > 512 |             throw new Error('Network error');
          |                   ^
      513 |           }
      514 |           return { success: true, submittedCount: 1 };
      515 |         });

      at BLEBackgroundService.<anonymous> (src/mobile/tests/services/BLEBackgroundService.test.js:512:19)
      at Object.submitVolunteerHits (src/mobile/tests/services/BLEBackgroundService.test.js:518:33)

  ● BLEBackgroundService - GREEN Phase Tests › Backend Integration › Volunteer Hit Submission › should queue hits offline and sync when connected

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      548 |         // Assert
      549 |         expect(syncResult.success).toBe(true);
    > 550 |         expect(syncResult.synced).toBe(2);
          |                                   ^
      551 |       });
      552 |     });
      553 |   });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:550:35)

  ● BLEBackgroundService - GREEN Phase Tests › Error Handling and Recovery › Permission Revocation › should stop scanning when permissions are revoked

    TypeError: bleService.isScanning is not a function

      567 |         // Assert
      568 |         expect(result.success).toBe(true);
    > 569 |         expect(bleService.isScanning()).toBe(false);
          |                           ^
      570 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
      571 |           error: 'permissions_revoked',
      572 |           userActionRequired: true

      at Object.isScanning (src/mobile/tests/services/BLEBackgroundService.test.js:569:27)

  ● BLEBackgroundService - GREEN Phase Tests › Error Handling and Recovery › Bluetooth State Changes › should handle Bluetooth disabled gracefully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 2

    - ObjectContaining {
    -   "bluetoothState": "PoweredOff",
    -   "canRetry": true,
    + Object {
    +   "error": null,
        "isScanning": false,
    -   "userGuidance": "請開啟藍牙以繼續掃描",
      }

      604 |         expect(result.canScan).toBe(false);
      605 |         expect(result.userGuidanceRequired).toBe(true);
    > 606 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
          |                                        ^
      607 |           isScanning: false,
      608 |           bluetoothState: 'PoweredOff',
      609 |           userGuidance: '請開啟藍牙以繼續掃描',

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:606:40)

FAIL frontend tests/validation/p4-console-rbac-validation.test.js
  P4 承辦Console Production Validation
    RBAC Restrictions - Non-承辦 Access Control
      ✕ should prevent non-承辦 users from accessing sensitive personal data (45 ms)
      ✕ should provide filtered data based on user clearance level (21 ms)
      ✕ should enforce field-level access control (12 ms)
      ✓ should prevent data export by unauthorized users (131 ms)
    Case Flow: 建立→派遣→結案 Workflow Validation
      ✕ should enforce complete case creation workflow (81 ms)
      ✓ should prevent workflow stage skipping (83 ms)
      ✕ should enforce role-based workflow permissions (54 ms)
      ✕ should validate workflow state transitions (7 ms)
    Audit Trails with Watermarks
      ✕ should create watermarked audit entries for all read operations (289 ms)
      ✕ should create enhanced audit trails for export operations (107 ms)
      ✕ should maintain audit chain integrity (194 ms)
    KPI Aggregation without Drill-down
      ✕ should provide aggregated KPI data without detailed breakdowns (39 ms)
      ✕ should prevent access to individual case data through KPI endpoints (48 ms)
      ✕ should provide role-appropriate KPI views (48 ms)
      ✕ should anonymize and aggregate temporal KPI data (47 ms)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should prevent non-承辦 users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:14.019Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "新竹市北區",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[○×]+$/,
    +     "medicalHistory": "輕度認知障礙",
    +     "patientName": "○○○",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "志工協助案件",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "建立",
    +     "nextStages": Array [
    +       "派遣",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "派遣",
    + Object {
    +   "currentStage": "建立",
        "nextStages": Array [
    -     "執行中",
    -     "結案",
    +     "派遣",
        ],
    -   "previousStage": "建立",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "派遣",
    -       "timestamp": Any<String>,
    +       "stage": "建立",
    +       "timestamp": "2025-09-18T07:25:14.504Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: '派遣',
      451 |         previousStage: '建立',
      452 |         nextStages: ['執行中', '結案'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "法院要求提供證據資料",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:15.095Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_ED39F3987BA4CED639A3BA1A72371603_5BB68FD7",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.承辦人員.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

[0mPOST /api/v1/cases/create [32m201[0m 9.506 ms - 616[0m
[0mPOST /api/v1/cases/create [33m400[0m 7.135 ms - 380[0m
[0mPOST /api/v1/cases/create [33m400[0m 8.239 ms - 228[0m
[0mPOST /api/v1/cases/create [33m401[0m 0.347 ms - 85[0m
[0mGET /api/v1/cases/case123 [33m404[0m 2.041 ms - 64[0m
[0mGET /api/v1/cases/nonexistent [33m404[0m 4.481 ms - 64[0m
[0mGET /api/v1/cases/case123 [33m404[0m 3.835 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m404[0m 4.335 ms - 64[0m
[0mPUT /api/v1/cases/case123/status [33m400[0m 0.403 ms - 77[0m
[0mPUT /api/v1/cases/case123/status [33m403[0m 0.367 ms - 96[0m
[0mGET /api/v1/cases/search?status=active&priority=high&location=%E6%96%B0%E7%AB%B9%E5%B8%82&radius=5000 [32m200[0m 7.891 ms - 816[0m
[0mGET /api/v1/cases/search?lat=24.8138&lng=120.9675&radius=10000 [32m200[0m 5.156 ms - -[0m
[0mGET /api/v1/cases/search?page=2&limit=20 [32m200[0m 0.649 ms - -[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.618 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.868 ms - 84[0m
[0mPOST /api/v1/cases/case123/assign [33m404[0m 0.525 ms - 84[0m
FAIL frontend src/mobile/tests/services/MyDataIntegrationService.test.js
  MyDataIntegrationService - GREEN Phase Tests
    OAuth Authorization Flow
      Single-Use Authorization
        ✓ should initiate OAuth flow with correct parameters (15 ms)
        ✓ should generate secure random state parameter (1 ms)
        ✓ should validate state parameter on callback (2 ms)
        ✓ should reject callback with invalid state (154 ms)
      Token Exchange
        ✓ should exchange authorization code for access token (7 ms)
        ✕ should handle token exchange errors (1 ms)
        ✕ should store access token securely and temporarily (1 ms)
    Data Access and Processing
      Profile Data Retrieval
        ✓ should fetch user profile with minimal data principle (92 ms)
        ✓ should encrypt sensitive data before local storage (4 ms)
        ✓ should implement data minimization principles (1 ms)
    Consent Management
      Consent Recording
        ✓ should generate detailed consent receipt (1 ms)
        ✕ should provide user-readable consent summary (3 ms)
        ✓ should validate consent before data processing (1 ms)
      Consent Revocation
        ✓ should support immediate consent revocation (1 ms)
        ✕ should delete all associated data on consent revocation (1 ms)
        ✓ should provide revocation confirmation to user (1 ms)
    Data Retention and Deletion
      Automatic Data Expiration
        ✓ should automatically delete data after retention period (20 ms)
        ✓ should clean up expired tokens regularly (11 ms)
      Receipt Management
        ✓ should retain consent receipts for 7 days after data deletion (1 ms)
        ✓ should generate GDPR-compliant deletion certificates (1 ms)
    Security and Privacy
      Token Security
        ✕ should implement secure token storage with biometric protection (1 ms)
        ✓ should implement token refresh without user interaction (1 ms)
      Data Encryption
        ✕ should encrypt all stored personal data (1 ms)
        ✓ should use different encryption keys per user (5 ms)
    Error Handling and Edge Cases
      OAuth Flow Errors
        ✕ should handle network failures during OAuth (1 ms)
        ✓ should handle cancelled OAuth flow (1 ms)
      Data Processing Errors
        ✕ should handle API rate limiting gracefully
        ✓ should handle partial data responses (1 ms)

  ● MyDataIntegrationService - GREEN Phase Tests › OAuth Authorization Flow › Token Exchange › should handle token exchange errors

    Token exchange failed

      160 |             userMessage: '授權驗證失敗，請重新授權'
      161 |           };
    > 162 |           throw new Error('Token exchange failed');
          |                 ^
      163 |         });
      164 |
      165 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:162:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:167:25)

  ● MyDataIntegrationService - GREEN Phase Tests › OAuth Authorization Flow › Token Exchange › should store access token securely and temporarily

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      180 |         const expiresIn = 3600; // 1 hour
      181 |
    > 182 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      183 |
      184 |         // Act
      185 |         const result = await myDataService.storeAccessTokenSecurely(accessToken, expiresIn);

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:182:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Consent Management › Consent Recording › should provide user-readable consent summary

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

    @@ -1,10 +1,9 @@
      Object {
        "contact": "新竹市政府資訊處",
        "dataTypes": Array [
          "基本資料",
    -     "緊急聯絡人",
        ],
        "purpose": "新竹市安心守護服務",
        "retention": "最長保存 30 天",
        "rights": Array [
          "您可隨時撤回同意",

      326 |
      327 |         // Assert
    > 328 |         expect(summary).toEqual({
          |                         ^
      329 |           title: '資料使用同意書',
      330 |           purpose: '新竹市安心守護服務',
      331 |           dataTypes: ['基本資料', '緊急聯絡人'],

      at Object.toEqual (src/mobile/tests/services/MyDataIntegrationService.test.js:328:25)

  ● MyDataIntegrationService - GREEN Phase Tests › Consent Management › Consent Revocation › should delete all associated data on consent revocation

    TypeError: Cannot read properties of undefined (reading 'getInternetCredentials')

      400 |         const userId = 'user-123';
      401 |         AsyncStorage.getItem.mockResolvedValue('{"name":"王小明","phone":"0912345678"}');
    > 402 |         Keychain.getInternetCredentials.mockResolvedValue({
          |                  ^
      403 |           username: 'hsinchu_guardian',
      404 |           password: 'access_token_123'
      405 |         });

      at Object.getInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:402:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Security and Privacy › Token Security › should implement secure token storage with biometric protection

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      551 |         const sensitiveToken = 'highly_sensitive_access_token_12345';
      552 |
    > 553 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      554 |         Keychain.SECURITY_LEVEL = {
      555 |           SECURE_HARDWARE: 'SECURE_HARDWARE'
      556 |         };

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:553:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Security and Privacy › Data Encryption › should encrypt all stored personal data

    SyntaxError: Bad escaped character in JSON at position 12 (line 1 column 13)
        at JSON.parse (<anonymous>)

      392 |     const hex = encrypted.match(/.{2}/g).map(h => String.fromCharCode(parseInt(h, 16))).join('');
      393 |     const data = hex.split('_encrypted_with_')[0];
    > 394 |     return JSON.parse(data);
          |                 ^
      395 |   }
      396 |
      397 |   getUserEncryptionKey(userId) {

      at MyDataIntegrationService.parse [as decryptPersonalData] (src/mobile/src/services/MyDataIntegrationService.js:394:17)
      at Object.decryptPersonalData (src/mobile/tests/services/MyDataIntegrationService.test.js:600:47)

  ● MyDataIntegrationService - GREEN Phase Tests › Error Handling and Edge Cases › OAuth Flow Errors › should handle network failures during OAuth

    Network request failed

      639 |             canRetry: true
      640 |           };
    > 641 |           throw new Error('Network request failed');
          |                 ^
      642 |         });
      643 |
      644 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:641:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:646:25)

  ● MyDataIntegrationService - GREEN Phase Tests › Error Handling and Edge Cases › Data Processing Errors › should handle API rate limiting gracefully

    Rate limit exceeded

      690 |             userMessage: '請求過於頻繁，請稍後再試'
      691 |           };
    > 692 |           throw new Error('Rate limit exceeded');
          |                 ^
      693 |         });
      694 |
      695 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:692:17)
      at Object.fetchUserProfile (src/mobile/tests/services/MyDataIntegrationService.test.js:697:25)

[0mPOST /api/v1/cases/case123/assign [33m403[0m 0.381 ms - 90[0m
FAIL backend src/backend/tests/integration/api.cases.test.js
  Case Flow API Endpoints
    POST /api/v1/cases/create
      ✕ should create a new case successfully (94 ms)
      ✓ should validate required fields (42 ms)
      ✓ should validate location coordinates (31 ms)
      ✓ should require authentication (24 ms)
    GET /api/v1/cases/:id
      ✕ should return case details for authorized user (22 ms)
      ✓ should return 404 for non-existent case (25 ms)
      ✕ should enforce access control based on case ownership (42 ms)
    PUT /api/v1/cases/:id/status
      ✕ should update case status successfully (33 ms)
      ✓ should validate status transitions (65 ms)
      ✓ should require appropriate permissions for status updates (27 ms)
    GET /api/v1/cases/search
      ✕ should search cases with filters (60 ms)
      ✓ should support geographic search (36 ms)
      ✓ should support pagination (74 ms)
    POST /api/v1/cases/:id/assign
      ✕ should assign case to volunteer successfully (4 ms)
      ✓ should validate assignee exists and is eligible (31 ms)
      ✕ should check volunteer availability (3 ms)
      ✓ should require case management permissions (48 ms)

  ● Case Flow API Endpoints › POST /api/v1/cases/create › should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "陳小華",
            "phone": "0912345678",
            "relationship": "女兒",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:16.906Z",
    +     "createdBy": "admin123",
          "description": "78歲陳老先生在大潤發走失",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-283",
    +     "location": Object {
            "address": "新竹市東區光復路二段101號",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "身高約165cm，穿深色衣服",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "陳老先生",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "失智長者走失案件",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:16.906Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › PUT /api/v1/cases/:id/status › should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/search › should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:16.589Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:16.589Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "新竹市東區○○路123號",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "阿茲海默症第二期",
    +         "patientName": "王○○",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "失智長者走失案件",
    +       "workflow": Object {
    +         "currentStage": "建立",
    +         "nextStages": Array [
    +           "派遣",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "建立",
    +             "timestamp": "2025-09-18T07:25:16.589Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

PASS frontend src/backend/tests/unit/case-flow.service.test.js
  案件流程服務 (CaseFlowService)
    1. 案件建立 (Case Creation)
      createCase()
        ✓ 應該成功建立失蹤人員案件 (26 ms)
        ✓ 應該為緊急案件自動設定最高優先級 (11 ms)
        ✓ 應該記錄案件建立的稽核日誌 (19 ms)
        ✓ 應該拒絕無效的案件資料 (287 ms)
        ✓ 應該為不同類型案件設定適當的預設值 (47 ms)
      案件編號生成
        ✓ 應該生成唯一的案件編號 (15 ms)
        ✓ 應該包含日期和序號的案件編號 (22 ms)
    2. 狀態轉換 (State Transitions)
      assignCase()
        ✓ 應該將案件從建立狀態轉為派發狀態 (36 ms)
        ✓ 應該記錄狀態轉換歷史 (28 ms)
        ✓ 應該通知相關人員案件派發 (5 ms)
        ✓ 應該拒絕派發已結案的案件 (9 ms)
      updateCaseStatus()
        ✓ 應該允許有效的狀態轉換 (39 ms)
        ✓ 應該拒絕無效的狀態轉換 (8 ms)
        ✓ 應該記錄每次狀態更新 (27 ms)
      closeCase()
        ✓ 應該成功結案並設定結案原因 (19 ms)
        ✓ 應該觸發資料清理流程 (6 ms)
    3. 多機關協調 (Multi-Agency Coordination)
      assignMultipleAgencies()
        ✓ 應該同時派發給警察、消防、醫療單位 (25 ms)
        ✓ 應該建立機關間通訊頻道 (4 ms)
        ✓ 應該設定機關協調會議時間 (25 ms)
      updateAgencyStatus()
        ✓ 應該更新個別機關的處理狀態 (17 ms)
        ✓ 應該自動計算整體案件進度 (3 ms)
    4. 即時狀態更新與通知 (Real-time Updates)
      broadcastCaseUpdate()
        ✓ 應該向所有相關人員廣播案件更新 (23 ms)
        ✓ 應該支援緊急廣播模式 (31 ms)
      subscribeToUpdates()
        ✓ 應該允許用戶訂閱案件更新 (5 ms)
        ✓ 應該支援即時 WebSocket 推送 (15 ms)
    5. 案件升級機制 (Case Escalation)
      escalateCase()
        ✓ 應該根據時間自動升級案件 (13 ms)
        ✓ 應該根據嚴重程度升級案件 (28 ms)
        ✓ 應該自動分配額外資源 (11 ms)
      escalationTriggers
        ✓ 應該在失蹤兒童案件自動升級 (26 ms)
        ✓ 應該在多人失蹤案件自動升級 (3 ms)
    6. 搜尋區域管理 (Search Area Management)
      defineSearchArea()
        ✓ 應該建立搜尋區域並分配搜尋隊 (54 ms)
        ✓ 應該根據地形自動分配適當的搜尋隊 (12 ms)
        ✓ 應該計算搜尋時間預估 (23 ms)
      assignZoneToTeam()
        ✓ 應該分配搜尋區域給特定隊伍 (42 ms)
        ✓ 應該追蹤搜尋進度 (3 ms)
    7. 志工派遣協調 (Volunteer Dispatch)
      requestVolunteers()
        ✓ 應該根據需求請求志工支援 (48 ms)
        ✓ 應該通知合格的志工 (15 ms)
        ✓ 應該管理志工報到和分組 (4 ms)
      manageVolunteerSafety()
        ✓ 應該追蹤志工安全狀態 (27 ms)
        ✓ 應該在志工失聯時發出警告 (3 ms)
    8. 案件解決與結案流程 (Case Resolution)
      resolveCase()
        ✓ 應該記錄案件解決詳情 (3 ms)
        ✓ 應該生成案件摘要報告 (21 ms)
        ✓ 應該觸發後續處理流程 (14 ms)
      案件關閉後處理
        ✓ 應該安排資料保留和清理 (29 ms)
        ✓ 應該更新相關統計和KPI (10 ms)
    9. 效能指標追蹤 (Performance Metrics)
      trackResponseTime()
        ✓ 應該記錄各階段響應時間 (32 ms)
        ✓ 應該計算平均響應時間 (27 ms)
      trackResourceUtilization()
        ✓ 應該追蹤資源使用效率 (10 ms)
      generatePerformanceReport()
        ✓ 應該生成效能分析報告 (20 ms)
    10. 班別交接 (Shift Handoff)
      prepareShiftHandoff()
        ✓ 應該準備班別交接資料 (5 ms)
        ✓ 應該標識需要特別關注的案件 (3 ms)
        ✓ 應該生成交接檢查清單 (15 ms)
      executeShiftHandoff()
        ✓ 應該執行班別交接並記錄確認 (32 ms)
        ✓ 應該更新案件負責人 (8 ms)
    11. 緊急升級觸發器 (Emergency Escalation Triggers)
      automaticEscalationTriggers
        ✓ 應該在兒童失蹤時立即觸發最高級別警報 (3 ms)
        ✓ 應該在大量傷亡事件時啟動災害應變機制 (47 ms)
        ✓ 應該在恐怖攻擊疑慮時啟動反恐機制 (2 ms)
      escalationChain
        ✓ 應該依序通知升級鏈中的相關人員 (3 ms)
        ✓ 應該在連續升級後啟動指揮官級別響應 (3 ms)
      publicSafetyTriggers
        ✓ 應該在公共安全威脅時發布緊急警報 (3 ms)
        ✓ 應該協調多機關緊急應變 (16 ms)
    錯誤處理和邊緣案例 (Error Handling & Edge Cases)
      ✓ 應該拒絕無效的案件類型 (8 ms)
      ✓ 應該處理並發案件建立 (79 ms)
      ✓ 應該處理系統資源不足的情況 (3 ms)
      ✓ 應該在權限不足時拒絕操作 (3 ms)

PASS frontend src/backend/tests/unit/kpi.service.test.js
  KPI 服務 (KPI Service)
    即時 KPI 計算與聚合 (Real-time KPI Calculation)
      ✓ 應計算案件處理即時統計 (43 ms)
      ✓ 應聚合多個地理區域的 KPI (3 ms)
      ✓ 應計算分時段的 KPI 趨勢 (21 ms)
      ✓ 應支援即時 KPI 更新推送 (1 ms)
      ✓ 應處理大量並發的 KPI 計算請求 (2 ms)
    案件解決指標 (Case Resolution Metrics)
      ✓ 應計算平均案件回應時間 (3 ms)
      ✓ 應計算案件成功解決率 (2 ms)
      ✓ 應追蹤案件升級和降級模式 (9 ms)
      ✓ 應計算不同優先級案件的 SLA 達成率 (3 ms)
      ✓ 應分析案件重新開啟率 (6 ms)
    志工績效指標 (Volunteer Performance Metrics)
      ✓ 應計算志工活躍度指標 (5 ms)
      ✓ 應追蹤志工回應時間 (2 ms)
      ✓ 應計算志工滿意度評分 (2 ms)
      ✓ 應分析志工培訓完成率 (1 ms)
      ✓ 應追蹤志工留任率 (1 ms)
      ✓ 應計算志工工作負荷分佈 (4 ms)
    系統效能指標 (System Performance Indicators)
      ✓ 應監控 API 回應時間 (1 ms)
      ✓ 應追蹤資料庫查詢效能 (2 ms)
      ✓ 應監控系統記憶體使用率 (1 ms)
      ✓ 應追蹤同時連線使用者數量 (2 ms)
      ✓ 應監控儲存空間使用情況 (2 ms)
    趨勢分析與預測 (Trend Analysis and Forecasting)
      ✓ 應分析案件數量趨勢 (15 ms)
      ✓ 應預測志工需求 (2 ms)
      ✓ 應檢測 KPI 異常模式 (1 ms)
      ✓ 應產生季節性趨勢報告 (2 ms)
      ✓ 應計算 KPI 變化率和成長率 (2 ms)
    警報閾值與通知 (Alert Thresholds and Notifications)
      ✓ 應設定和管理 KPI 警報閾值 (24 ms)
      ✓ 應檢查 KPI 值是否超過閾值 (4 ms)
      ✓ 應發送閾值突破警報 (1 ms)
      ✓ 應管理警報升級機制 (1 ms)
      ✓ 應支援智慧型警報頻率控制 (1 ms)
      ✓ 應產生警報統計報告 (1 ms)
    儀表板資料準備 (Dashboard Data Preparation)
      ✓ 應準備即時儀表板資料 (1 ms)
      ✓ 應產生歷史趨勢圖表資料 (1 ms)
      ✓ 應產生地理分佈熱點圖資料 (1 ms)
      ✓ 應產生 KPI 比較表格資料 (6 ms)
      ✓ 應支援儀表板資料的快取機制 (1 ms)
    自訂 KPI 定義 (Custom KPI Definitions)
      ✓ 應允許建立自訂 KPI 指標 (2 ms)
      ✓ 應驗證自訂 KPI 公式的正確性 (2 ms)
      ✓ 應計算自訂 KPI 的數值 (2 ms)
      ✓ 應支援條件式 KPI 計算 (1 ms)
      ✓ 應管理 KPI 計算排程 (2 ms)
      ✓ 應提供 KPI 計算歷史記錄 (1 ms)
      ✓ 應支援 KPI 的版本管理 (1 ms)
      ✓ 應驗證 KPI 數據品質 (1 ms)
    錯誤處理 (Error Handling)
      ✓ 應在 KPI 計算失敗時拋出計算錯誤 (148 ms)
      ✓ 應在閾值設定無效時拋出閾值錯誤 (5 ms)
      ✓ 應在查詢參數無效時拋出驗證錯誤 (27 ms)
      ✓ 應優雅處理資料來源連線失敗 (1 ms)

PASS frontend src/backend/tests/unit/rbac.service.test.js
  RBACService - 角色權限控制服務
    1. Role-Based Access Control (基本角色控制)
      Role Definitions
        ✓ should define Viewer role with read-only permissions (2 ms)
        ✓ should define Operator role with case management permissions (1 ms)
        ✓ should define Admin role with full system permissions (1 ms)
        ✓ should reject invalid role types (163 ms)
      User Role Assignment
        ✓ should assign single role to user (7 ms)
        ✓ should assign multiple roles to user (1 ms)
        ✓ should prevent role escalation without proper authorization (10 ms)
    2. Permission Validation (權限驗證)
      Sensitive Operations
        ✓ should validate permission for case deletion (19 ms)
        ✓ should deny permission for unauthorized export operations (8 ms)
        ✓ should validate emergency override permissions (1 ms)
      Resource-Specific Permissions
        ✓ should validate department-specific case access (1 ms)
        ✓ should deny cross-department case access (4 ms)
    3. Field-Level Visibility Control (欄位級可見性控制)
      PII Protection
        ✓ should hide PII fields from Viewer role (22 ms)
        ✓ should show limited PII to Operator role (1 ms)
        ✓ should show full PII to Admin role (4 ms)
        ✓ should apply custom masking rules for healthcare data (12 ms)
    4. Multi-Tenant Support (多租戶支援)
      Tenant Isolation
        ✓ should isolate data between different county governments (1 ms)
        ✓ should prevent cross-tenant data access (1 ms)
        ✓ should support super-admin cross-tenant access (1 ms)
    5. Session Management with Role Context (角色上下文會話管理)
      Session Creation
        ✓ should create session with role context (1 ms)
        ✓ should set appropriate session timeout based on role (1 ms)
      Session Validation
        ✓ should validate active session with current permissions
        ✓ should invalidate expired sessions (38 ms)
      Role Context Updates
        ✓ should update session when user roles change (1 ms)
    6. Audit Trail for Permission Changes (權限變更稽核軌跡)
      Permission Change Logging
        ✓ should log role assignment with full context (1 ms)
        ✓ should log role removal with approval chain
        ✓ should create immutable audit records (1 ms)
      Audit Query and Review
        ✓ should query audit trail with proper filtering (8 ms)
        ✓ should detect audit trail tampering (1 ms)
    7. Bulk Role Assignments (批量角色指派)
      Department-wide Assignments
        ✓ should assign roles to entire department (1 ms)
        ✓ should handle partial failures in bulk assignment (11 ms)
        ✓ should validate bulk assignment permissions (1 ms)
      CSV Import Role Assignment
        ✓ should process CSV role assignment file (1 ms)
        ✓ should validate CSV format and reject invalid entries (1 ms)
    8. Time-Based Access Controls (時間基礎存取控制)
      Scheduled Access
        ✓ should grant access during business hours (11 ms)
        ✓ should deny access outside business hours (1 ms)
        ✓ should handle emergency override for time restrictions (1 ms)
      Temporary Access Grants
        ✓ should grant temporary elevated access (1 ms)
        ✓ should automatically revoke expired temporary access (1 ms)
    9. Resource-Specific Permissions (資源特定權限)
      Healthcare Data Access
        ✓ should validate medical record access permissions (1 ms)
        ✓ should deny medical access without proper license (25 ms)
      Location-Based Access
        ✓ should validate geographic boundary access (1 ms)
        ✓ should deny access to out-of-jurisdiction resources (1 ms)
    10. Security Event Logging (安全事件記錄)
      Suspicious Activity Detection
        ✓ should detect and log multiple failed access attempts (1 ms)
        ✓ should log privilege escalation attempts (5 ms)
      Compliance Reporting
        ✓ should generate GDPR compliance report (1 ms)
        ✓ should generate Taiwan Personal Data Protection Act report (1 ms)
      Real-time Security Monitoring
        ✓ should trigger real-time alerts for critical events (1 ms)
        ✓ should implement circuit breaker for repeated violations (1 ms)
    Integration with Taiwan Healthcare Regulations
      ✓ should implement NHI data access controls (1 ms)
      ✓ should comply with MOHW data retention policies

PASS frontend src/backend/tests/unit/audit.service.test.js
  稽核服務 (Audit Service)
    綜合稽核記錄 (Comprehensive Audit Logging)
      ✓ 應記錄使用者登入事件 (12 ms)
      ✓ 應記錄資料存取事件 (1 ms)
      ✓ 應記錄系統管理操作 (1 ms)
      ✓ 應記錄資料匯出事件 (1 ms)
      ✓ 應記錄失敗的操作嘗試 (11 ms)
    稽核軌跡完整性 (Audit Trail Integrity)
      ✓ 應為每筆稽核記錄建立雜湊值 (1 ms)
      ✓ 應建立稽核記錄鏈式雜湊 (1 ms)
      ✓ 應檢測稽核記錄的篡改 (2 ms)
      ✓ 應在檢測到篡改時發送安全警報 (28 ms)
      ✓ 應支援稽核記錄的數位簽章 (1 ms)
    合規報告 (Compliance Reporting)
      ✓ 應產生 GDPR 合規報告 (13 ms)
      ✓ 應產生台灣個資法合規報告 (2 ms)
      ✓ 應產生醫療法規合規報告 (1 ms)
      ✓ 應驗證合規報告的完整性 (1 ms)
      ✓ 應自動檢查合規性違規 (1 ms)
    資料存取追蹤 (Data Access Tracking)
      ✓ 應追蹤個人資料的存取模式 (27 ms)
      ✓ 應檢測異常的資料存取行為 (5 ms)
      ✓ 應記錄資料下載和列印事件 (1 ms)
      ✓ 應提供資料血緣追蹤 (1 ms)
    安全事件記錄 (Security Event Logging)
      ✓ 應記錄登入失敗事件 (30 ms)
      ✓ 應記錄權限提升事件 (1 ms)
      ✓ 應記錄可疑的檔案存取 (6 ms)
      ✓ 應記錄資料庫直接存取事件 (25 ms)
    稽核日誌保留與歸檔 (Audit Log Retention)
      ✓ 應根據保留政策歸檔舊記錄 (1 ms)
      ✓ 應壓縮歸檔的稽核記錄 (24 ms)
      ✓ 應驗證歸檔資料的完整性 (1 ms)
      ✓ 應支援歸檔資料的搜尋 (3 ms)
    查詢與搜尋功能 (Query and Search)
      ✓ 應支援複雜的稽核記錄查詢 (14 ms)
      ✓ 應支援全文搜尋稽核記錄 (1 ms)
      ✓ 應提供稽核統計摘要 (1 ms)
    監管機關匯出功能 (Regulatory Export)
      ✓ 應產生監管機關格式的稽核報告 (1 ms)
      ✓ 應為監管匯出加上浮水印 (21 ms)
      ✓ 應記錄監管機關的資料請求 (4 ms)
      ✓ 應驗證監管匯出的授權
    錯誤處理 (Error Handling)
      ✓ 應在稽核記錄失敗時拋出錯誤 (89 ms)
      ✓ 應在無效查詢參數時拋出驗證錯誤 (68 ms)
      ✓ 應在未授權存取時拋出安全錯誤 (19 ms)
      ✓ 應在合規檢查失敗時拋出合規錯誤 (3 ms)

PASS frontend src/backend/tests/unit/ble-scanner.service.test.js
  BLEScannerService
    Android 12+ Permission Handling
      neverForLocation Scanning
        ✓ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (10 ms)
        ✓ should discover BLE devices without location inference (7 ms)
        ✓ should generate device hashes with salt immediately (2 ms)
      Location-Based Scanning for Positioning
        ✓ should request location permissions when inference enabled (1 ms)
        ✓ should include RSSI and location data in volunteer hits (4 ms)
        ✓ should fuzz location to 100m grid squares (1 ms)
        ✓ should round timestamps to 5-minute intervals (2 ms)
    iOS Background BLE Handling
      State Preservation
        ✓ should configure CBCentralManager with restore identifier (3 ms)
        ✓ should save scanning state for preservation (1 ms)
      State Restoration
        ✓ should restore scanning state on app launch (4 ms)
        ✓ should resume background scanning automatically (25 ms)
    Device Discovery and Filtering
      RSSI Threshold Filtering
        ✓ should process devices with RSSI stronger than -90 dBm (1 ms)
        ✓ should ignore devices with RSSI weaker than -90 dBm
        ✓ should handle edge case at exactly -90 dBm threshold (3 ms)
      MAC Address Rotation Handling
        ✓ should handle MAC rotation by treating each MAC as separate device (2 ms)
        ✓ should not correlate rotated MAC addresses (1 ms)
        ✓ should maintain k-anonymity across MAC rotations (3 ms)
    Battery-Efficient Scanning
      Power Management
        ✓ should use conservative scanning when not charging (3 ms)
        ✓ should use aggressive scanning when charging
        ✓ should adapt intervals based on detection rate (4 ms)
    VolunteerHit Creation
      Complete Anonymization
        ✓ should create VolunteerHit with all required anonymized fields (2 ms)
        ✓ should never store original MAC addresses (12 ms)
        ✓ should never store device names or personal identifiers (7 ms)
    Error Handling
      BLE Adapter Failures
        ✓ should handle BLE adapter disabled gracefully (7 ms)
        ✓ should resume scanning when Bluetooth is re-enabled (1 ms)
      Permission Revocation
        ✓ should stop scanning immediately when permissions revoked (4 ms)
        ✓ should preserve queued data when permissions revoked (4 ms)
        ✓ should resume from preserved state when permissions re-granted (1 ms)

PASS frontend src/backend/tests/unit/geo-alert.service.test.js
  GeoAlertService
    Alert Radius Configuration and Targeting
      500m, 1km, 2km Radius Support
        ✓ should receive alert when within 500m radius (17 ms)
        ✓ should NOT receive alert when outside 1km radius
        ✓ should support 2km radius for wide area alerts (14 ms)
        ✓ should handle edge case at exact radius boundary
    Alert Cooldown and Spam Prevention
      5-Minute Minimum Cooldown
        ✓ should prevent duplicate alerts within 5-minute cooldown (1 ms)
        ✓ should allow alert after 5-minute cooldown expires
        ✓ should show cooldown timer to user (1 ms)
        ✓ should reset cooldown when timer expires
    Privacy Protection - No PII in Alerts
      Alert Content Restrictions
        ✓ should never include names in alert messages (1 ms)
        ✓ should never include age or gender information
        ✓ should never include photos or physical descriptions (1 ms)
        ✓ should use only general area descriptions
    Alert Priority Levels
      Info Level Alerts
        ✓ should send info level with standard notification settings (1 ms)
        ✓ should not override Do Not Disturb for info alerts
      Warning Level Alerts
        ✓ should send warning level with prominent notification (1 ms)
        ✓ should use Time-Sensitive delivery on iOS for warnings (7 ms)
        ✓ should use high importance channel on Android for warnings
      Critical Level Alerts
        ✓ should send critical level with maximum urgency settings
        ✓ should use Critical Alert on iOS if authorized (4 ms)
        ✓ should use Full-Screen Intent on Android with user consent
        ✓ should allow user to dismiss or snooze critical alerts (1 ms)
    Mandatory Safety Instructions
      Required Message Content
        ✓ should always include "請撥打110" in all alert levels
        ✓ should always include "切勿自行接近" in all alert levels (1 ms)
        ✓ should provide emergency contact button in all alerts
        ✓ should provide "回報可疑" button for volunteer coordination (1 ms)
        ✓ should provide safety guidelines link
    A/B Testing for Safety Message Effectiveness
      Message Variant Testing
        ✓ should assign users to A/B test groups for message variations (1 ms)
        ✓ should use variant B wording for test group B
        ✓ should track engagement metrics for A/B test analysis
        ✓ should record user response for effectiveness analysis (1 ms)
        ✓ should ensure core safety instructions remain unchanged across variants (16 ms)
    Error Handling and Edge Cases
      Location Permission Errors
        ✓ should handle location permission denied gracefully
        ✓ should fallback to general notifications when location unavailable (1 ms)
      Push Notification Errors
        ✓ should handle push notification permission disabled (11 ms)
        ✓ should show in-app alert banner when push notifications fail (1 ms)
        ✓ should still attempt delivery for critical alerts when notifications disabled

PASS frontend src/backend/tests/unit/anonymization.service.test.js
  AnonymizationService
    Device Hash Generation
      One-Way Hash with Salt
        ✓ should generate SHA-256 hash with salt for device MAC address (2 ms)
        ✓ should use consistent salt for same session (1 ms)
        ✓ should generate new salt for new session (1 ms)
        ✓ should make hash irreversible - no reverse lookup possible (15 ms)
      Hash Consistency and Collision Handling
        ✓ should generate same hash for same MAC address in same session (1 ms)
        ✓ should generate different hashes for different MAC addresses (1 ms)
        ✓ should handle hash collisions gracefully (1 ms)
    VolunteerHit Creation
      Complete Data Anonymization
        ✓ should create VolunteerHit with all PII removed (17 ms)
        ✓ should never store original device names (1 ms)
        ✓ should never store device IDs, phone numbers, or personal identifiers (1 ms)
      Location Fuzzing
        ✓ should fuzz location to 100m grid squares (15 ms)
        ✓ should never store precise location coordinates (5 ms)
        ✓ should handle edge cases near grid boundaries (2 ms)
      Timestamp Rounding
        ✓ should round timestamps to 5-minute intervals (33 ms)
        ✓ should never store precise timestamps (15 ms)
        ✓ should handle edge cases at interval boundaries (1 ms)
    K-Anonymity Enforcement
      Minimum Cluster Size Validation
        ✓ should require minimum 3 devices per cluster (1 ms)
        ✓ should allow upload when k=3 minimum is met
        ✓ should queue VolunteerHits until k-anonymity is achieved (23 ms)
        ✓ should upload all queued hits when k-anonymity threshold reached (1 ms)
      Individual Device Identification Prevention
        ✓ should ensure individual devices cannot be identified from clusters (13 ms)
        ✓ should validate that server data cannot reverse lookup individual devices (1 ms)
    Privacy Protection Validation
      Data Minimization
        ✓ should only store essential anonymized data (1 ms)
        ✓ should purge unnecessary metadata and device fingerprints
      Anonymization Verification
        ✓ should verify no reverse lookup is possible from anonymized data (21 ms)
        ✓ should detect and reject data containing PII (7 ms)
    Error Handling and Edge Cases
      Malformed Data Handling
        ✓ should handle malformed MAC addresses gracefully (143 ms)
        ✓ should handle invalid location coordinates gracefully (19 ms)
        ✓ should handle timestamp parsing errors gracefully (2 ms)

PASS frontend tests/validation/p1-family-geofence-validation.test.js
  P1 家屬端 Production Validation
    E2E Geofence Scenarios
      進入 (Entry) Scenarios
        ✓ should detect entry into Hsinchu City Hall geofence (35 ms)
        ✓ should handle entry with GPS uncertainty edge cases (1 ms)
      離開 (Exit) Scenarios
        ✓ should implement 30-second exit confirmation delay (2 ms)
        ✓ should cancel exit if user returns within 30 seconds (1 ms)
      停留 (Dwelling) Scenarios
        ✓ should track dwelling time and send periodic updates (38 ms)
    iOS Time-Sensitive Notifications Validation
      ✓ should use Time-Sensitive but NOT Critical level notifications (1 ms)
      ✓ should respect iOS Focus/DND modes appropriately
      ✓ should handle iOS notification authorization correctly (62 ms)
    Android High-Priority Channels Validation
      ✓ should create high-priority channel WITHOUT DND bypass (1 ms)
      ✓ should respect user DND preferences (1 ms)
      ✓ should handle Android 13+ notification permissions (13 ms)
    Geofence Accuracy and Timing Validation
      ✓ should maintain 10m accuracy requirement under various conditions (1 ms)
      ✓ should handle timing precision for event correlation (2 ms)
      ✓ should validate geofence coordinate precision for Hsinchu area (35 ms)
    Production Integration Validation
      ✓ should integrate with real backend API endpoints (1 ms)
      ✓ should handle production error scenarios gracefully (1 ms)

PASS frontend src/backend/tests/unit/geofence-engine.service.test.js
  GeofenceEngine - RED Phase Tests
    Boundary Detection with 10m Accuracy
      detectEntry
        ✓ should detect entry within 10m accuracy threshold (41 ms)
        ✓ should not detect entry when GPS accuracy exceeds 10m (163 ms)
        ✓ should handle edge case at exact boundary with GPS uncertainty (12 ms)
      detectExit
        ✓ should detect exit with 30s delay confirmation (8 ms)
        ✓ should cancel exit confirmation if user returns within 30s (13 ms)
        ✓ should handle multiple geofences with independent exit delays (6 ms)
    Cooldown Management (5-minute between notifications)
      notificationCooldown
        ✓ should enforce 5-minute cooldown between notifications (7 ms)
        ✓ should allow notifications after 5-minute cooldown expires (4 ms)
        ✓ should handle different cooldown periods for different event types (13 ms)
        ✓ should allow immediate notifications for different geofences (1 ms)
    Dwell Time Tracking (5+ minutes)
      trackDwellTime
        ✓ should track dwell time when user stays in geofence for 5+ minutes (2 ms)
        ✓ should trigger dwell alerts at specific intervals (2 ms)
        ✓ should reset dwell time when user exits and re-enters (1 ms)
        ✓ should handle movement within geofence without resetting dwell time (38 ms)
    Geofence Configuration and Management
      createGeofence
        ✓ should validate geofence parameters before creation (32 ms)
        ✓ should enforce maximum number of geofences per user (2 ms)
        ✓ should validate geofence names are unique per user (2 ms)
      updateGeofence
        ✓ should handle geofence boundary updates and notify affected users (2 ms)
    Performance and Optimization
      batchLocationProcessing
        ✓ should efficiently process multiple users locations simultaneously (11 ms)
        ✓ should handle high-frequency location updates without performance degradation (12 ms)
    Error Handling and Recovery
      errorRecovery
        ✓ should handle location service failures gracefully (7 ms)
        ✓ should continue processing other geofences when one fails (2 ms)
    Integration with External Services
      emergencyResponse
        ✓ should trigger emergency alerts for critical geofence violations (3 ms)

PASS frontend src/backend/tests/unit/volunteer-consent.service.test.js
  VolunteerConsentService
    Consent Management
      grantConsent
        ✓ should enable volunteer mode and start background BLE scanning (28 ms)
        ✓ should record consent timestamp for GDPR compliance (15 ms)
        ✓ should handle consent version updates (2 ms)
      withdrawConsent
        ✓ should immediately disable volunteer mode and stop scanning (21 ms)
        ✓ should cancel all queued data uploads (1 ms)
        ✓ should purge local volunteer data immediately (1 ms)
      checkConsentStatus
        ✓ should return consent status with version information (28 ms)
        ✓ should detect when consent version requires update (2 ms)
    Permission Management
      Android 12+ Permissions
        ✓ should request BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (11 ms)
        ✓ should conditionally request location permission based on inference setting (1 ms)
        ✓ should set neverForLocation flag when location inference disabled
      iOS Background Permissions
        ✓ should configure bluetooth-central background mode (1 ms)
    Persistence and Recovery
      App Restart Scenarios
        ✓ should preserve consent state across app restarts (23 ms)
        ✓ should resume background scanning automatically after restart (3 ms)
    Error Handling
      Permission Denied Scenarios
        ✓ should handle graceful degradation when BLE permission denied (125 ms)
        ✓ should mark consent as pending when permissions incomplete (1 ms)
    Privacy and GDPR Compliance
      ✓ should anonymize user identifiers in consent records (9 ms)
      ✓ should not store IP addresses or detailed device fingerprints (1 ms)

PASS frontend src/backend/tests/unit/device-binding.service.test.js
  DeviceBindingService - RED Phase Tests
    NCC Certification Validation
      validateNCCNumber
        ✓ should accept valid NCC format CCAMYYXX#### (12 characters) (8 ms)
        ✓ should reject invalid NCC format - wrong prefix (142 ms)
        ✓ should reject invalid NCC format - wrong length (35 ms)
        ✓ should reject invalid NCC format - wrong year format (2 ms)
        ✓ should reject invalid NCC format - invalid character patterns (2 ms)
        ✓ should validate NCC number exists in official registry (46 ms)
      getChineseRegulatoryWarning
        ✓ should return Chinese regulatory warning text (12 ms)
        ✓ should include NCC logo and certification mark requirements (3 ms)
    Device Serial Number Management
      registerDevice
        ✓ should prevent duplicate serial number registration (6 ms)
        ✓ should allow registration of new serial number (1 ms)
        ✓ should validate serial number format for Hsinchu devices (2 ms)
      transferDevice
        ✓ should prevent transfer of non-existent device (61 ms)
        ✓ should prevent unauthorized device transfer (1 ms)
    BLE Connection Management
      connectToDevice
        ✓ should handle BLE connection failures with retry logic (27 ms)
        ✓ should implement exponential backoff between retries (41 ms)
        ✓ should handle different BLE error types appropriately (13 ms)
      monitorConnectionHealth
        ✓ should detect connection drops and attempt reconnection (34 ms)
        ✓ should track signal strength and battery level (1 ms)
    Regulatory Compliance
      displayRegulatoryInfo
        ✓ should show complete regulatory information before device binding (2 ms)
        ✓ should require user consent before proceeding with binding (2 ms)
        ✓ should reject consent without proper boolean consentGiven (23 ms)
        ✓ should prevent device binding without proper consent (1 ms)
    Device Status Management
      updateDeviceStatus
        ✓ should track device lifecycle states (17 ms)
    Notification Integration
      deviceStatusNotifications
        ✓ should notify users of successful device binding (23 ms)
        ✓ should notify users of connection issues (13 ms)

PASS frontend src/backend/tests/unit/geofence-engine.test.js
  GeofenceEngine
    Boundary Events
      ✓ should detect entry within 10m accuracy (24 ms)
      ✓ should detect exit with 30 second delay (2 ms)
      ✓ should track dwell time for 5+ minutes (2 ms)
      ✓ should calculate accurate distance using Haversine formula (1 ms)
    Cooldown Logic
      ✓ should prevent notification spam with 5 min cooldown (31 ms)
      ✓ should handle multiple geofence priority correctly (2 ms)
      ✓ should reset cooldown after period expires (155 ms)
    Performance
      ✓ should handle 100+ simultaneous geofences (3 ms)
      ✓ should implement battery-efficient monitoring (1 ms)
      ✓ should batch process location updates efficiently (1 ms)
      ✓ should cache geofence calculations for performance (12 ms)
    State Management
      ✓ should persist geofence state across restarts (9 ms)
      ✓ should clean up expired geofences (24 ms)

PASS frontend src/backend/tests/unit/retention.service.test.js
  RetentionService
    TTL-based Data Retention
      ✓ should set appropriate TTL based on data purpose (2 ms)
      ✓ should apply minimum retention for regulatory compliance (23 ms)
      ✓ should reduce TTL for sensitive data without explicit consent (2 ms)
    Automated Cleanup Jobs
      ✓ should schedule daily cleanup cron job (1 ms)
      ✓ should cleanup expired personal data (2 ms)
      ✓ should handle cleanup failures gracefully (13 ms)
      ✓ should cleanup orphaned consent records (1 ms)
    Immediate Revocation
      ✓ should immediately delete all data on revocation request (2 ms)
      ✓ should generate deletion certificate (9 ms)
      ✓ should notify related services of revocation (1 ms)
      ✓ should validate revocation request authorization (52 ms)
    Retention Policies
      ✓ should apply data minimization principle (6 ms)
      ✓ should pseudonymize data after initial retention period (3 ms)
      ✓ should enforce different retention periods by data category (3 ms)
    Compliance Reporting
      ✓ should generate GDPR compliance report (3 ms)
      ✓ should track data subject requests (4 ms)

PASS frontend src/backend/tests/unit/mydata-adapter.test.js
  MyDataAdapter Service
    OAuth Authorization Flow
      ✓ should generate authorization URL with required parameters (2 ms)
      ✓ should handle authorization callback and exchange code for token (1 ms)
      ✓ should reject callback with invalid state (99 ms)
      ✓ should handle token exchange failures (2 ms)
    Data Retrieval with Consent
      ✓ should fetch personal data with valid access token (1 ms)
      ✓ should handle expired token and attempt refresh (1 ms)
      ✓ should enforce single-use token policy (33 ms)
    Data Retention and Cleanup
      ✓ should store data with TTL based on purpose (1 ms)
      ✓ should enforce maximum retention period
      ✓ should automatically clean expired data (2 ms)
    Consent Revocation
      ✓ should immediately delete data on consent revocation (1 ms)
      ✓ should notify MyData platform of revocation (33 ms)
      ✓ should handle cascade deletion of related data (1 ms)
      ✓ should generate revocation receipt (2 ms)
    Audit and Compliance
      ✓ should log all data access attempts (19 ms)
      ✓ should generate compliance report (1 ms)
      ✓ should validate data minimization principle (1 ms)

PASS frontend src/backend/tests/unit/revocation.service.test.js
  RevocationService
    Immediate Revocation Processing
      ✓ should process complete revocation within 100ms (2 ms)
      ✓ should delete data from all storage layers (1 ms)
      ✓ should handle partial failures with rollback (146 ms)
    Audit Trail Generation
      ✓ should create comprehensive audit trail for revocation (1 ms)
      ✓ should include all affected data types in audit (1 ms)
      ✓ should generate immutable revocation receipt (27 ms)
    Cascade Deletion
      ✓ should delete all related data in correct order (2 ms)
      ✓ should handle foreign key constraints (21 ms)
      ✓ should notify dependent services before deletion (10 ms)
    Recovery and Rollback
      ✓ should support revocation cancellation within grace period (1 ms)
      ✓ should create backup before permanent deletion (1 ms)
      ✓ should validate revocation request integrity (38 ms)
    Compliance and Verification
      ✓ should verify complete data deletion (1 ms)
      ✓ should detect incomplete deletion (1 ms)
      ✓ should generate GDPR Article 17 compliance report (1 ms)

[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [32m200[0m 97.885 ms - 494[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=invalid_scope&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 8.723 ms - 158[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=invalid-url&state=random-state-string [33m400[0m 12.901 ms - 162[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m401[0m 1.551 ms - 85[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 0.545 ms - 161[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 2.600 ms - 314[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 16.018 ms - 83[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 1.005 ms - 80[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.438 ms - 150[0m
[0mPOST /api/v1/mydata/callback [33m410[0m 0.375 ms - 89[0m
[0mGET /api/v1/mydata/progress/session123 [32m200[0m 0.974 ms - 528[0m
[0mGET /api/v1/mydata/progress/nonexistent [33m404[0m 0.426 ms - 67[0m
[0mGET /api/v1/mydata/progress/session123 [33m403[0m 1.714 ms - 79[0m
[0mGET /api/v1/mydata/progress/session123?realtime=true [32m200[0m 0.514 ms - 528[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 1.608 ms - 265[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m400[0m 0.590 ms - 166[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m403[0m 1.668 ms - 88[0m
[0mDELETE /api/v1/mydata/revoke/revoked-consent [33m409[0m 2.463 ms - 81[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 6.640 ms - 264[0m
[0mGET /api/v1/mydata/consents [32m200[0m 3.411 ms - 326[0m
[0mGET /api/v1/mydata/consents?status=active [32m200[0m 1.589 ms - 326[0m
[0mGET /api/v1/mydata/consents?page=2&limit=10 [32m200[0m 1.802 ms - 130[0m
PASS frontend src/backend/tests/integration/api.mydata.test.js
  MyData API Endpoints
    GET /api/v1/mydata/authorize
      ✓ should initiate MyData authorization flow (165 ms)
      ✓ should validate required scopes (21 ms)
      ✓ should validate redirect URI format (21 ms)
      ✓ should require user authentication (93 ms)
      ✓ should validate purpose for data access (8 ms)
    POST /api/v1/mydata/callback
      ✓ should handle successful authorization callback (43 ms)
      ✓ should validate authorization code (26 ms)
      ✓ should verify state parameter for CSRF protection (10 ms)
      ✓ should handle authorization errors from MyData platform (6 ms)
      ✓ should validate session exists and is not expired (3 ms)
    GET /api/v1/mydata/progress/:id
      ✓ should return authorization progress status (14 ms)
      ✓ should return 404 for non-existent session (4 ms)
      ✓ should enforce session ownership (9 ms)
      ✓ should provide real-time status updates (3 ms)
    DELETE /api/v1/mydata/revoke/:id
      ✓ should revoke data access consent successfully (6 ms)
      ✓ should require confirmation for revocation (3 ms)
      ✓ should validate user owns the consent (5 ms)
      ✓ should handle already revoked consents (12 ms)
      ✓ should initiate immediate data anonymization (45 ms)
    GET /api/v1/mydata/consents
      ✓ should list user's active data consents (26 ms)
      ✓ should filter consents by status (13 ms)
      ✓ should support pagination for consent history (12 ms)

PASS frontend src/backend/tests/unit/geofence-engine-green.test.js
  GeofenceEngine
    Boundary Event Detection
      ✓ should detect entry within 10m accuracy (2 ms)
      ✓ should detect exit with 30 second delay (102 ms)
      ✓ should not trigger entry if outside radius + accuracy
    Dwell Time Monitoring
      ✓ should track dwell time after 5+ minutes (1 ms)
      ✓ should not trigger dwell alert before 5 minutes (1 ms)
      ✓ should reset dwell time on exit (11 ms)
    Performance & Scalability
      ✓ should handle 100+ simultaneous geofences efficiently (3 ms)
      ✓ should maintain stable memory with many geofences (8 ms)
      ✓ should process batch location updates efficiently (1 ms)

[0mGET /api/v1/rbac/roles [32m200[0m 1.935 ms - -[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.311 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.350 ms - 74[0m
[0mPOST /api/v1/rbac/roles/assign [32m200[0m 2.330 ms - 167[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 1.516 ms - 87[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 1.896 ms - 125[0m
[0mPOST /api/v1/rbac/roles/assign [33m403[0m 0.369 ms - 76[0m
[0mDELETE /api/v1/rbac/roles/remove [32m200[0m 0.866 ms - 151[0m
[0mDELETE /api/v1/rbac/roles/remove [33m404[0m 0.289 ms - 64[0m
[0mGET /api/v1/rbac/permissions/validate?action=create_case&resource=cases&resourceId=case123 [32m200[0m 0.775 ms - 128[0m
[0mGET /api/v1/rbac/permissions/validate [33m400[0m 0.255 ms - 80[0m
[0mGET /api/v1/rbac/audit-trail?startDate=2023-01-01&endDate=2023-12-31&userId=user123 [32m200[0m 0.642 ms - 421[0m
[0mGET /api/v1/rbac/audit-trail?page=2&limit=10 [32m200[0m 0.365 ms - 423[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.265 ms - 125[0m
PASS frontend src/backend/tests/integration/api.rbac.test.js
  RBAC API Endpoints
    GET /api/v1/rbac/roles
      ✓ should return all available roles with their permissions (33 ms)
      ✓ should return 401 when no authorization header is provided (10 ms)
      ✓ should return 403 when user lacks permission to view roles (11 ms)
    POST /api/v1/rbac/roles/assign
      ✓ should successfully assign roles to a user (16 ms)
      ✓ should validate required fields (9 ms)
      ✓ should reject invalid role names (8 ms)
      ✓ should require admin permissions for role assignment (4 ms)
    DELETE /api/v1/rbac/roles/remove
      ✓ should successfully remove roles from a user (5 ms)
      ✓ should validate user exists before removing roles (3 ms)
    GET /api/v1/rbac/permissions/validate
      ✓ should validate user permissions for specific actions (4 ms)
      ✓ should require action parameter (3 ms)
    GET /api/v1/rbac/audit-trail
      ✓ should return audit trail for role assignments (4 ms)
      ✓ should support pagination (4 ms)
      ✓ should require admin permissions for audit trail access (3 ms)

PASS frontend src/backend/tests/unit/device-binding-green.test.js (6.56 s)
  DeviceBindingService
    NCC Certification Validation
      ✓ should reject device without NCC type approval number (67 ms)
      ✓ should reject invalid NCC certification format (2 ms)
      ✓ should accept valid NCC certification format (1 ms)
      ✓ should display Chinese regulatory warning for certified devices
    Serial Number Management
      ✓ should prevent duplicate serial number registration (2 ms)
      ✓ should validate serial number format per manufacturer spec
      ✓ should track binding timestamp and user info (1 ms)
    BLE Connection Resilience
      ✓ should auto-retry on connection failure (3 attempts) (3003 ms)
      ✓ should fail gracefully after 3 connection attempts (3004 ms)
      ✓ should implement exponential backoff for retries (6 ms)
      ✓ should support background reconnection strategy (1 ms)
    Device State Management
      ✓ should track device battery level
      ✓ should alert on low battery (< 20%) (1 ms)
      ✓ should maintain device connection history (1 ms)

PASS frontend src/backend/tests/unit/device-binding.test.js (12.563 s)
  DeviceBindingService
    NCC Certification Validation
      ✓ should reject device without NCC type approval number (58 ms)
      ✓ should reject invalid NCC certification format (11 ms)
      ✓ should accept valid NCC certification format
      ✓ should display Chinese regulatory warning for certified devices
    Serial Number Management
      ✓ should prevent duplicate serial number registration (1 ms)
      ✓ should validate serial number format per manufacturer spec (1 ms)
      ✓ should track binding timestamp and user info (8 ms)
    BLE Connection Resilience
      ✓ should auto-retry on connection failure (3 attempts) (3004 ms)
      ✓ should fail gracefully after 3 connection attempts (3009 ms)
      ✓ should implement exponential backoff for retries (3002 ms)
      ✓ should support background reconnection strategy (3005 ms)
    Device State Management
      ✓ should track device battery level
      ✓ should alert on low battery (< 20%)
      ✓ should maintain device connection history (1 ms)

PASS backend src/backend/tests/unit/device-binding-green.test.js (6.474 s)
  DeviceBindingService
    NCC Certification Validation
      ✓ should reject device without NCC type approval number (54 ms)
      ✓ should reject invalid NCC certification format (1 ms)
      ✓ should accept valid NCC certification format
      ✓ should display Chinese regulatory warning for certified devices (1 ms)
    Serial Number Management
      ✓ should prevent duplicate serial number registration (3 ms)
      ✓ should validate serial number format per manufacturer spec (1 ms)
      ✓ should track binding timestamp and user info
    BLE Connection Resilience
      ✓ should auto-retry on connection failure (3 attempts) (3011 ms)
      ✓ should fail gracefully after 3 connection attempts (3002 ms)
      ✓ should implement exponential backoff for retries (7 ms)
      ✓ should support background reconnection strategy (1 ms)
    Device State Management
      ✓ should track device battery level (1 ms)
      ✓ should alert on low battery (< 20%) (1 ms)
      ✓ should maintain device connection history (4 ms)

[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [32m200[0m 1.290 ms - 494[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=invalid_scope&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 2.162 ms - 158[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=invalid-url&state=random-state-string [33m400[0m 0.768 ms - 162[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=safety_monitoring&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m401[0m 0.323 ms - 85[0m
[0mGET /api/v1/mydata/authorize?userId=user456&scopes=location_tracking%2Cemergency_contact&purpose=&redirectUri=https%3A%2F%2Fapp.hsinchu.gov.tw%2Fcallback&state=random-state-string [33m400[0m 0.664 ms - 161[0m
[0mPOST /api/v1/mydata/callback [32m200[0m 0.596 ms - 314[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.414 ms - 83[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 0.450 ms - 80[0m
[0mPOST /api/v1/mydata/callback [33m400[0m 3.327 ms - 150[0m
[0mPOST /api/v1/mydata/callback [33m410[0m 0.441 ms - 89[0m
[0mGET /api/v1/mydata/progress/session123 [32m200[0m 1.155 ms - 528[0m
[0mGET /api/v1/mydata/progress/nonexistent [33m404[0m 0.436 ms - 67[0m
[0mGET /api/v1/mydata/progress/session123 [33m403[0m 2.589 ms - 79[0m
[0mGET /api/v1/mydata/progress/session123?realtime=true [32m200[0m 0.570 ms - 528[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 2.793 ms - 265[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m400[0m 0.836 ms - 166[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [33m403[0m 1.725 ms - 88[0m
[0mDELETE /api/v1/mydata/revoke/revoked-consent [33m409[0m 0.668 ms - 81[0m
[0mDELETE /api/v1/mydata/revoke/consent123 [32m200[0m 0.631 ms - 264[0m
[0mGET /api/v1/mydata/consents [32m200[0m 1.378 ms - 326[0m
[0mGET /api/v1/mydata/consents?status=active [32m200[0m 0.921 ms - 326[0m
[0mGET /api/v1/mydata/consents?page=2&limit=10 [32m200[0m 1.596 ms - 130[0m
PASS backend src/backend/tests/integration/api.mydata.test.js
  MyData API Endpoints
    GET /api/v1/mydata/authorize
      ✓ should initiate MyData authorization flow (18 ms)
      ✓ should validate required scopes (8 ms)
      ✓ should validate redirect URI format (5 ms)
      ✓ should require user authentication (4 ms)
      ✓ should validate purpose for data access (9 ms)
    POST /api/v1/mydata/callback
      ✓ should handle successful authorization callback (11 ms)
      ✓ should validate authorization code (4 ms)
      ✓ should verify state parameter for CSRF protection (4 ms)
      ✓ should handle authorization errors from MyData platform (34 ms)
      ✓ should validate session exists and is not expired (5 ms)
    GET /api/v1/mydata/progress/:id
      ✓ should return authorization progress status (5 ms)
      ✓ should return 404 for non-existent session (4 ms)
      ✓ should enforce session ownership (5 ms)
      ✓ should provide real-time status updates (4 ms)
    DELETE /api/v1/mydata/revoke/:id
      ✓ should revoke data access consent successfully (7 ms)
      ✓ should require confirmation for revocation (6 ms)
      ✓ should validate user owns the consent (6 ms)
      ✓ should handle already revoked consents (4 ms)
      ✓ should initiate immediate data anonymization (8 ms)
    GET /api/v1/mydata/consents
      ✓ should list user's active data consents (8 ms)
      ✓ should filter consents by status (4 ms)
      ✓ should support pagination for consent history (6 ms)

PASS backend src/backend/tests/unit/case-flow.service.test.js
  案件流程服務 (CaseFlowService)
    1. 案件建立 (Case Creation)
      createCase()
        ✓ 應該成功建立失蹤人員案件 (17 ms)
        ✓ 應該為緊急案件自動設定最高優先級 (29 ms)
        ✓ 應該記錄案件建立的稽核日誌 (4 ms)
        ✓ 應該拒絕無效的案件資料 (147 ms)
        ✓ 應該為不同類型案件設定適當的預設值 (4 ms)
      案件編號生成
        ✓ 應該生成唯一的案件編號 (26 ms)
        ✓ 應該包含日期和序號的案件編號 (4 ms)
    2. 狀態轉換 (State Transitions)
      assignCase()
        ✓ 應該將案件從建立狀態轉為派發狀態 (23 ms)
        ✓ 應該記錄狀態轉換歷史 (4 ms)
        ✓ 應該通知相關人員案件派發 (19 ms)
        ✓ 應該拒絕派發已結案的案件 (10 ms)
      updateCaseStatus()
        ✓ 應該允許有效的狀態轉換 (3 ms)
        ✓ 應該拒絕無效的狀態轉換 (4 ms)
        ✓ 應該記錄每次狀態更新 (4 ms)
      closeCase()
        ✓ 應該成功結案並設定結案原因 (4 ms)
        ✓ 應該觸發資料清理流程 (3 ms)
    3. 多機關協調 (Multi-Agency Coordination)
      assignMultipleAgencies()
        ✓ 應該同時派發給警察、消防、醫療單位 (25 ms)
        ✓ 應該建立機關間通訊頻道 (3 ms)
        ✓ 應該設定機關協調會議時間 (4 ms)
      updateAgencyStatus()
        ✓ 應該更新個別機關的處理狀態 (3 ms)
        ✓ 應該自動計算整體案件進度 (64 ms)
    4. 即時狀態更新與通知 (Real-time Updates)
      broadcastCaseUpdate()
        ✓ 應該向所有相關人員廣播案件更新 (20 ms)
        ✓ 應該支援緊急廣播模式 (4 ms)
      subscribeToUpdates()
        ✓ 應該允許用戶訂閱案件更新 (43 ms)
        ✓ 應該支援即時 WebSocket 推送 (4 ms)
    5. 案件升級機制 (Case Escalation)
      escalateCase()
        ✓ 應該根據時間自動升級案件 (27 ms)
        ✓ 應該根據嚴重程度升級案件 (26 ms)
        ✓ 應該自動分配額外資源 (4 ms)
      escalationTriggers
        ✓ 應該在失蹤兒童案件自動升級 (296 ms)
        ✓ 應該在多人失蹤案件自動升級 (3 ms)
    6. 搜尋區域管理 (Search Area Management)
      defineSearchArea()
        ✓ 應該建立搜尋區域並分配搜尋隊 (2 ms)
        ✓ 應該根據地形自動分配適當的搜尋隊 (19 ms)
        ✓ 應該計算搜尋時間預估 (2 ms)
      assignZoneToTeam()
        ✓ 應該分配搜尋區域給特定隊伍 (12 ms)
        ✓ 應該追蹤搜尋進度 (2 ms)
    7. 志工派遣協調 (Volunteer Dispatch)
      requestVolunteers()
        ✓ 應該根據需求請求志工支援 (25 ms)
        ✓ 應該通知合格的志工 (3 ms)
        ✓ 應該管理志工報到和分組 (7 ms)
      manageVolunteerSafety()
        ✓ 應該追蹤志工安全狀態 (17 ms)
        ✓ 應該在志工失聯時發出警告 (3 ms)
    8. 案件解決與結案流程 (Case Resolution)
      resolveCase()
        ✓ 應該記錄案件解決詳情 (20 ms)
        ✓ 應該生成案件摘要報告 (27 ms)
        ✓ 應該觸發後續處理流程 (13 ms)
      案件關閉後處理
        ✓ 應該安排資料保留和清理 (3 ms)
        ✓ 應該更新相關統計和KPI (12 ms)
    9. 效能指標追蹤 (Performance Metrics)
      trackResponseTime()
        ✓ 應該記錄各階段響應時間 (21 ms)
        ✓ 應該計算平均響應時間 (3 ms)
      trackResourceUtilization()
        ✓ 應該追蹤資源使用效率 (2 ms)
      generatePerformanceReport()
        ✓ 應該生成效能分析報告 (14 ms)
    10. 班別交接 (Shift Handoff)
      prepareShiftHandoff()
        ✓ 應該準備班別交接資料 (3 ms)
        ✓ 應該標識需要特別關注的案件 (31 ms)
        ✓ 應該生成交接檢查清單 (2 ms)
      executeShiftHandoff()
        ✓ 應該執行班別交接並記錄確認 (3 ms)
        ✓ 應該更新案件負責人 (33 ms)
    11. 緊急升級觸發器 (Emergency Escalation Triggers)
      automaticEscalationTriggers
        ✓ 應該在兒童失蹤時立即觸發最高級別警報 (3 ms)
        ✓ 應該在大量傷亡事件時啟動災害應變機制 (3 ms)
        ✓ 應該在恐怖攻擊疑慮時啟動反恐機制 (12 ms)
      escalationChain
        ✓ 應該依序通知升級鏈中的相關人員 (3 ms)
        ✓ 應該在連續升級後啟動指揮官級別響應 (2 ms)
      publicSafetyTriggers
        ✓ 應該在公共安全威脅時發布緊急警報 (3 ms)
        ✓ 應該協調多機關緊急應變 (34 ms)
    錯誤處理和邊緣案例 (Error Handling & Edge Cases)
      ✓ 應該拒絕無效的案件類型 (15 ms)
      ✓ 應該處理並發案件建立 (2 ms)
      ✓ 應該處理系統資源不足的情況 (2 ms)
      ✓ 應該在權限不足時拒絕操作 (15 ms)

[0mGET /api/v1/rbac/roles [32m200[0m 1.280 ms - -[0m
[0mGET /api/v1/rbac/roles [33m401[0m 0.319 ms - 85[0m
[0mGET /api/v1/rbac/roles [33m403[0m 0.468 ms - 74[0m
[0mPOST /api/v1/rbac/roles/assign [32m200[0m 1.177 ms - 167[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 0.455 ms - 87[0m
[0mPOST /api/v1/rbac/roles/assign [33m400[0m 0.561 ms - 125[0m
[0mPOST /api/v1/rbac/roles/assign [33m403[0m 0.332 ms - 76[0m
[0mDELETE /api/v1/rbac/roles/remove [32m200[0m 1.015 ms - 151[0m
[0mDELETE /api/v1/rbac/roles/remove [33m404[0m 0.477 ms - 64[0m
[0mGET /api/v1/rbac/permissions/validate?action=create_case&resource=cases&resourceId=case123 [32m200[0m 0.731 ms - 128[0m
[0mGET /api/v1/rbac/permissions/validate [33m400[0m 0.396 ms - 80[0m
[0mGET /api/v1/rbac/audit-trail?startDate=2023-01-01&endDate=2023-12-31&userId=user123 [32m200[0m 0.800 ms - 421[0m
[0mGET /api/v1/rbac/audit-trail?page=2&limit=10 [32m200[0m 0.522 ms - 423[0m
[0mGET /api/v1/rbac/audit-trail [33m403[0m 0.347 ms - 125[0m
PASS backend src/backend/tests/integration/api.rbac.test.js
  RBAC API Endpoints
    GET /api/v1/rbac/roles
      ✓ should return all available roles with their permissions (59 ms)
      ✓ should return 401 when no authorization header is provided (5 ms)
      ✓ should return 403 when user lacks permission to view roles (5 ms)
    POST /api/v1/rbac/roles/assign
      ✓ should successfully assign roles to a user (8 ms)
      ✓ should validate required fields (5 ms)
      ✓ should reject invalid role names (4 ms)
      ✓ should require admin permissions for role assignment (4 ms)
    DELETE /api/v1/rbac/roles/remove
      ✓ should successfully remove roles from a user (5 ms)
      ✓ should validate user exists before removing roles (4 ms)
    GET /api/v1/rbac/permissions/validate
      ✓ should validate user permissions for specific actions (5 ms)
      ✓ should require action parameter (3 ms)
    GET /api/v1/rbac/audit-trail
      ✓ should return audit trail for role assignments (5 ms)
      ✓ should support pagination (4 ms)
      ✓ should require admin permissions for audit trail access (4 ms)

PASS backend src/backend/tests/unit/device-binding.test.js (12.143 s)
  DeviceBindingService
    NCC Certification Validation
      ✓ should reject device without NCC type approval number (25 ms)
      ✓ should reject invalid NCC certification format (1 ms)
      ✓ should accept valid NCC certification format (1 ms)
      ✓ should display Chinese regulatory warning for certified devices (1 ms)
    Serial Number Management
      ✓ should prevent duplicate serial number registration
      ✓ should validate serial number format per manufacturer spec (2 ms)
      ✓ should track binding timestamp and user info (1 ms)
    BLE Connection Resilience
      ✓ should auto-retry on connection failure (3 attempts) (3004 ms)
      ✓ should fail gracefully after 3 connection attempts (3004 ms)
      ✓ should implement exponential backoff for retries (3008 ms)
      ✓ should support background reconnection strategy (3004 ms)
    Device State Management
      ✓ should track device battery level
      ✓ should alert on low battery (< 20%)
      ✓ should maintain device connection history (1 ms)

PASS frontend tests/guardian.test.js
  安心守護頁面權限測試
    未登入用戶
      ✓ 顯示請先登入提示 (260 ms)
    一般會員
      ✓ 可以看到三個分頁 (28 ms)
      ✓ 家屬分頁顯示需要實名驗證 (35 ms)
      ✓ 志工分頁顯示需要實名驗證 (66 ms)
      ✓ 申辦分頁可查看但不能申辦 (43 ms)
    實名會員
      ✓ 家屬分頁顯示完整功能 (41 ms)
      ✓ 無綁定時顯示綁定提示 (15 ms)
      ✓ 志工分頁可接受任務 (10 ms)
      ✓ 申辦分頁可提交申請 (26 ms)
    承辦人員
      ✓ 顯示管理功能 (32 ms)
      ✓ 家屬分頁顯示額外管理功能 (12 ms)
  導航功能測試
    ✓ URL更新為對應分頁路徑 (22 ms)
  通知徽章測試
    ✓ 志工分頁顯示通知數字 (19 ms)

[0mGET /api/v1/kpi/dashboard [32m200[0m 5.527 ms - 892[0m
[0mGET /api/v1/kpi/dashboard?startDate=2023-01-01&endDate=2023-12-31 [32m200[0m 1.826 ms - 892[0m
[0mGET /api/v1/kpi/dashboard [33m403[0m 1.407 ms - 94[0m
[0mGET /api/v1/kpi/dashboard?useCache=true [32m200[0m 1.677 ms - 892[0m
[0mGET /api/v1/kpi/metrics/cases [32m200[0m 2.182 ms - 624[0m
[0mGET /api/v1/kpi/metrics/volunteers [32m200[0m 1.877 ms - 665[0m
[0mGET /api/v1/kpi/metrics/system [32m200[0m 0.494 ms - 582[0m
[0mGET /api/v1/kpi/metrics/compliance [32m200[0m 1.956 ms - 519[0m
[0mGET /api/v1/kpi/metrics/invalid-type [33m400[0m 1.552 ms - 131[0m
[0mGET /api/v1/kpi/metrics/cases?startDate=2023-01-01&endDate=2023-01-31&granularity=daily [32m200[0m 1.628 ms - 624[0m
[0mGET /api/v1/kpi/metrics/cases?aggregation=weekly&region=%E6%96%B0%E7%AB%B9%E5%B8%82%E6%9D%B1%E5%8D%80 [32m200[0m 2.060 ms - 624[0m
[0mGET /api/v1/kpi/reports/compliance [32m200[0m 2.027 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?format=pdf [32m200[0m 0.594 ms - 993[0m
[0mGET /api/v1/kpi/reports/compliance?period=monthly&year=2023&month=10 [32m200[0m 0.429 ms - 994[0m
[0mGET /api/v1/kpi/reports/compliance?includeRegulatory=true [32m200[0m 0.520 ms - -[0m
[0mGET /api/v1/kpi/reports/compliance [33m403[0m 2.619 ms - 99[0m
[0mGET /api/v1/kpi/alerts [32m200[0m 4.317 ms - 745[0m
[0mGET /api/v1/kpi/alerts?severity=critical [32m200[0m 7.788 ms - 100[0m
PASS backend src/backend/tests/unit/rbac.service.test.js
  RBACService - 角色權限控制服務
    1. Role-Based Access Control (基本角色控制)
      Role Definitions
        ✓ should define Viewer role with read-only permissions (2 ms)
        ✓ should define Operator role with case management permissions (2 ms)
        ✓ should define Admin role with full system permissions (1 ms)
        ✓ should reject invalid role types (213 ms)
      User Role Assignment
        ✓ should assign single role to user (9 ms)
        ✓ should assign multiple roles to user (1 ms)
        ✓ should prevent role escalation without proper authorization (1 ms)
    2. Permission Validation (權限驗證)
      Sensitive Operations
        ✓ should validate permission for case deletion (1 ms)
        ✓ should deny permission for unauthorized export operations (14 ms)
        ✓ should validate emergency override permissions (1 ms)
      Resource-Specific Permissions
        ✓ should validate department-specific case access (1 ms)
        ✓ should deny cross-department case access
    3. Field-Level Visibility Control (欄位級可見性控制)
      PII Protection
        ✓ should hide PII fields from Viewer role (1 ms)
        ✓ should show limited PII to Operator role (1 ms)
        ✓ should show full PII to Admin role (1 ms)
        ✓ should apply custom masking rules for healthcare data (1 ms)
    4. Multi-Tenant Support (多租戶支援)
      Tenant Isolation
        ✓ should isolate data between different county governments (1 ms)
        ✓ should prevent cross-tenant data access (1 ms)
        ✓ should support super-admin cross-tenant access
    5. Session Management with Role Context (角色上下文會話管理)
      Session Creation
        ✓ should create session with role context (1 ms)
        ✓ should set appropriate session timeout based on role (13 ms)
      Session Validation
        ✓ should validate active session with current permissions
        ✓ should invalidate expired sessions (1 ms)
      Role Context Updates
        ✓ should update session when user roles change (1 ms)
    6. Audit Trail for Permission Changes (權限變更稽核軌跡)
      Permission Change Logging
        ✓ should log role assignment with full context
        ✓ should log role removal with approval chain (1 ms)
        ✓ should create immutable audit records (1 ms)
      Audit Query and Review
        ✓ should query audit trail with proper filtering (1 ms)
        ✓ should detect audit trail tampering (1 ms)
    7. Bulk Role Assignments (批量角色指派)
      Department-wide Assignments
        ✓ should assign roles to entire department (1 ms)
        ✓ should handle partial failures in bulk assignment (1 ms)
        ✓ should validate bulk assignment permissions (9 ms)
      CSV Import Role Assignment
        ✓ should process CSV role assignment file (1 ms)
        ✓ should validate CSV format and reject invalid entries (3 ms)
    8. Time-Based Access Controls (時間基礎存取控制)
      Scheduled Access
        ✓ should grant access during business hours (27 ms)
        ✓ should deny access outside business hours (1 ms)
        ✓ should handle emergency override for time restrictions (3 ms)
      Temporary Access Grants
        ✓ should grant temporary elevated access (1 ms)
        ✓ should automatically revoke expired temporary access (6 ms)
    9. Resource-Specific Permissions (資源特定權限)
      Healthcare Data Access
        ✓ should validate medical record access permissions (1 ms)
        ✓ should deny medical access without proper license
      Location-Based Access
        ✓ should validate geographic boundary access (1 ms)
        ✓ should deny access to out-of-jurisdiction resources (6 ms)
    10. Security Event Logging (安全事件記錄)
      Suspicious Activity Detection
        ✓ should detect and log multiple failed access attempts (1 ms)
        ✓ should log privilege escalation attempts (1 ms)
      Compliance Reporting
        ✓ should generate GDPR compliance report
        ✓ should generate Taiwan Personal Data Protection Act report (2 ms)
      Real-time Security Monitoring
        ✓ should trigger real-time alerts for critical events (10 ms)
        ✓ should implement circuit breaker for repeated violations (1 ms)
    Integration with Taiwan Healthcare Regulations
      ✓ should implement NHI data access controls (1 ms)
      ✓ should comply with MOHW data retention policies

[0mGET /api/v1/kpi/alerts?type=performance [32m200[0m 0.525 ms - 318[0m
[0mPOST /api/v1/kpi/reports/generate [32m202[0m 3.080 ms - 173[0m
[0mPOST /api/v1/kpi/reports/generate [33m400[0m 2.739 ms - 92[0m
[0mPOST /api/v1/kpi/reports/generate [33m403[0m 0.468 ms - 98[0m
PASS backend src/backend/tests/unit/kpi.service.test.js
  KPI 服務 (KPI Service)
    即時 KPI 計算與聚合 (Real-time KPI Calculation)
      ✓ 應計算案件處理即時統計 (2 ms)
      ✓ 應聚合多個地理區域的 KPI (1 ms)
      ✓ 應計算分時段的 KPI 趨勢 (1 ms)
      ✓ 應支援即時 KPI 更新推送 (1 ms)
      ✓ 應處理大量並發的 KPI 計算請求 (1 ms)
    案件解決指標 (Case Resolution Metrics)
      ✓ 應計算平均案件回應時間 (19 ms)
      ✓ 應計算案件成功解決率 (1 ms)
      ✓ 應追蹤案件升級和降級模式 (1 ms)
      ✓ 應計算不同優先級案件的 SLA 達成率 (18 ms)
      ✓ 應分析案件重新開啟率 (1 ms)
    志工績效指標 (Volunteer Performance Metrics)
      ✓ 應計算志工活躍度指標 (1 ms)
      ✓ 應追蹤志工回應時間 (1 ms)
      ✓ 應計算志工滿意度評分 (1 ms)
      ✓ 應分析志工培訓完成率 (1 ms)
      ✓ 應追蹤志工留任率 (1 ms)
      ✓ 應計算志工工作負荷分佈 (1 ms)
    系統效能指標 (System Performance Indicators)
      ✓ 應監控 API 回應時間 (13 ms)
      ✓ 應追蹤資料庫查詢效能 (9 ms)
      ✓ 應監控系統記憶體使用率 (1 ms)
      ✓ 應追蹤同時連線使用者數量 (1 ms)
      ✓ 應監控儲存空間使用情況 (1 ms)
    趨勢分析與預測 (Trend Analysis and Forecasting)
      ✓ 應分析案件數量趨勢 (1 ms)
      ✓ 應預測志工需求 (1 ms)
      ✓ 應檢測 KPI 異常模式 (1 ms)
      ✓ 應產生季節性趨勢報告 (1 ms)
      ✓ 應計算 KPI 變化率和成長率 (1 ms)
    警報閾值與通知 (Alert Thresholds and Notifications)
      ✓ 應設定和管理 KPI 警報閾值 (1 ms)
      ✓ 應檢查 KPI 值是否超過閾值 (20 ms)
      ✓ 應發送閾值突破警報 (1 ms)
      ✓ 應管理警報升級機制 (1 ms)
      ✓ 應支援智慧型警報頻率控制 (1 ms)
      ✓ 應產生警報統計報告
    儀表板資料準備 (Dashboard Data Preparation)
      ✓ 應準備即時儀表板資料 (1 ms)
      ✓ 應產生歷史趨勢圖表資料 (17 ms)
      ✓ 應產生地理分佈熱點圖資料 (9 ms)
      ✓ 應產生 KPI 比較表格資料 (1 ms)
      ✓ 應支援儀表板資料的快取機制 (1 ms)
    自訂 KPI 定義 (Custom KPI Definitions)
      ✓ 應允許建立自訂 KPI 指標 (1 ms)
      ✓ 應驗證自訂 KPI 公式的正確性 (1 ms)
      ✓ 應計算自訂 KPI 的數值 (1 ms)
      ✓ 應支援條件式 KPI 計算 (1 ms)
      ✓ 應管理 KPI 計算排程 (1 ms)
      ✓ 應提供 KPI 計算歷史記錄 (1 ms)
      ✓ 應支援 KPI 的版本管理 (1 ms)
      ✓ 應驗證 KPI 數據品質 (1 ms)
    錯誤處理 (Error Handling)
      ✓ 應在 KPI 計算失敗時拋出計算錯誤 (162 ms)
      ✓ 應在閾值設定無效時拋出閾值錯誤 (1 ms)
      ✓ 應在查詢參數無效時拋出驗證錯誤 (1 ms)
      ✓ 應優雅處理資料來源連線失敗 (1 ms)

PASS frontend src/backend/tests/integration/api.kpi.test.js
  KPI API Endpoints
    GET /api/v1/kpi/dashboard
      ✓ should return comprehensive dashboard metrics (37 ms)
      ✓ should support time range filtering (21 ms)
      ✓ should require admin permissions (9 ms)
      ✓ should return cached data when available (9 ms)
    GET /api/v1/kpi/metrics/:type
      ✓ should return case management metrics (12 ms)
      ✓ should return volunteer performance metrics (27 ms)
      ✓ should return system performance metrics (9 ms)
      ✓ should return compliance metrics (14 ms)
      ✓ should validate metric type parameter (8 ms)
      ✓ should support custom date ranges (10 ms)
      ✓ should support different aggregation levels (12 ms)
    GET /api/v1/kpi/reports/compliance
      ✓ should generate comprehensive compliance report (15 ms)
      ✓ should support different report formats (14 ms)
      ✓ should generate monthly compliance reports (11 ms)
      ✓ should include regulatory compliance details (37 ms)
      ✓ should require appropriate permissions for compliance reports (13 ms)
    GET /api/v1/kpi/alerts
      ✓ should return active system alerts (41 ms)
      ✓ should filter alerts by severity (22 ms)
      ✓ should filter alerts by type (18 ms)
    POST /api/v1/kpi/reports/generate
      ✓ should generate custom reports (29 ms)
      ✓ should validate report parameters (13 ms)
      ✓ should require admin permissions for report generation (15 ms)

PASS backend src/backend/tests/unit/device-binding.service.test.js
  DeviceBindingService - RED Phase Tests
    NCC Certification Validation
      validateNCCNumber
        ✓ should accept valid NCC format CCAMYYXX#### (12 characters) (28 ms)
        ✓ should reject invalid NCC format - wrong prefix (72 ms)
        ✓ should reject invalid NCC format - wrong length (19 ms)
        ✓ should reject invalid NCC format - wrong year format (2 ms)
        ✓ should reject invalid NCC format - invalid character patterns (2 ms)
        ✓ should validate NCC number exists in official registry (20 ms)
      getChineseRegulatoryWarning
        ✓ should return Chinese regulatory warning text (1 ms)
        ✓ should include NCC logo and certification mark requirements (9 ms)
    Device Serial Number Management
      registerDevice
        ✓ should prevent duplicate serial number registration (2 ms)
        ✓ should allow registration of new serial number (1 ms)
        ✓ should validate serial number format for Hsinchu devices (18 ms)
      transferDevice
        ✓ should prevent transfer of non-existent device (1 ms)
        ✓ should prevent unauthorized device transfer (1 ms)
    BLE Connection Management
      connectToDevice
        ✓ should handle BLE connection failures with retry logic (3 ms)
        ✓ should implement exponential backoff between retries (2 ms)
        ✓ should handle different BLE error types appropriately (4 ms)
      monitorConnectionHealth
        ✓ should detect connection drops and attempt reconnection (4 ms)
        ✓ should track signal strength and battery level (1 ms)
    Regulatory Compliance
      displayRegulatoryInfo
        ✓ should show complete regulatory information before device binding (2 ms)
        ✓ should require user consent before proceeding with binding (1 ms)
        ✓ should reject consent without proper boolean consentGiven (1 ms)
        ✓ should prevent device binding without proper consent (1 ms)
    Device Status Management
      updateDeviceStatus
        ✓ should track device lifecycle states (2 ms)
    Notification Integration
      deviceStatusNotifications
        ✓ should notify users of successful device binding (1 ms)
        ✓ should notify users of connection issues (1 ms)

PASS backend src/backend/tests/unit/geofence-engine-green.test.js
  GeofenceEngine
    Boundary Event Detection
      ✓ should detect entry within 10m accuracy (5 ms)
      ✓ should detect exit with 30 second delay (103 ms)
      ✓ should not trigger entry if outside radius + accuracy
    Dwell Time Monitoring
      ✓ should track dwell time after 5+ minutes (1 ms)
      ✓ should not trigger dwell alert before 5 minutes
      ✓ should reset dwell time on exit (11 ms)
    Performance & Scalability
      ✓ should handle 100+ simultaneous geofences efficiently (2 ms)
      ✓ should maintain stable memory with many geofences (5 ms)
      ✓ should process batch location updates efficiently (1 ms)

PASS backend src/backend/tests/unit/geofence-engine.service.test.js
  GeofenceEngine - RED Phase Tests
    Boundary Detection with 10m Accuracy
      detectEntry
        ✓ should detect entry within 10m accuracy threshold (38 ms)
        ✓ should not detect entry when GPS accuracy exceeds 10m (168 ms)
        ✓ should handle edge case at exact boundary with GPS uncertainty (2 ms)
      detectExit
        ✓ should detect exit with 30s delay confirmation (2 ms)
        ✓ should cancel exit confirmation if user returns within 30s (2 ms)
        ✓ should handle multiple geofences with independent exit delays (2 ms)
    Cooldown Management (5-minute between notifications)
      notificationCooldown
        ✓ should enforce 5-minute cooldown between notifications (2 ms)
        ✓ should allow notifications after 5-minute cooldown expires (2 ms)
        ✓ should handle different cooldown periods for different event types (1 ms)
        ✓ should allow immediate notifications for different geofences (1 ms)
    Dwell Time Tracking (5+ minutes)
      trackDwellTime
        ✓ should track dwell time when user stays in geofence for 5+ minutes (24 ms)
        ✓ should trigger dwell alerts at specific intervals (2 ms)
        ✓ should reset dwell time when user exits and re-enters (1 ms)
        ✓ should handle movement within geofence without resetting dwell time (2 ms)
    Geofence Configuration and Management
      createGeofence
        ✓ should validate geofence parameters before creation (26 ms)
        ✓ should enforce maximum number of geofences per user (1 ms)
        ✓ should validate geofence names are unique per user (1 ms)
      updateGeofence
        ✓ should handle geofence boundary updates and notify affected users (38 ms)
    Performance and Optimization
      batchLocationProcessing
        ✓ should efficiently process multiple users locations simultaneously (2 ms)
        ✓ should handle high-frequency location updates without performance degradation (3 ms)
    Error Handling and Recovery
      errorRecovery
        ✓ should handle location service failures gracefully (22 ms)
        ✓ should continue processing other geofences when one fails (1 ms)
    Integration with External Services
      emergencyResponse
        ✓ should trigger emergency alerts for critical geofence violations (1 ms)

PASS backend src/backend/tests/unit/audit.service.test.js
  稽核服務 (Audit Service)
    綜合稽核記錄 (Comprehensive Audit Logging)
      ✓ 應記錄使用者登入事件 (1 ms)
      ✓ 應記錄資料存取事件
      ✓ 應記錄系統管理操作 (1 ms)
      ✓ 應記錄資料匯出事件
      ✓ 應記錄失敗的操作嘗試
    稽核軌跡完整性 (Audit Trail Integrity)
      ✓ 應為每筆稽核記錄建立雜湊值 (1 ms)
      ✓ 應建立稽核記錄鏈式雜湊 (1 ms)
      ✓ 應檢測稽核記錄的篡改 (1 ms)
      ✓ 應在檢測到篡改時發送安全警報
      ✓ 應支援稽核記錄的數位簽章 (1 ms)
    合規報告 (Compliance Reporting)
      ✓ 應產生 GDPR 合規報告 (1 ms)
      ✓ 應產生台灣個資法合規報告 (1 ms)
      ✓ 應產生醫療法規合規報告 (1 ms)
      ✓ 應驗證合規報告的完整性 (24 ms)
      ✓ 應自動檢查合規性違規 (1 ms)
    資料存取追蹤 (Data Access Tracking)
      ✓ 應追蹤個人資料的存取模式 (1 ms)
      ✓ 應檢測異常的資料存取行為 (1 ms)
      ✓ 應記錄資料下載和列印事件
      ✓ 應提供資料血緣追蹤 (1 ms)
    安全事件記錄 (Security Event Logging)
      ✓ 應記錄登入失敗事件 (1 ms)
      ✓ 應記錄權限提升事件 (10 ms)
      ✓ 應記錄可疑的檔案存取 (1 ms)
      ✓ 應記錄資料庫直接存取事件
    稽核日誌保留與歸檔 (Audit Log Retention)
      ✓ 應根據保留政策歸檔舊記錄 (1 ms)
      ✓ 應壓縮歸檔的稽核記錄 (1 ms)
      ✓ 應驗證歸檔資料的完整性
      ✓ 應支援歸檔資料的搜尋
    查詢與搜尋功能 (Query and Search)
      ✓ 應支援複雜的稽核記錄查詢 (1 ms)
      ✓ 應支援全文搜尋稽核記錄
      ✓ 應提供稽核統計摘要 (1 ms)
    監管機關匯出功能 (Regulatory Export)
      ✓ 應產生監管機關格式的稽核報告 (13 ms)
      ✓ 應為監管匯出加上浮水印 (1 ms)
      ✓ 應記錄監管機關的資料請求 (1 ms)
      ✓ 應驗證監管匯出的授權 (10 ms)
    錯誤處理 (Error Handling)
      ✓ 應在稽核記錄失敗時拋出錯誤 (60 ms)
      ✓ 應在無效查詢參數時拋出驗證錯誤 (85 ms)
      ✓ 應在未授權存取時拋出安全錯誤 (1 ms)
      ✓ 應在合規檢查失敗時拋出合規錯誤

PASS frontend src/mobile/tests/integration/mobile-services.integration.test.js
  Mobile Services Integration Tests
    BLEBackgroundService - Production Validation
      ✓ should initialize iOS Core Bluetooth successfully (10 ms)
      ✓ should start background scanning with neverForLocation compliance (7 ms)
      ✓ should process discovered devices with anonymization (1 ms)
      ✓ should optimize scanning based on battery level (1 ms)
      ✓ should handle state preservation and restoration (1 ms)
    MyDataIntegrationService - Production Validation
      ✓ should initiate OAuth flow with secure state (1 ms)
      ✓ should generate unique secure state parameters (1 ms)
      ✓ should handle OAuth callback with valid state (2 ms)
      ✓ should exchange authorization code for access token (1 ms)
      ✓ should fetch and filter user profile data (1 ms)
      ✓ should validate data minimization principles (1 ms)
    MobileGeofenceEngine - Production Validation
      ✓ should initialize iOS Core Location successfully (1 ms)
      ✓ should register geofences within platform limits
      ✓ should process location updates and detect geofence events (22 ms)
      ✓ should handle exit confirmation delays (42 ms)
      ✓ should configure iOS notifications properly (1 ms)
      ✓ should initialize Android notifications with proper channels (1 ms)
    Cross-Service Integration
      ✓ should work together for complete guardian functionality (1 ms)

PASS frontend src/mobile/tests/services/MobileGeofenceEngine.test.js
  MobileGeofenceEngine - GREEN Phase Tests
    iOS Core Location Integration
      Location Permission Management
        ✓ should request Always location permission for background geofencing (1 ms)
        ✓ should handle permission upgrade from WhenInUse to Always (1 ms)
        ✓ should provide user guidance when permissions denied (1 ms)
      Core Location Geofence Setup
        ✓ should register geofences with CLLocationManager (1 ms)
        ✓ should handle iOS geofence limit (20 maximum) (164 ms)
        ✓ should configure significant location monitoring as fallback (1 ms)
    Android GeofencingClient Integration
      Android Geofencing Setup
        ✓ should create GeofencingRequest with proper configuration (1 ms)
        ✓ should handle Android background location limitations (13 ms)
        ✓ should implement PendingIntent for geofence transitions (1 ms)
    Accuracy and GPS Uncertainty Handling
      10m Accuracy Requirement
        ✓ should reject location updates with accuracy > 10m (1 ms)
        ✓ should handle GPS uncertainty in boundary detection (1 ms)
        ✓ should implement accuracy-based confidence levels (1 ms)
    Background Processing and Notifications
      Exit Confirmation with 30s Delay
        ✓ should implement 30-second confirmation delay for exits
        ✓ should cancel exit confirmation if user returns within 30s (27 ms)
        ✓ should confirm exit after 30-second delay expires (1 ms)
      Notification Integration
        ✓ should send entry notifications immediately (1 ms)
        ✓ should respect 5-minute notification cooldown
        ✓ should handle critical alerts for emergency geofences (4 ms)
    Backend Integration
      Geofence Synchronization
        ✓ should sync geofences from backend on app launch (1 ms)
        ✓ should report geofence events to backend (1 ms)
        ✓ should queue events for offline sync
    Error Handling and Edge Cases
      Location Service Failures
        ✓ should handle GPS unavailable gracefully (1 ms)
        ✓ should implement fallback strategies for location failures (1 ms)
      Platform-Specific Edge Cases
        ✓ should handle iOS app backgrounding and foregrounding (30 ms)
        ✓ should handle Android doze mode and battery optimization (1 ms)
    Notification Configuration Tests
      ✓ should configure iOS notifications properly
      ✓ should request iOS notification permissions (1 ms)
      ✓ should get notification configuration (12 ms)
      ✓ should initialize Android notifications with proper channels (2 ms)
      ✓ should get notification channel config
      ✓ should check DND status (1 ms)
      ✓ should request Android notification permissions
    Backend Integration Tests
      ✓ should initialize backend integration
      ✓ should sync geofences with backend (1 ms)
      ✓ should send geofence notifications
    Error Handling Tests
      ✓ should handle network failure (1 ms)
      ✓ should handle GPS failure
      ✓ should handle low battery (1 ms)
    Integration Tests
      ✓ should process location updates and detect geofence events
      ✓ should handle exit confirmation delays (1 ms)

PASS validation tests/validation/p1-family-geofence-validation.test.js
  P1 家屬端 Production Validation
    E2E Geofence Scenarios
      進入 (Entry) Scenarios
        ✓ should detect entry into Hsinchu City Hall geofence (3 ms)
        ✓ should handle entry with GPS uncertainty edge cases (56 ms)
      離開 (Exit) Scenarios
        ✓ should implement 30-second exit confirmation delay (2 ms)
        ✓ should cancel exit if user returns within 30 seconds (13 ms)
      停留 (Dwelling) Scenarios
        ✓ should track dwelling time and send periodic updates (13 ms)
    iOS Time-Sensitive Notifications Validation
      ✓ should use Time-Sensitive but NOT Critical level notifications (1 ms)
      ✓ should respect iOS Focus/DND modes appropriately
      ✓ should handle iOS notification authorization correctly (1 ms)
    Android High-Priority Channels Validation
      ✓ should create high-priority channel WITHOUT DND bypass (1 ms)
      ✓ should respect user DND preferences (9 ms)
      ✓ should handle Android 13+ notification permissions (1 ms)
    Geofence Accuracy and Timing Validation
      ✓ should maintain 10m accuracy requirement under various conditions (2 ms)
      ✓ should handle timing precision for event correlation (1 ms)
      ✓ should validate geofence coordinate precision for Hsinchu area (3 ms)
    Production Integration Validation
      ✓ should integrate with real backend API endpoints (1 ms)
      ✓ should handle production error scenarios gracefully (38 ms)

PASS backend src/backend/tests/unit/anonymization.service.test.js
  AnonymizationService
    Device Hash Generation
      One-Way Hash with Salt
        ✓ should generate SHA-256 hash with salt for device MAC address (3 ms)
        ✓ should use consistent salt for same session (14 ms)
        ✓ should generate new salt for new session (1 ms)
        ✓ should make hash irreversible - no reverse lookup possible (1 ms)
      Hash Consistency and Collision Handling
        ✓ should generate same hash for same MAC address in same session (1 ms)
        ✓ should generate different hashes for different MAC addresses (10 ms)
        ✓ should handle hash collisions gracefully (1 ms)
    VolunteerHit Creation
      Complete Data Anonymization
        ✓ should create VolunteerHit with all PII removed (6 ms)
        ✓ should never store original device names (1 ms)
        ✓ should never store device IDs, phone numbers, or personal identifiers (1 ms)
      Location Fuzzing
        ✓ should fuzz location to 100m grid squares (1 ms)
        ✓ should never store precise location coordinates (1 ms)
        ✓ should handle edge cases near grid boundaries (6 ms)
      Timestamp Rounding
        ✓ should round timestamps to 5-minute intervals (1 ms)
        ✓ should never store precise timestamps (1 ms)
        ✓ should handle edge cases at interval boundaries (1 ms)
    K-Anonymity Enforcement
      Minimum Cluster Size Validation
        ✓ should require minimum 3 devices per cluster (1 ms)
        ✓ should allow upload when k=3 minimum is met
        ✓ should queue VolunteerHits until k-anonymity is achieved
        ✓ should upload all queued hits when k-anonymity threshold reached (2 ms)
      Individual Device Identification Prevention
        ✓ should ensure individual devices cannot be identified from clusters (1 ms)
        ✓ should validate that server data cannot reverse lookup individual devices (1 ms)
    Privacy Protection Validation
      Data Minimization
        ✓ should only store essential anonymized data (1 ms)
        ✓ should purge unnecessary metadata and device fingerprints
      Anonymization Verification
        ✓ should verify no reverse lookup is possible from anonymized data
        ✓ should detect and reject data containing PII
    Error Handling and Edge Cases
      Malformed Data Handling
        ✓ should handle malformed MAC addresses gracefully (59 ms)
        ✓ should handle invalid location coordinates gracefully (3 ms)
        ✓ should handle timestamp parsing errors gracefully (28 ms)

PASS backend src/backend/tests/unit/mydata-adapter.test.js
  MyDataAdapter Service
    OAuth Authorization Flow
      ✓ should generate authorization URL with required parameters (2 ms)
      ✓ should handle authorization callback and exchange code for token (20 ms)
      ✓ should reject callback with invalid state (72 ms)
      ✓ should handle token exchange failures (2 ms)
    Data Retrieval with Consent
      ✓ should fetch personal data with valid access token (1 ms)
      ✓ should handle expired token and attempt refresh (23 ms)
      ✓ should enforce single-use token policy (1 ms)
    Data Retention and Cleanup
      ✓ should store data with TTL based on purpose
      ✓ should enforce maximum retention period (1 ms)
      ✓ should automatically clean expired data
    Consent Revocation
      ✓ should immediately delete data on consent revocation
      ✓ should notify MyData platform of revocation (1 ms)
      ✓ should handle cascade deletion of related data (17 ms)
      ✓ should generate revocation receipt (4 ms)
    Audit and Compliance
      ✓ should log all data access attempts (1 ms)
      ✓ should generate compliance report
      ✓ should validate data minimization principle (1 ms)

PASS backend src/backend/tests/unit/geofence-engine.test.js
  GeofenceEngine
    Boundary Events
      ✓ should detect entry within 10m accuracy (8 ms)
      ✓ should detect exit with 30 second delay (2 ms)
      ✓ should track dwell time for 5+ minutes (1 ms)
      ✓ should calculate accurate distance using Haversine formula (1 ms)
    Cooldown Logic
      ✓ should prevent notification spam with 5 min cooldown (2 ms)
      ✓ should handle multiple geofence priority correctly (4 ms)
      ✓ should reset cooldown after period expires (55 ms)
    Performance
      ✓ should handle 100+ simultaneous geofences (5 ms)
      ✓ should implement battery-efficient monitoring (2 ms)
      ✓ should batch process location updates efficiently (2 ms)
      ✓ should cache geofence calculations for performance (1 ms)
    State Management
      ✓ should persist geofence state across restarts (2 ms)
      ✓ should clean up expired geofences (8 ms)

PASS frontend tests/validation/p2-volunteer-ble-validation.test.js
  P2 志工BLE Production Validation
    Android 12+ Permission Management with neverForLocation
      ✓ should request ONLY BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (7 ms)
      ✓ should configure BLE scanning without location inference (18 ms)
      ✓ should handle manifest declaration validation for neverForLocation
      ✓ should create anonymized volunteer hits without any location data (15 ms)
      ✓ should validate Android 12+ runtime permission flow (1 ms)
    iOS State Preservation/Restoration Validation
      ✓ should initialize with proper Core Bluetooth configuration (1 ms)
      ✓ should save complete state when app backgrounded (1 ms)
      ✓ should restore state correctly when app relaunched (2 ms)
      ✓ should handle iOS background app refresh settings (29 ms)
      ✓ should validate iOS State Preservation across app lifecycle (2 ms)
    VolunteerHit Anonymization with NO PII Exposure
      ✓ should ensure absolute PII protection in volunteer hits (24 ms)
      ✓ should implement salted hashing for device identification (47 ms)
      ✓ should enforce K-anonymity before submitting volunteer hits (2 ms)
      ✓ should validate complete anonymization pipeline (4 ms)
    BLE Background Scanning Capabilities
      ✓ should maintain background scanning under battery optimization (8 ms)
      ✓ should handle BLE state changes gracefully (2 ms)
      ✓ should implement adaptive scanning based on discovery rate (1 ms)
      ✓ should validate production BLE integration with backend (1 ms)
    Production Error Handling and Recovery
      ✓ should handle permission revocation gracefully (28 ms)
      ✓ should recover from temporary BLE failures (2 ms)

PASS backend src/backend/tests/unit/volunteer-consent.service.test.js
  VolunteerConsentService
    Consent Management
      grantConsent
        ✓ should enable volunteer mode and start background BLE scanning (30 ms)
        ✓ should record consent timestamp for GDPR compliance (2 ms)
        ✓ should handle consent version updates (1 ms)
      withdrawConsent
        ✓ should immediately disable volunteer mode and stop scanning
        ✓ should cancel all queued data uploads (1 ms)
        ✓ should purge local volunteer data immediately (1 ms)
      checkConsentStatus
        ✓ should return consent status with version information (13 ms)
        ✓ should detect when consent version requires update (1 ms)
    Permission Management
      Android 12+ Permissions
        ✓ should request BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions
        ✓ should conditionally request location permission based on inference setting (1 ms)
        ✓ should set neverForLocation flag when location inference disabled (1 ms)
      iOS Background Permissions
        ✓ should configure bluetooth-central background mode
    Persistence and Recovery
      App Restart Scenarios
        ✓ should preserve consent state across app restarts (1 ms)
        ✓ should resume background scanning automatically after restart
    Error Handling
      Permission Denied Scenarios
        ✓ should handle graceful degradation when BLE permission denied (60 ms)
        ✓ should mark consent as pending when permissions incomplete (1 ms)
    Privacy and GDPR Compliance
      ✓ should anonymize user identifiers in consent records (1 ms)
      ✓ should not store IP addresses or detailed device fingerprints (1 ms)

PASS backend src/backend/tests/unit/geo-alert.service.test.js
  GeoAlertService
    Alert Radius Configuration and Targeting
      500m, 1km, 2km Radius Support
        ✓ should receive alert when within 500m radius (5 ms)
        ✓ should NOT receive alert when outside 1km radius (1 ms)
        ✓ should support 2km radius for wide area alerts (1 ms)
        ✓ should handle edge case at exact radius boundary
    Alert Cooldown and Spam Prevention
      5-Minute Minimum Cooldown
        ✓ should prevent duplicate alerts within 5-minute cooldown (2 ms)
        ✓ should allow alert after 5-minute cooldown expires (2 ms)
        ✓ should show cooldown timer to user (2 ms)
        ✓ should reset cooldown when timer expires (1 ms)
    Privacy Protection - No PII in Alerts
      Alert Content Restrictions
        ✓ should never include names in alert messages (1 ms)
        ✓ should never include age or gender information (10 ms)
        ✓ should never include photos or physical descriptions (2 ms)
        ✓ should use only general area descriptions (3 ms)
    Alert Priority Levels
      Info Level Alerts
        ✓ should send info level with standard notification settings (1 ms)
        ✓ should not override Do Not Disturb for info alerts (1 ms)
      Warning Level Alerts
        ✓ should send warning level with prominent notification (1 ms)
        ✓ should use Time-Sensitive delivery on iOS for warnings (7 ms)
        ✓ should use high importance channel on Android for warnings (1 ms)
      Critical Level Alerts
        ✓ should send critical level with maximum urgency settings (1 ms)
        ✓ should use Critical Alert on iOS if authorized (2 ms)
        ✓ should use Full-Screen Intent on Android with user consent
        ✓ should allow user to dismiss or snooze critical alerts
    Mandatory Safety Instructions
      Required Message Content
        ✓ should always include "請撥打110" in all alert levels (1 ms)
        ✓ should always include "切勿自行接近" in all alert levels (1 ms)
        ✓ should provide emergency contact button in all alerts
        ✓ should provide "回報可疑" button for volunteer coordination (1 ms)
        ✓ should provide safety guidelines link (1 ms)
    A/B Testing for Safety Message Effectiveness
      Message Variant Testing
        ✓ should assign users to A/B test groups for message variations (1 ms)
        ✓ should use variant B wording for test group B (1 ms)
        ✓ should track engagement metrics for A/B test analysis (1 ms)
        ✓ should record user response for effectiveness analysis
        ✓ should ensure core safety instructions remain unchanged across variants
    Error Handling and Edge Cases
      Location Permission Errors
        ✓ should handle location permission denied gracefully (1 ms)
        ✓ should fallback to general notifications when location unavailable
      Push Notification Errors
        ✓ should handle push notification permission disabled (7 ms)
        ✓ should show in-app alert banner when push notifications fail (1 ms)
        ✓ should still attempt delivery for critical alerts when notifications disabled (1 ms)

PASS backend src/backend/tests/unit/revocation.service.test.js
  RevocationService
    Immediate Revocation Processing
      ✓ should process complete revocation within 100ms (2 ms)
      ✓ should delete data from all storage layers (12 ms)
      ✓ should handle partial failures with rollback (95 ms)
    Audit Trail Generation
      ✓ should create comprehensive audit trail for revocation (1 ms)
      ✓ should include all affected data types in audit (1 ms)
      ✓ should generate immutable revocation receipt (1 ms)
    Cascade Deletion
      ✓ should delete all related data in correct order (1 ms)
      ✓ should handle foreign key constraints
      ✓ should notify dependent services before deletion (24 ms)
    Recovery and Rollback
      ✓ should support revocation cancellation within grace period (1 ms)
      ✓ should create backup before permanent deletion (1 ms)
      ✓ should validate revocation request integrity (14 ms)
    Compliance and Verification
      ✓ should verify complete data deletion (1 ms)
      ✓ should detect incomplete deletion (1 ms)
      ✓ should generate GDPR Article 17 compliance report

PASS backend src/backend/tests/unit/retention.service.test.js
  RetentionService
    TTL-based Data Retention
      ✓ should set appropriate TTL based on data purpose (16 ms)
      ✓ should apply minimum retention for regulatory compliance (2 ms)
      ✓ should reduce TTL for sensitive data without explicit consent (16 ms)
    Automated Cleanup Jobs
      ✓ should schedule daily cleanup cron job (3 ms)
      ✓ should cleanup expired personal data (4 ms)
      ✓ should handle cleanup failures gracefully
      ✓ should cleanup orphaned consent records (1 ms)
    Immediate Revocation
      ✓ should immediately delete all data on revocation request (1 ms)
      ✓ should generate deletion certificate (5 ms)
      ✓ should notify related services of revocation (4 ms)
      ✓ should validate revocation request authorization (48 ms)
    Retention Policies
      ✓ should apply data minimization principle (3 ms)
      ✓ should pseudonymize data after initial retention period (9 ms)
      ✓ should enforce different retention periods by data category (2 ms)
    Compliance Reporting
      ✓ should generate GDPR compliance report (2 ms)
      ✓ should track data subject requests (3 ms)

PASS backend src/backend/tests/unit/ble-scanner.service.test.js
  BLEScannerService
    Android 12+ Permission Handling
      neverForLocation Scanning
        ✓ should request only BLUETOOTH_SCAN and BLUETOOTH_CONNECT permissions (3 ms)
        ✓ should discover BLE devices without location inference (1 ms)
        ✓ should generate device hashes with salt immediately (1 ms)
      Location-Based Scanning for Positioning
        ✓ should request location permissions when inference enabled (1 ms)
        ✓ should include RSSI and location data in volunteer hits (1 ms)
        ✓ should fuzz location to 100m grid squares
        ✓ should round timestamps to 5-minute intervals (1 ms)
    iOS Background BLE Handling
      State Preservation
        ✓ should configure CBCentralManager with restore identifier (1 ms)
        ✓ should save scanning state for preservation
      State Restoration
        ✓ should restore scanning state on app launch
        ✓ should resume background scanning automatically (1 ms)
    Device Discovery and Filtering
      RSSI Threshold Filtering
        ✓ should process devices with RSSI stronger than -90 dBm (1 ms)
        ✓ should ignore devices with RSSI weaker than -90 dBm
        ✓ should handle edge case at exactly -90 dBm threshold (1 ms)
      MAC Address Rotation Handling
        ✓ should handle MAC rotation by treating each MAC as separate device
        ✓ should not correlate rotated MAC addresses (1 ms)
        ✓ should maintain k-anonymity across MAC rotations (1 ms)
    Battery-Efficient Scanning
      Power Management
        ✓ should use conservative scanning when not charging
        ✓ should use aggressive scanning when charging (1 ms)
        ✓ should adapt intervals based on detection rate
    VolunteerHit Creation
      Complete Anonymization
        ✓ should create VolunteerHit with all required anonymized fields (1 ms)
        ✓ should never store original MAC addresses (11 ms)
        ✓ should never store device names or personal identifiers (1 ms)
    Error Handling
      BLE Adapter Failures
        ✓ should handle BLE adapter disabled gracefully (1 ms)
        ✓ should resume scanning when Bluetooth is re-enabled (1 ms)
      Permission Revocation
        ✓ should stop scanning immediately when permissions revoked
        ✓ should preserve queued data when permissions revoked (1 ms)
        ✓ should resume from preserved state when permissions re-granted (1 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                    
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                             |   26.52 |    31.53 |   24.96 |   29.31 |                                                                                                                                                                                                                                                                                                      
 backend/coverage                     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 backend/coverage/lcov-report         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 backend/examples                     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  service-usage-example.js            |       0 |        0 |       0 |       0 | 6-233                                                                                                                                                                                                                                                                                                
 backend/services                     |   26.46 |    25.87 |    21.6 |   26.81 |                                                                                                                                                                                                                                                                                                      
  AnonymizationService.js             |       0 |        0 |       0 |       0 | 14-297                                                                                                                                                                                                                                                                                               
  AuditService-enhanced.js            |    38.2 |    37.83 |      36 |   39.53 | 11,107-249,268,281-283,307-308                                                                                                                                                                                                                                                                       
  AuditService.js                     |   24.84 |    22.58 |   15.21 |   25.85 | 41-536,555-569,584-587,616,621-627,689,694,713,736-786                                                                                                                                                                                                                                               
  BLEScannerService.js                |    1.19 |        0 |       0 |    1.19 | 12-258                                                                                                                                                                                                                                                                                               
  CaseFlowService-enhanced.js         |   67.85 |    37.93 |   76.92 |   67.27 | 142,175-214,220,243-267                                                                                                                                                                                                                                                                              
  CaseFlowService-workflow.js         |    8.47 |        0 |    12.5 |    8.62 | 48-223                                                                                                                                                                                                                                                                                               
  CaseFlowService.js                  |    4.58 |     1.78 |    2.43 |    4.65 | 13,21-24,61-729                                                                                                                                                                                                                                                                                      
  GeoAlertService.js                  |    0.66 |        0 |       0 |    0.66 | 13-403                                                                                                                                                                                                                                                                                               
  KPIService-enhanced.js              |    15.9 |     5.26 |      10 |    15.9 | 9,21-302                                                                                                                                                                                                                                                                                             
  KPIService.js                       |     4.9 |     1.09 |    2.94 |    5.26 | 36-629,691-914                                                                                                                                                                                                                                                                                       
  MyDataAdapter.js                    |   52.05 |    53.58 |   44.44 |   53.24 | 60-206,215-261,280-292,328-377,394,410,423-426,429-430,446,452,461-470,512,537-550,566,573-574,642,657,664-679,784,789,794,811,832-858,904,927,959-1011                                                                                                                                              
  MyDataAdapterAPI.js                 |       0 |        0 |       0 |       0 | 10-348                                                                                                                                                                                                                                                                                               
  RBACService.js                      |   39.93 |    41.66 |   40.42 |   39.66 | 13,19-20,25-26,187,195,231,250,272-299,336-369,381-382,398,400,404,406,434,439,446-451,458-474,495-777,805,815,856,875,889,900-911,922-927,951,961,994,1031,1048                                                                                                                                     
  RetentionService.js                 |   45.67 |    41.57 |   47.36 |   45.41 | 23-347,376,433,462-463,516                                                                                                                                                                                                                                                                           
  RevocationService.js                |   56.87 |    36.84 |    37.5 |   57.23 | 49-50,97-112,139-144,164-166,172-173,194,207-220,229-231,252-381,389,418,440,486,497,534-550                                                                                                                                                                                                         
  VolunteerConsentService.js          |       0 |        0 |       0 |       0 | 12-203                                                                                                                                                                                                                                                                                               
 backend/services/safety              |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  index.js                            |       0 |        0 |       0 |       0 | 6-334                                                                                                                                                                                                                                                                                                
 backend/services/safety/case         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  CaseManagementService.js            |       0 |        0 |       0 |       0 | 6-1027                                                                                                                                                                                                                                                                                               
 backend/services/safety/device       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  DeviceBindingService.js             |       0 |        0 |       0 |       0 | 24-322                                                                                                                                                                                                                                                                                               
 backend/services/safety/events       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  EventStreamService.js               |       0 |        0 |       0 |       0 | 6-511                                                                                                                                                                                                                                                                                                
 backend/services/safety/geofence     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  GeofenceService.js                  |       0 |        0 |       0 |       0 | 6-550                                                                                                                                                                                                                                                                                                
 backend/services/safety/matching     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  MatchingService.js                  |       0 |        0 |       0 |       0 | 6-799                                                                                                                                                                                                                                                                                                
 backend/services/safety/mydata       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  MyDataService.js                    |       0 |        0 |       0 |       0 | 6-828                                                                                                                                                                                                                                                                                                
 backend/src                          |   66.66 |    11.11 |   45.45 |   66.66 |                                                                                                                                                                                                                                                                                                      
  app.js                              |      72 |    14.28 |   45.45 |      72 | 81-103                                                                                                                                                                                                                                                                                               
  index.js                            |       0 |        0 |     100 |       0 | 8-15                                                                                                                                                                                                                                                                                                 
 backend/src/constants                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  safety-service.constants.js         |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
 backend/src/hardware                 |    9.74 |     1.56 |    2.85 |    9.93 |                                                                                                                                                                                                                                                                                                      
  ble-manager.js                      |    9.74 |     1.56 |    2.85 |    9.93 | 41-396                                                                                                                                                                                                                                                                                               
 backend/src/middleware               |    62.4 |    44.76 |   64.28 |   61.83 |                                                                                                                                                                                                                                                                                                      
  auth.js                             |   42.42 |     22.4 |   30.76 |   42.42 | 9,220,228,245,259,276-471                                                                                                                                                                                                                                                                            
  error.js                            |   51.51 |    58.69 |   57.14 |   51.51 | 82,87,92-93,98,125-166                                                                                                                                                                                                                                                                               
  index.js                            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  security.js                         |   77.08 |    70.21 |      75 |   76.59 | 41,136-139,170,187,200-211,225                                                                                                                                                                                                                                                                       
  shared.js                           |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                      
  validation.js                       |     100 |    90.47 |     100 |     100 | 67-71                                                                                                                                                                                                                                                                                                
 backend/src/repositories             |    12.5 |        0 |       0 |    12.5 |                                                                                                                                                                                                                                                                                                      
  device.repository.js                |     100 |      100 |       0 |     100 |                                                                                                                                                                                                                                                                                                      
  geofence.repository.js              |    6.66 |        0 |       0 |    6.66 | 12-107                                                                                                                                                                                                                                                                                               
 backend/src/routes                   |    70.3 |    56.28 |   57.14 |   70.27 |                                                                                                                                                                                                                                                                                                      
  ble-scanner.js                      |    37.5 |        0 |       0 |    37.5 | 12-39,51-58,75-82,95-102,115-122                                                                                                                                                                                                                                                                     
  cases-additional.js                 |   57.14 |    30.55 |      75 |   57.14 | 15-71,95,105,140-198,291-292,317,349-350                                                                                                                                                                                                                                                             
  cases.js                            |   81.39 |    62.13 |     100 |   81.39 | 33,74-79,87-97,130-143,177,202-203,223,262,281,324,338-345,380,406,424-432                                                                                                                                                                                                                           
  device-binding.js                   |   36.36 |      100 |       0 |   36.36 | 12-43,67-79,92-99,112-119,132-139                                                                                                                                                                                                                                                                    
  index.js                            |    92.5 |    16.66 |      60 |    92.5 | 33,43,68                                                                                                                                                                                                                                                                                             
  kpi-enhanced.js                     |      25 |        0 |       0 |   25.45 | 24-51,59-130,138-150,158-175                                                                                                                                                                                                                                                                         
  kpi.js                              |    81.1 |    69.69 |    87.5 |   80.64 | 96,119,140-147,169-180,188-259,343,440,507,555,563-573                                                                                                                                                                                                                                               
  mydata.js                           |   84.72 |    76.08 |   83.33 |   84.72 | 13,26,54,68,106,130,176,193,203,250,285                                                                                                                                                                                                                                                              
  rbac.js                             |   88.33 |    87.87 |     100 |   88.33 | 35-36,81,95,120,156,198                                                                                                                                                                                                                                                                              
 backend/src/services                 |   71.28 |    57.19 |    71.5 |   71.26 |                                                                                                                                                                                                                                                                                                      
  ServiceContainer.js                 |   71.42 |       48 |   67.85 |   71.42 | 37,78,114,124-125,153-154,177,184,216-222,260-278,300-303,313-329,351-354                                                                                                                                                                                                                            
  anonymization.service.js            |   78.62 |    73.52 |      84 |   78.87 | 32,37,106,155,160,181,208-212,229-260,284,290,310,361,389-399,408                                                                                                                                                                                                                                    
  audit-log.service.js                |      20 |        0 |       0 |      20 | 8-18                                                                                                                                                                                                                                                                                                 
  audit.service.js                    |   89.67 |    60.82 |   87.23 |    89.4 | 31-39,45-48,188,461,463,718-722                                                                                                                                                                                                                                                                      
  ble-scanner.service.js              |   62.94 |    48.36 |   75.67 |   63.05 | 69,74,117-123,134,145-146,182,237,254,259,282,297,331,348,369,384-409,422-432,459,471,483,513,535,543-662,678,690,701-779                                                                                                                                                                            
  case-flow.service.js                |   92.27 |    76.56 |   94.04 |    92.7 | 110,114,118,122,126,260,269,328,376,400-401,416,427,465,485,539,579,597,613,660,684,689,715,747,777,797,830,869,903,923,1038,1071,1103,1112                                                                                                                                                          
  event-emitter.service.js            |   11.11 |        0 |       0 |   11.11 | 7-34                                                                                                                                                                                                                                                                                                 
  geo-alert.service.js                |    14.1 |     3.38 |   14.81 |   14.19 | 28,41,47-359,368-490                                                                                                                                                                                                                                                                                 
  index.js                            |      50 |        0 |      25 |      50 | 31-59                                                                                                                                                                                                                                                                                                
  kpi.service.js                      |   83.89 |    55.55 |   98.88 |   83.05 | 65,85,102,120,153,174,205,230,251,279,303,317,326,345,364,384,410,429,450,469,489,514,538,552,572,598,644,650,666,686,706-712,733-739,761,774,793,808,829,850,859,886,900,905,926,942,961,984,1002,1024,1040,1069,1092,1102,1110,1117,1136,1146,1174,1178,1182                                       
  location.service.js                 |    5.26 |        0 |       0 |    5.88 | 16-71                                                                                                                                                                                                                                                                                                
  mydata-adapter.service.js           |      63 |    42.25 |   63.63 |   62.79 | 150-170,404-689                                                                                                                                                                                                                                                                                      
  notification.service.js             |   15.38 |      100 |       0 |   15.38 | 8-39                                                                                                                                                                                                                                                                                                 
  rbac.service.js                     |   56.72 |    49.56 |   45.79 |   57.33 | 106-188,275-276,303,327,375-377,386-396,525,569,598-606,650-677,714-732,765-768,820-823,840-850,861,874,915-951,956,979,1001-1033,1057,1066-1067,1103-1123,1133-1154,1164-1166,1234,1248-1264,1279,1305-1306,1309,1325-1341,1364,1372-1435,1455,1475-1654,1675-1699,1769-1797,1822                   
  retention.service.js                |   92.38 |    68.33 |      95 |   92.15 | 59-62,115,206-207,258-259                                                                                                                                                                                                                                                                            
  revocation.service.js               |   91.17 |     67.5 |   94.44 |   91.83 | 78,184,232,236,292-304                                                                                                                                                                                                                                                                               
  volunteer-consent.service.js        |   87.23 |    73.52 |   86.66 |   87.23 | 91,125,137,158,189,207,237-255,286,296                                                                                                                                                                                                                                                               
 backend/src/services/safety          |   75.75 |    67.56 |   74.69 |   76.15 |                                                                                                                                                                                                                                                                                                      
  device-binding-simple.service.js    |   93.05 |    89.36 |   77.77 |   92.64 | 131,145,168,176-177                                                                                                                                                                                                                                                                                  
  device-binding.service.js           |   78.89 |    72.41 |   86.66 |   79.43 | 36,62,93,130,184,198,216,262,284,299-308,331,337,346-349,428,434,460-463                                                                                                                                                                                                                             
  errors.js                           |   84.21 |    83.33 |   83.33 |   84.21 | 32-34                                                                                                                                                                                                                                                                                                
  geofence-engine-simple.service.js   |   51.28 |    38.33 |   45.45 |   52.21 | 23,27,87,109,174-300                                                                                                                                                                                                                                                                                 
  geofence-engine.service.js          |   79.71 |    68.57 |   87.09 |   80.07 | 46,99,151,327,455,512-563,587,608,627-637,676,692,726,760,937,947-950,1002-1053                                                                                                                                                                                                                      
 backend/src/services/safety/device   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  DeviceBindingService.js             |       0 |        0 |       0 |       0 | 24-308                                                                                                                                                                                                                                                                                               
 backend/src/utils                    |    9.87 |     3.59 |   14.28 |   10.12 |                                                                                                                                                                                                                                                                                                      
  battery-optimization.js             |       0 |        0 |       0 |       0 | 10-55                                                                                                                                                                                                                                                                                                
  errors.js                           |   72.72 |    71.42 |   71.42 |   72.72 | 32-42                                                                                                                                                                                                                                                                                                
  permissions.js                      |       0 |        0 |       0 |       0 | 9-93                                                                                                                                                                                                                                                                                                 
  validation.utils.js                 |       0 |        0 |       0 |       0 | 17-513                                                                                                                                                                                                                                                                                               
 backend/tests                        |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  setup.js                            |       0 |        0 |       0 |       0 | 2-135                                                                                                                                                                                                                                                                                                
 backend/tests/helpers                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  jwt-helper.js                       |       0 |        0 |       0 |       0 | 1-83                                                                                                                                                                                                                                                                                                 
 backend/tests/integration            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  api.cases.test.js                   |       0 |      100 |       0 |       0 | 1-289                                                                                                                                                                                                                                                                                                
  api.kpi.test.js                     |       0 |      100 |       0 |       0 | 1-355                                                                                                                                                                                                                                                                                                
  api.mydata.test.js                  |       0 |      100 |       0 |       0 | 1-321                                                                                                                                                                                                                                                                                                
  api.rbac.test.js                    |       0 |        0 |       0 |       0 | 1-218                                                                                                                                                                                                                                                                                                
  middleware.test.js                  |       0 |      100 |       0 |       0 | 1-377                                                                                                                                                                                                                                                                                                
 backend/tests/setup                  |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  test-auth.js                        |       0 |        0 |       0 |       0 | 6-142                                                                                                                                                                                                                                                                                                
  test-config.js                      |       0 |        0 |       0 |       0 | 8-239                                                                                                                                                                                                                                                                                                
  test-setup.config.js                |       0 |        0 |       0 |       0 | 15-318                                                                                                                                                                                                                                                                                               
 backend/tests/unit                   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  anonymization.service.test.js       |       0 |        0 |       0 |       0 | 2-698                                                                                                                                                                                                                                                                                                
  audit.service.test.js               |       0 |      100 |       0 |       0 | 18-971                                                                                                                                                                                                                                                                                               
  ble-scanner.service.test.js         |       0 |        0 |       0 |       0 | 4-806                                                                                                                                                                                                                                                                                                
  case-flow.service.test.js           |       0 |        0 |       0 |       0 | 22-1227                                                                                                                                                                                                                                                                                              
  device-binding-green.test.js        |       0 |        0 |       0 |       0 | 6-253                                                                                                                                                                                                                                                                                                
  device-binding.service.test.js      |       0 |        0 |       0 |       0 | 1-544                                                                                                                                                                                                                                                                                                
  device-binding.test.js              |       0 |      100 |       0 |       0 | 6-239                                                                                                                                                                                                                                                                                                
  geo-alert.service.test.js           |       0 |      100 |       0 |       0 | 4-751                                                                                                                                                                                                                                                                                                
  geofence-engine-green.test.js       |       0 |        0 |       0 |       0 | 6-219                                                                                                                                                                                                                                                                                                
  geofence-engine.service.test.js     |       0 |        0 |       0 |       0 | 1-976                                                                                                                                                                                                                                                                                                
  geofence-engine.test.js             |       0 |        0 |       0 |       0 | 6-412                                                                                                                                                                                                                                                                                                
  kpi.service.test.js                 |       0 |      100 |       0 |       0 | 18-1351                                                                                                                                                                                                                                                                                              
  mydata-adapter.test.js              |       0 |        0 |       0 |       0 | 1-426                                                                                                                                                                                                                                                                                                
  rbac.service.test.js                |       0 |      100 |       0 |       0 | 20-1104                                                                                                                                                                                                                                                                                              
  retention.service.test.js           |       0 |      100 |       0 |       0 | 1-379                                                                                                                                                                                                                                                                                                
  revocation.service.test.js          |       0 |      100 |       0 |       0 | 1-393                                                                                                                                                                                                                                                                                                
  volunteer-consent.service.test.js   |       0 |      100 |       0 |       0 | 4-432                                                                                                                                                                                                                                                                                                
 mobile                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  babel.config.js                     |       0 |      100 |     100 |       0 | 1                                                                                                                                                                                                                                                                                                    
  jest.setup.js                       |       0 |        0 |       0 |       0 | 2-166                                                                                                                                                                                                                                                                                                
  metro.config.js                     |       0 |      100 |     100 |       0 | 1-11                                                                                                                                                                                                                                                                                                 
 mobile/coverage/lcov-report          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  block-navigation.js                 |       0 |        0 |       0 |       0 | 2-87                                                                                                                                                                                                                                                                                                 
  prettify.js                         |       0 |        0 |       0 |       0 | 2                                                                                                                                                                                                                                                                                                    
  sorter.js                           |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                
 mobile/src/services                  |   63.86 |     53.9 |   75.61 |   63.97 |                                                                                                                                                                                                                                                                                                      
  BLEBackgroundService.js             |   47.96 |    45.93 |   60.68 |   48.08 | 82-83,113,145,162,208-209,233,259,269-353,388,397-537,556-647,671-805,818-827,851,856-857,876-932,953-954,963-966,980,1006-1101,1119-1120,1137-1236,1361-1362,1391,1400-1401,1439,1452-1460,1579,1631,1665,1680-1684,1704,1722,1730,1744-1755,1772,1775-1778,1786-1788,1793-1794,1796-1797,1799-1800 
  MobileGeofenceEngine.js             |   91.41 |    78.09 |      92 |   92.07 | 66,86-87,216,296,362,373,413,421,516-517,605-606,615-617,673,730                                                                                                                                                                                                                                     
  MyDataIntegrationService.js         |   89.31 |    73.07 |      86 |   88.97 | 126-131,140-151,180,279-280,373-374,406-410                                                                                                                                                                                                                                                          
 mobile/tests/integration             |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  mobile-services.integration.test.js |       0 |      100 |       0 |       0 | 6-295                                                                                                                                                                                                                                                                                                
 mobile/tests/services                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                      
  BLEBackgroundService.test.js        |       0 |        0 |       0 |       0 | 13-678                                                                                                                                                                                                                                                                                               
  MobileGeofenceEngine.test.js        |       0 |        0 |       0 |       0 | 13-853                                                                                                                                                                                                                                                                                               
  MyDataIntegrationService.test.js    |       0 |      100 |       0 |       0 | 13-736                                                                                                                                                                                                                                                                                               
--------------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (50%) not met: 26.52%
Jest: "global" coverage threshold for branches (50%) not met: 31.53%
Jest: "global" coverage threshold for lines (50%) not met: 29.31%
Jest: "global" coverage threshold for functions (50%) not met: 24.96%
Summary of all failing tests
FAIL src/backend/tests/integration/middleware.test.js (6.235 s)
  ● API Middleware › RBAC Permission Middleware › should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p3-mydata-validation.test.js (7.427 s)
  ● P3 MyData Production Validation › OAuth2 Flow Compliance › should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

FAIL src/backend/tests/integration/api.cases.test.js (5.967 s)
  ● Case Flow API Endpoints › POST /api/v1/cases/create › should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "陳小華",
            "phone": "0912345678",
            "relationship": "女兒",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:08.324Z",
    +     "createdBy": "admin123",
          "description": "78歲陳老先生在大潤發走失",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-910",
    +     "location": Object {
            "address": "新竹市東區光復路二段101號",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "身高約165cm，穿深色衣服",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "陳老先生",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "失智長者走失案件",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:08.324Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › PUT /api/v1/cases/:id/status › should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/search › should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:07.823Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:07.823Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "新竹市東區○○路123號",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "阿茲海默症第二期",
    +         "patientName": "王○○",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "失智長者走失案件",
    +       "workflow": Object {
    +         "currentStage": "建立",
    +         "nextStages": Array [
    +           "派遣",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "建立",
    +             "timestamp": "2025-09-18T07:25:07.823Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p4-console-rbac-validation.test.js
  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should prevent non-承辦 users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:09.981Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "新竹市北區",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[○×]+$/,
    +     "medicalHistory": "輕度認知障礙",
    +     "patientName": "○○○",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "志工協助案件",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "建立",
    +     "nextStages": Array [
    +       "派遣",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "派遣",
    + Object {
    +   "currentStage": "建立",
        "nextStages": Array [
    -     "執行中",
    -     "結案",
    +     "派遣",
        ],
    -   "previousStage": "建立",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "派遣",
    -       "timestamp": Any<String>,
    +       "stage": "建立",
    +       "timestamp": "2025-09-18T07:25:10.730Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: '派遣',
      451 |         previousStage: '建立',
      452 |         nextStages: ['執行中', '結案'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "法院要求提供證據資料",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:11.205Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_F634C32BDCAB53C236B4CD2D6E6878EA_5BB680A5",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.承辦人員.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/backend/tests/integration/middleware.test.js
  ● API Middleware › RBAC Permission Middleware › should check resource-specific permissions

    expected 403 "Forbidden", got 404 "Not Found"

       99 |         .get('/api/v1/cases/other-user-case')
      100 |         .set('Authorization', 'Bearer user-token')
    > 101 |         .expect(403);
          |          ^
      102 |
      103 |       expect(response.body.message).toContain('Insufficient permissions');
      104 |     });

      at Object.expect (src/backend/tests/integration/middleware.test.js:101:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

FAIL tests/validation/p3-mydata-validation.test.js
  ● P3 MyData Production Validation › OAuth2 Flow Compliance › should implement complete OAuth2 authorization code flow

    Invalid session

      388 |     const session = await this.getSession(sessionId);
      389 |     if (!session) {
    > 390 |       throw new Error('Invalid session');
          |             ^
      391 |     }
      392 |
      393 |     if (session.status === 'expired') {

      at MyDataAdapter.exchangeCodeForToken (src/backend/services/MyDataAdapter.js:390:13)
      at Object.<anonymous> (tests/validation/p3-mydata-validation.test.js:588:29)

FAIL src/mobile/tests/services/BLEBackgroundService.test.js
  ● BLEBackgroundService - GREEN Phase Tests › Android 12+ Permission Management › neverForLocation Mode › should create anonymized volunteer hits without location data

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      117 |         expect(result.gridSquare).toBeNull();
      118 |         expect(result.anonymousVolunteerId).toMatch(/^[a-f0-9-]{36}$/);
    > 119 |         expect(result.locationDataIncluded).toBe(false);
          |                                             ^
      120 |       });
      121 |     });
      122 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:119:45)

  ● BLEBackgroundService - GREEN Phase Tests › Android 12+ Permission Management › Location-Based Mode for Positioning › should include fuzzed location in volunteer hits

    expect(received).toEqual(expected) // deep equality

    - Expected  - 5
    + Received  + 5

    - ObjectContaining {
    -   "anonymousVolunteerId": Any<String>,
    -   "deviceHash": Any<String>,
    -   "gridSquare": "24.8068,120.9687",
    + Object {
    +   "anonymousVolunteerId": "550e8400-e29b-41d4-a716-01995bb69243",
    +   "deviceHash": "24f697a624f697a624f697a624f697a624f697a624f697a624f697a624f697a6",
    +   "gridSquare": null,
        "rssi": -70,
    -   "timestamp": StringMatching /^\d{4}-\d{2}-\d{2}T\d{2}:(00|05|10|15|20|25|30|35|40|45|50|55):00\.000Z$/,
    +   "timestamp": "2025-09-18T07:25:00.000Z",
      }

      166 |
      167 |         // Assert
    > 168 |         expect(result).toEqual(expect.objectContaining({
          |                        ^
      169 |           deviceHash: expect.any(String),
      170 |           rssi: -70,
      171 |           gridSquare: '24.8068,120.9687', // Fuzzed to 100m grid

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:168:24)

  ● BLEBackgroundService - GREEN Phase Tests › iOS Core Bluetooth Integration › State Preservation and Restoration › should restore state when app is relaunched

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      265 |
      266 |         // Assert
    > 267 |         expect(result.success).toBe(true);
          |                                ^
      268 |         expect(result.restored).toBe(true);
      269 |         expect(bleService.isScanning()).toBe(true);
      270 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:267:32)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should adjust scan intervals based on battery level

    expect(received).toBe(expected) // Object.is equality

    Expected: "conservative"
    Received: "aggressive"

      297 |         // Assert - When battery is low (25%)
      298 |         expect(result.success).toBe(true);
    > 299 |         expect(result.powerMode).toBe('conservative');
          |                                  ^
      300 |         expect(result.batteryLevel).toBe(0.25);
      301 |         expect(result.charging).toBe(false);
      302 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:299:34)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should use aggressive scanning when charging

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.8
    Received: undefined

      313 |         expect(result.success).toBe(true);
      314 |         expect(result.powerMode).toBe('aggressive');
    > 315 |         expect(result.batteryLevel).toBe(0.80);
          |                                     ^
      316 |         expect(result.charging).toBe(true);
      317 |       });
      318 |

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:315:37)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › Battery-Aware Scanning › should implement adaptive scanning based on discovery rate

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      329 |
      330 |         // Assert - For low discovery areas
    > 331 |         expect(result.success).toBe(true);
          |                                ^
      332 |         expect(result.strategy).toBe('minimal');
      333 |         expect(bleService.getScanParameters().scanIntervalMs).toBeGreaterThan(50000); // Very long intervals for minimal
      334 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:331:32)

  ● BLEBackgroundService - GREEN Phase Tests › Background Scanning Optimization › RSSI Filtering and Device Processing › should handle MAC address rotation without correlation

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      380 |
      381 |         // Assert - Each MAC treated as separate device
    > 382 |         expect(bleService.getProcessedDeviceCount()).toBe(3);
          |                                                      ^
      383 |         // No correlation maps should exist for privacy
      384 |         expect(bleService.getMacCorrelationMap).toBeUndefined();
      385 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:382:54)

  ● BLEBackgroundService - GREEN Phase Tests › Privacy and Anonymization › K-Anonymity Enforcement › should ensure minimum k=3 anonymity before submitting hits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      401 |
      402 |         // Assert
    > 403 |         expect(validationResult.isAnonymous).toBe(true);
          |                                              ^
      404 |         expect(validationResult.k).toBe(3);
      405 |         expect(validationResult.canSubmit).toBe(true);
      406 |       });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:403:46)

  ● BLEBackgroundService - GREEN Phase Tests › Privacy and Anonymization › K-Anonymity Enforcement › should queue hits when k-anonymity threshold not met

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 1

      418 |         // Assert
      419 |         expect(validationResult.isAnonymous).toBe(false);
    > 420 |         expect(validationResult.k).toBe(2);
          |                                    ^
      421 |         expect(validationResult.canSubmit).toBe(false);
      422 |       });
      423 |     });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:420:36)

  ● BLEBackgroundService - GREEN Phase Tests › Backend Integration › Volunteer Hit Submission › should handle API failures gracefully with retry logic

    Network error

      510 |           callCount++;
      511 |           if (callCount <= 2) {
    > 512 |             throw new Error('Network error');
          |                   ^
      513 |           }
      514 |           return { success: true, submittedCount: 1 };
      515 |         });

      at BLEBackgroundService.<anonymous> (src/mobile/tests/services/BLEBackgroundService.test.js:512:19)
      at Object.submitVolunteerHits (src/mobile/tests/services/BLEBackgroundService.test.js:518:33)

  ● BLEBackgroundService - GREEN Phase Tests › Backend Integration › Volunteer Hit Submission › should queue hits offline and sync when connected

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      548 |         // Assert
      549 |         expect(syncResult.success).toBe(true);
    > 550 |         expect(syncResult.synced).toBe(2);
          |                                   ^
      551 |       });
      552 |     });
      553 |   });

      at Object.toBe (src/mobile/tests/services/BLEBackgroundService.test.js:550:35)

  ● BLEBackgroundService - GREEN Phase Tests › Error Handling and Recovery › Permission Revocation › should stop scanning when permissions are revoked

    TypeError: bleService.isScanning is not a function

      567 |         // Assert
      568 |         expect(result.success).toBe(true);
    > 569 |         expect(bleService.isScanning()).toBe(false);
          |                           ^
      570 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
      571 |           error: 'permissions_revoked',
      572 |           userActionRequired: true

      at Object.isScanning (src/mobile/tests/services/BLEBackgroundService.test.js:569:27)

  ● BLEBackgroundService - GREEN Phase Tests › Error Handling and Recovery › Bluetooth State Changes › should handle Bluetooth disabled gracefully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 2

    - ObjectContaining {
    -   "bluetoothState": "PoweredOff",
    -   "canRetry": true,
    + Object {
    +   "error": null,
        "isScanning": false,
    -   "userGuidance": "請開啟藍牙以繼續掃描",
      }

      604 |         expect(result.canScan).toBe(false);
      605 |         expect(result.userGuidanceRequired).toBe(true);
    > 606 |         expect(bleService.getStatus()).toEqual(expect.objectContaining({
          |                                        ^
      607 |           isScanning: false,
      608 |           bluetoothState: 'PoweredOff',
      609 |           userGuidance: '請開啟藍牙以繼續掃描',

      at Object.toEqual (src/mobile/tests/services/BLEBackgroundService.test.js:606:40)

FAIL tests/validation/p4-console-rbac-validation.test.js
  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should prevent non-承辦 users from accessing sensitive personal data

    expected 403 "Forbidden", got 200 "OK"

      212 |           .get(`/api/v1/cases/${testCases[0].id}`)
      213 |           .set('Authorization', `Bearer ${userToken}`)
    > 214 |           .expect(403);
          |            ^
      215 |
      216 |         // Verify access denied
      217 |         expect(response.body).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:214:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should provide filtered data based on user clearance level

    expect(received).toEqual(expected) // deep equality

    - Expected  -  8
    + Received  + 14

    - ObjectContaining {
    -   "assignedVolunteers": undefined,
    + Object {
    +   "assignedWorker": "social-worker-002",
    +   "createdAt": "2025-09-18T07:25:14.019Z",
    +   "createdBy": "volunteer-coord-003",
        "dataFiltered": true,
        "filterReason": "clearance_level_restriction",
        "id": "CASE-2025-002",
    -   "locationData": undefined,
    -   "personalData": ObjectContaining {
    -     "address": undefined,
    +   "personalData": Object {
          "age": 65,
    -     "emergencyContacts": undefined,
          "generalLocation": "新竹市北區",
    -     "medicalHistory": Any<String>,
    -     "patientName": StringMatching /^[○×]+$/,
    +     "medicalHistory": "輕度認知障礙",
    +     "patientName": "○○○",
        },
        "priority": "medium",
    +   "sensitivityLevel": "restricted",
        "status": "pending",
        "title": "志工協助案件",
        "userClearanceLevel": "restricted",
    +   "workflow": Object {
    +     "currentStage": "建立",
    +     "nextStages": Array [
    +       "派遣",
    +     ],
    +   },
      }

      252 |
      253 |       // Verify filtered response
    > 254 |       expect(response.body.data).toEqual(expect.objectContaining({
          |                                  ^
      255 |         id: testCases[1].id,
      256 |         title: testCases[1].title,
      257 |         status: testCases[1].status,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:254:34)

  ● P4 承辦Console Production Validation › RBAC Restrictions - Non-承辦 Access Control › should enforce field-level access control

    expect(received).toContain(expected) // indexOf

    Expected substring: "auditor_no_personal_data_access"
    Received string:    "external_auditor_role_restriction"

      328 |
      329 |         expect(fieldAccessResult.hasAccess).toBe(test.shouldHaveAccess);
    > 330 |         expect(fieldAccessResult.reason).toContain(test.reason);
          |                                          ^
      331 |
      332 |         if (!test.shouldHaveAccess) {
      333 |           expect(fieldAccessResult.alternatives).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:330:42)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce complete case creation workflow

    expect(received).toEqual(expected) // deep equality

    - Expected  - 15
    + Received  +  8

    - ObjectContaining {
    -   "assignmentCompleted": true,
    -   "currentStage": "派遣",
    + Object {
    +   "currentStage": "建立",
        "nextStages": Array [
    -     "執行中",
    -     "結案",
    +     "派遣",
        ],
    -   "previousStage": "建立",
    -   "stageHistory": ArrayContaining [
    -     ObjectContaining {
    -       "details": ObjectContaining {
    -         "assignedWorker": "social-worker-002",
    -         "resourcesConfirmed": true,
    -         "volunteerCount": 3,
    -       },
    +   "stageHistory": Array [
    +     Object {
            "performer": "case-worker-001",
    -       "stage": "派遣",
    -       "timestamp": Any<String>,
    +       "stage": "建立",
    +       "timestamp": "2025-09-18T07:25:14.504Z",
    +       "validationsPassed": true,
          },
        ],
      }

      447 |
      448 |       // Verify assignment workflow
    > 449 |       expect(assignmentResponse.body.data.workflow).toEqual(expect.objectContaining({
          |                                                     ^
      450 |         currentStage: '派遣',
      451 |         previousStage: '建立',
      452 |         nextStages: ['執行中', '結案'],

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:449:53)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should enforce role-based workflow permissions

    expect(received).toContain(expected) // indexOf

    Expected substring: "family_members_cannot_update_status"
    Received string:    "family_member_cannot_update_case_status"

      620 |
      621 |         expect(permissionResult.allowed).toBe(test.allowed);
    > 622 |         expect(permissionResult.reason).toContain(test.reason);
          |                                         ^
      623 |
      624 |         if (!test.allowed) {
      625 |           expect(permissionResult.alternativeActions).toBeDefined();

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:622:41)

  ● P4 承辦Console Production Validation › Case Flow: 建立→派遣→結案 Workflow Validation › should validate workflow state transitions

    TypeError: caseFlowService.validateStateTransition is not a function

      646 |
      647 |       for (const transition of validTransitions) {
    > 648 |         const transitionResult = await caseFlowService.validateStateTransition({
          |                                                        ^
      649 |           fromState: transition.from,
      650 |           toState: transition.to,
      651 |           caseId: 'test-case-transition',

      at Object.validateStateTransition (tests/validation/p4-console-rbac-validation.test.js:648:56)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create watermarked audit entries for all read operations

    expected 200 "OK", got 404 "Not Found"

      702 |             .set('Authorization', `Bearer ${userToken}`)
      703 |             .send(operation.body || {})
    > 704 |             .expect(200);
          |              ^
      705 |         }
      706 |
      707 |         // Verify watermarked audit entry created

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:704:14)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should create enhanced audit trails for export operations

    expect(received).toEqual(expected) // deep equality

    - Expected  - 11
    + Received  + 24

    - ObjectContaining {
    -   "exportDetails": ObjectContaining {
    + Object {
    +   "action": "data_export",
    +   "exportDetails": Object {
          "approvalReference": "COURT-REQ-2025-001",
          "exportReason": "法院要求提供證據資料",
          "exportedCases": Array [
            "CASE-2025-001",
          ],
    -     "exportedFields": Any<Array>,
    +     "exportedFields": Array [
    +       "case_id",
    +       "personal_data",
    +       "location_data",
    +     ],
          "format": "pdf",
          "includePersonalData": true,
          "sensitiveDataIncluded": true,
        },
    -   "legalCompliance": ObjectContaining {
    +   "immutable": true,
    +   "legalCompliance": Object {
          "approvalDocumented": true,
          "dataProtectionActCompliance": true,
          "personalDataExportJustified": true,
          "recipientVerified": true,
        },
    -   "operation": "data_export",
    -   "securityEnhancements": ObjectContaining {
    -     "accessRestrictions": Any<Object>,
    -     "digitalSignature": Any<String>,
    -     "disposalSchedule": Any<String>,
    +   "resource": "CASE-2025-001",
    +   "result": "success",
    +   "securityEnhancements": Object {
    +     "accessRestrictions": Object {
    +       "copyRestricted": true,
    +       "printRestricted": true,
    +       "viewOnly": true,
    +     },
    +     "digitalSignature": "mock_signature",
    +     "disposalSchedule": "secure_deletion_after_retention",
          "fileWatermarked": true,
    -     "retentionPolicy": Any<String>,
    +     "retentionPolicy": "7_years",
        },
    +   "securityFlag": undefined,
    +   "timestamp": "2025-09-18T07:25:15.095Z",
        "userId": "case-worker-001",
    -   "watermark": StringMatching /^WM_EXPORT_[A-F0-9]{32}_[A-F0-9]{8}$/,
    +   "watermark": "WM_EXPORT_ED39F3987BA4CED639A3BA1A72371603_5BB68FD7",
      }

      765 |       });
      766 |
    > 767 |       expect(exportAudit).toEqual(expect.objectContaining({
          |                           ^
      768 |         // Standard audit fields
      769 |         operation: 'data_export',
      770 |         userId: testUsers.承辦人員.id,

      at Object.toEqual (tests/validation/p4-console-rbac-validation.test.js:767:27)

  ● P4 承辦Console Production Validation › Audit Trails with Watermarks › should maintain audit chain integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      838 |       // Verify audit chain integrity
      839 |       const chainValidation = await auditService.validateAuditChain(auditEntries);
    > 840 |       expect(chainValidation.valid).toBe(true);
          |                                     ^
      841 |       expect(chainValidation.chainIntact).toBe(true);
      842 |       expect(chainValidation.noMissingEntries).toBe(true);
      843 |       expect(chainValidation.hashChainValid).toBe(true);

      at Object.toBe (tests/validation/p4-console-rbac-validation.test.js:840:37)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide aggregated KPI data without detailed breakdowns

    expected 200 "OK", got 403 "Forbidden"

      872 |           includeBreakdowns: false // Explicit no drill-down
      873 |         })
    > 874 |         .expect(200);
          |          ^
      875 |
      876 |       // Verify aggregated data structure
      877 |       expect(kpiResponse.body.data).toEqual(expect.objectContaining({

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:874:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should prevent access to individual case data through KPI endpoints

    expected 403 "Forbidden", got 200 "OK"

      940 |             drillDown: 'case_level'
      941 |           })
    > 942 |           .expect(403);
          |            ^
      943 |
      944 |         expect(detailResponse.body).toEqual(expect.objectContaining({
      945 |           error: 'kpi_drill_down_denied',

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:942:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should provide role-appropriate KPI views

    expect(received).toContain(expected) // indexOf

    Expected value: "total_cases"
    Received array: ["allowedMetrics", "dashboardConfig", "data"]

       998 |         const returnedKPIs = Object.keys(kpiResponse.body.data);
       999 |         for (const expectedKPI of test.expectedKPIs) {
    > 1000 |           expect(returnedKPIs).toContain(expectedKPI);
           |                                ^
      1001 |         }
      1002 |
      1003 |         // Verify appropriate detail level

      at Object.toContain (tests/validation/p4-console-rbac-validation.test.js:1000:32)

  ● P4 承辦Console Production Validation › KPI Aggregation without Drill-down › should anonymize and aggregate temporal KPI data

    expected 200 "OK", got 403 "Forbidden"

      1024 |           anonymized: true
      1025 |         })
    > 1026 |         .expect(200);
           |          ^
      1027 |
      1028 |       const temporalData = temporalKPIResponse.body.data;
      1029 |

      at Object.expect (tests/validation/p4-console-rbac-validation.test.js:1026:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/mobile/tests/services/MyDataIntegrationService.test.js
  ● MyDataIntegrationService - GREEN Phase Tests › OAuth Authorization Flow › Token Exchange › should handle token exchange errors

    Token exchange failed

      160 |             userMessage: '授權驗證失敗，請重新授權'
      161 |           };
    > 162 |           throw new Error('Token exchange failed');
          |                 ^
      163 |         });
      164 |
      165 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:162:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:167:25)

  ● MyDataIntegrationService - GREEN Phase Tests › OAuth Authorization Flow › Token Exchange › should store access token securely and temporarily

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      180 |         const expiresIn = 3600; // 1 hour
      181 |
    > 182 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      183 |
      184 |         // Act
      185 |         const result = await myDataService.storeAccessTokenSecurely(accessToken, expiresIn);

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:182:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Consent Management › Consent Recording › should provide user-readable consent summary

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 0

    @@ -1,10 +1,9 @@
      Object {
        "contact": "新竹市政府資訊處",
        "dataTypes": Array [
          "基本資料",
    -     "緊急聯絡人",
        ],
        "purpose": "新竹市安心守護服務",
        "retention": "最長保存 30 天",
        "rights": Array [
          "您可隨時撤回同意",

      326 |
      327 |         // Assert
    > 328 |         expect(summary).toEqual({
          |                         ^
      329 |           title: '資料使用同意書',
      330 |           purpose: '新竹市安心守護服務',
      331 |           dataTypes: ['基本資料', '緊急聯絡人'],

      at Object.toEqual (src/mobile/tests/services/MyDataIntegrationService.test.js:328:25)

  ● MyDataIntegrationService - GREEN Phase Tests › Consent Management › Consent Revocation › should delete all associated data on consent revocation

    TypeError: Cannot read properties of undefined (reading 'getInternetCredentials')

      400 |         const userId = 'user-123';
      401 |         AsyncStorage.getItem.mockResolvedValue('{"name":"王小明","phone":"0912345678"}');
    > 402 |         Keychain.getInternetCredentials.mockResolvedValue({
          |                  ^
      403 |           username: 'hsinchu_guardian',
      404 |           password: 'access_token_123'
      405 |         });

      at Object.getInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:402:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Security and Privacy › Token Security › should implement secure token storage with biometric protection

    TypeError: Cannot read properties of undefined (reading 'setInternetCredentials')

      551 |         const sensitiveToken = 'highly_sensitive_access_token_12345';
      552 |
    > 553 |         Keychain.setInternetCredentials.mockResolvedValue(true);
          |                  ^
      554 |         Keychain.SECURITY_LEVEL = {
      555 |           SECURE_HARDWARE: 'SECURE_HARDWARE'
      556 |         };

      at Object.setInternetCredentials (src/mobile/tests/services/MyDataIntegrationService.test.js:553:18)

  ● MyDataIntegrationService - GREEN Phase Tests › Security and Privacy › Data Encryption › should encrypt all stored personal data

    SyntaxError: Bad escaped character in JSON at position 12 (line 1 column 13)
        at JSON.parse (<anonymous>)

      392 |     const hex = encrypted.match(/.{2}/g).map(h => String.fromCharCode(parseInt(h, 16))).join('');
      393 |     const data = hex.split('_encrypted_with_')[0];
    > 394 |     return JSON.parse(data);
          |                 ^
      395 |   }
      396 |
      397 |   getUserEncryptionKey(userId) {

      at MyDataIntegrationService.parse [as decryptPersonalData] (src/mobile/src/services/MyDataIntegrationService.js:394:17)
      at Object.decryptPersonalData (src/mobile/tests/services/MyDataIntegrationService.test.js:600:47)

  ● MyDataIntegrationService - GREEN Phase Tests › Error Handling and Edge Cases › OAuth Flow Errors › should handle network failures during OAuth

    Network request failed

      639 |             canRetry: true
      640 |           };
    > 641 |           throw new Error('Network request failed');
          |                 ^
      642 |         });
      643 |
      644 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:641:17)
      at Object.exchangeCodeForToken (src/mobile/tests/services/MyDataIntegrationService.test.js:646:25)

  ● MyDataIntegrationService - GREEN Phase Tests › Error Handling and Edge Cases › Data Processing Errors › should handle API rate limiting gracefully

    Rate limit exceeded

      690 |             userMessage: '請求過於頻繁，請稍後再試'
      691 |           };
    > 692 |           throw new Error('Rate limit exceeded');
          |                 ^
      693 |         });
      694 |
      695 |         // Act & Assert

      at MyDataIntegrationService.<anonymous> (src/mobile/tests/services/MyDataIntegrationService.test.js:692:17)
      at Object.fetchUserProfile (src/mobile/tests/services/MyDataIntegrationService.test.js:697:25)

FAIL src/backend/tests/integration/api.cases.test.js
  ● Case Flow API Endpoints › POST /api/v1/cases/create › should create a new case successfully

    expect(received).toEqual(expected) // deep equality

    - Expected  - 9
    + Received  + 7

      Object {
    -   "data": ObjectContaining {
    -     "alertConfig": Any<Object>,
    +   "data": Object {
          "contactInfo": Object {
            "name": "陳小華",
            "phone": "0912345678",
            "relationship": "女兒",
          },
    -     "createdAt": Any<String>,
    -     "createdBy": Any<String>,
    +     "createdAt": "2025-09-18T07:25:16.906Z",
    +     "createdBy": "admin123",
          "description": "78歲陳老先生在大潤發走失",
    -     "id": Any<String>,
    -     "location": ObjectContaining {
    +     "id": "CASE-2025-283",
    +     "location": Object {
            "address": "新竹市東區光復路二段101號",
            "lat": 24.8138,
            "lng": 120.9675,
          },
    -     "metadata": Any<Object>,
          "missingPerson": Object {
            "age": 78,
            "description": "身高約165cm，穿深色衣服",
            "lastSeen": "2023-10-15T14:30:00.000Z",
            "name": "陳老先生",
          },
          "priority": "high",
    -     "status": "active",
    +     "status": "created",
          "title": "失智長者走失案件",
    -     "updatedAt": Any<String>,
    +     "updatedAt": "2025-09-18T07:25:16.906Z",
        },
        "message": "Case created successfully",
        "success": true,
      }

      52 |         .expect(201);
      53 |
    > 54 |       expect(response.body).toEqual({
         |                             ^
      55 |         success: true,
      56 |         message: 'Case created successfully',
      57 |         data: expect.objectContaining({

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:54:29)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should return case details for authorized user

    expected 200 "OK", got 404 "Not Found"

      110 |         .get('/api/v1/cases/case123')
      111 |         .set('Authorization', 'Bearer family-member-token')
    > 112 |         .expect(200);
          |          ^
      113 |
      114 |       expect(response.body).toEqual({
      115 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:112:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/:id › should enforce access control based on case ownership

    expected 403 "Forbidden", got 404 "Not Found"

      136 |         .get('/api/v1/cases/case123')
      137 |         .set('Authorization', 'Bearer unauthorized-user-token')
    > 138 |         .expect(403);
          |          ^
      139 |     });
      140 |   });
      141 |

      at Object.expect (src/backend/tests/integration/api.cases.test.js:138:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › PUT /api/v1/cases/:id/status › should update case status successfully

    expected 200 "OK", got 404 "Not Found"

      153 |         .set('Authorization', 'Bearer volunteer-token')
      154 |         .send(statusUpdate)
    > 155 |         .expect(200);
          |          ^
      156 |
      157 |       expect(response.body).toEqual({
      158 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:155:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › GET /api/v1/cases/search › should search cases with filters

    expect(received).toEqual(expected) // deep equality

    - Expected  -  7
    + Received  + 46

      Object {
    -   "data": Object {
    -     "cases": Any<Array>,
    -     "filters": Any<Object>,
    -     "pagination": ObjectContaining {
    -       "limit": Any<Number>,
    -       "page": Any<Number>,
    -       "total": Any<Number>,
    +   "data": Array [
    +     Object {
    +       "assignedVolunteers": Array [
    +         "volunteer-001",
    +         "volunteer-002",
    +       ],
    +       "assignedWorker": "case-worker-001",
    +       "createdAt": "2025-09-18T07:25:16.589Z",
    +       "createdBy": "case-worker-001",
    +       "familyMember": "family-member-005",
    +       "id": "CASE-2025-001",
    +       "locationData": Array [
    +         Object {
    +           "lat": 24.8067,
    +           "lng": 120.9687,
    +           "timestamp": "2025-09-18T07:25:16.589Z",
    +         },
    +       ],
    +       "personalData": Object {
    +         "address": "新竹市東區○○路123號",
    +         "age": 78,
    +         "emergencyContacts": Array [
    +           "0912-345-678",
    +           "0987-654-321",
    +         ],
    +         "medicalHistory": "阿茲海默症第二期",
    +         "patientName": "王○○",
    +       },
    +       "priority": "high",
    +       "sensitivityLevel": "confidential",
    +       "status": "active",
    +       "title": "失智長者走失案件",
    +       "workflow": Object {
    +         "currentStage": "建立",
    +         "nextStages": Array [
    +           "派遣",
    +         ],
    +         "stageHistory": Array [
    +           Object {
    +             "performer": "case-worker-001",
    +             "stage": "建立",
    +             "timestamp": "2025-09-18T07:25:16.589Z",
    +             "validationsPassed": true,
                },
    +         ],
            },
    +     },
    +   ],
        "success": true,
      }

      200 |         .expect(200);
      201 |
    > 202 |       expect(response.body).toEqual({
          |                             ^
      203 |         success: true,
      204 |         data: {
      205 |           cases: expect.any(Array),

      at Object.toEqual (src/backend/tests/integration/api.cases.test.js:202:29)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should assign case to volunteer successfully

    expected 200 "OK", got 404 "Not Found"

      250 |         .set('Authorization', 'Bearer case-manager-token')
      251 |         .send(assignmentData)
    > 252 |         .expect(200);
          |          ^
      253 |
      254 |       expect(response.body).toEqual({
      255 |         success: true,

      at Object.expect (src/backend/tests/integration/api.cases.test.js:252:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)

  ● Case Flow API Endpoints › POST /api/v1/cases/:id/assign › should check volunteer availability

    expected 409 "Conflict", got 404 "Not Found"

      283 |           assigneeType: 'volunteer'
      284 |         })
    > 285 |         .expect(409);
          |          ^
      286 |     });
      287 |
      288 |     it('should require case management permissions', async () => {

      at Object.expect (src/backend/tests/integration/api.cases.test.js:285:10)
      ----
      at Test._assertStatus (src/backend/node_modules/supertest/lib/test.js:252:14)
      at src/backend/node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (src/backend/node_modules/supertest/lib/test.js:285:13)
      at Test.assert (src/backend/node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (src/backend/node_modules/supertest/lib/test.js:120:14)


Test Suites: 10 failed, 47 passed, 57 total
Tests:       65 failed, 1318 passed, 1383 total
Snapshots:   0 total
Time:        55.822 s, estimated 66 s
Ran all test suites in 3 projects.
